!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("node-fetch"),require("form-data")):"function"==typeof define&&define.amd?define(["node-fetch","form-data"],t):"object"==typeof exports?exports.ConnectyCube=t(require("node-fetch"),require("form-data")):e.ConnectyCube=t(e["node-fetch"],e["form-data"])}(window,(function(e,t){return function(e){var t={};function n(r){if(t[r])return t[r].exports;var i=t[r]={i:r,l:!1,exports:{}};return e[r].call(i.exports,i,i.exports,n),i.l=!0,i.exports}return n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)n.d(r,i,function(t){return e[t]}.bind(null,i));return r},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=29)}([function(e,t,n){(function(t,r){function i(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function o(e){return(o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}var s=n(1),a="undefined"!=typeof document,c="undefined"!=typeof navigator&&"ReactNative"==navigator.product,u="object"===(void 0===t?"undefined":o(t))&&(void 0!==t.android||void 0!==t.NSObject),l=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var l,f,h;return l=e,h=[{key:"getEnv",value:function(){return{nativescript:u,reactnative:c,browser:a,node:!a&&!u&&!c}}},{key:"isWebRTCAvailble",value:function(){return c||a&&window.RTCPeerConnection&&window.RTCIceCandidate&&window.RTCSessionDescription}},{key:"safeCallbackCall",value:function(){var e=arguments[0];if("function"==typeof e){for(var t,n=e.toString(),r=n.split("(")[0].split(" ")[1],i=[],o=0;o<arguments.length;o++)i.push(arguments[o]);t=i.shift();try{t.apply(null,i)}catch(e){""===r?console.error("Error: "+e):console.error("Error in listener "+r+": "+e)}}}},{key:"randomNonce",value:function(){return Math.floor(1e4*Math.random())}},{key:"unixTime",value:function(){return Math.floor(Date.now()/1e3)}},{key:"getUrl",value:function(e,t,n){var r="".concat(t?"/"+t:"");return n="".concat(n?"/"+n:""),"https://".concat(s.endpoints.api,"/").concat(e).concat(r).concat(n).concat(s.urls.type)}},{key:"isArray",value:function(e){return"[object Array]"===Object.prototype.toString.call(e)}},{key:"isObject",value:function(e){return"[object Object]"===Object.prototype.toString.call(e)}},{key:"getBsonObjectId",value:function(){var e=this.unixTime().toString(16),t=(d.increment++).toString(16);return t>16777215&&(d.increment=0),"00000000".substr(0,8-e.length)+e+"000000".substr(0,6-d.machine.length)+d.machine+"0000".substr(0,4-d.pid.length)+d.pid+"000000".substr(0,6-t.length)+t}},{key:"DLog",value:function(){if(this.loggers)for(var e=0;e<this.loggers.length;++e)this.loggers[e](arguments);else{var t;this.loggers=[];var n=function(){return function(e){console.log.apply(console,Array.prototype.slice.call(e))}};if("object"===o(s.debug)&&("number"==typeof s.debug.mode?1==s.debug.mode&&(t=n(),this.loggers.push(t)):"object"===o(s.debug.mode)&&s.debug.mode.forEach((function(e){1===e&&(t=n(),this.loggers.push(t))}))),this.loggers)for(var r=0;r<this.loggers.length;++r)this.loggers[r](arguments)}}},{key:"isExpiredSessionError",value:function(e){try{return e&&401===e.code&&"Required session does not exist"===e.message.errors.base[0]}catch(e){return!1}}},{key:"mergeArrays",value:function(e,t){var n=JSON.parse(JSON.stringify(e));e:for(var r=0;r<t.length;r++){for(var i=t[r],o=0;o<n.length;o++)if(i.user_id===n[o].user_id){n[o]=i;continue e}n.push(i)}return n}},{key:"toBase64",value:function(e){return this.getEnv().browser?btoa(encodeURIComponent(e).replace(/%([0-9A-F]{2})/g,(function(e,t){return String.fromCharCode("0x"+t)}))):this.getEnv().reactnative?t.btoa(e):new r(e).toString("base64")}},{key:"generateCreateSessionParams",value:function(e){var t={application_id:s.creds.appId,auth_key:s.creds.authKey,nonce:this.randomNonce(),timestamp:this.unixTime()};return e&&(e.login&&e.password?t.user={login:e.login,password:e.password}:e.email&&e.password?t.user={email:e.email,password:e.password}:e.provider?(t.provider=e.provider,e.scope&&(t.scope=e.scope),e.keys&&e.keys.token&&(t.keys={token:e.keys.token}),e.keys&&e.keys.secret&&(t.keys.secret=e.keys.secret)):e.hasOwnProperty("long")&&(t.long=e.long)),t}},{key:"signParams",value:function(e,t){var r,i=Object.keys(e).map((function(t){return"object"===o(e[t])?Object.keys(e[t]).map((function(n){return t+"["+n+"]="+e[t][n]})).sort().join("&"):t+"="+e[t]})).sort().join("&");if("sha1"===s.hash)r=n(36)(i,t).toString();else{if("sha256"!==s.hash)throw new Error("Unknown crypto standards, available sha1 or sha256");r=n(38)(i,t).toString()}return r}},{key:"getSizeOfString",value:function(e){return new Blob([e]).size}},{key:"getDateSize",value:function(e){var t=0;if(e.body){var n=e.body;"string"!=typeof n&&(n=JSON.stringify(n)),t+=this.getSizeOfString(n)}return e.headers&&(t+=this.getSizeOfString(JSON.stringify(e.headers))),t}},{key:"callTrafficUsageCallback",value:function(e,t){"function"==typeof s.on[e]&&s.on[e](this.getDateSize(t))}}],(f=null)&&i(l.prototype,f),h&&i(l,h),e}(),d={machine:Math.floor(16777216*Math.random()).toString(16),pid:Math.floor(32767*Math.random()).toString(16),increment:0};e.exports=l}).call(this,n(7),n(32).Buffer)},function(e,t,n){function r(e){return(r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}var i={version:n(30).version,creds:{appId:"",authKey:"",authSecret:""},endpoints:{api:"api.connectycube.com",chat:"chat.connectycube.com",muc:"muc.chat.connectycube.com"},hash:"sha1",chatProtocol:{bosh:"https://chat.connectycube.com:5281",websocket:"wss://chat.connectycube.com:5291",active:2},webSession:{getSessionTimeInterval:3,getSessionTimeout:120},chat:{contactList:{subscriptionMode:{mutual:!0}},reconnectionTimeInterval:5,streamManagement:{enable:!1}},videochat:{answerTimeInterval:60,dialingTimeInterval:5,disconnectTimeInterval:30,statsReportTimeInterval:!1,iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:turn.connectycube.com"},{urls:"turn:turn.connectycube.com:5349?transport=udp",username:"connectycube",credential:"4c29501ca9207b7fb9c4b4b6b04faeb1"},{urls:"turn:turn.connectycube.com:5349?transport=tcp",username:"connectycube",credential:"4c29501ca9207b7fb9c4b4b6b04faeb1"}]},urls:{session:"session",webSession:"session/web",login:"login",users:"users",chat:"chat",blobs:"blobs",subscriptions:"subscriptions",events:"events",data:"data",addressbook:"address_book",addressbookRegistered:"address_book/registered_users",type:".json"},on:{sessionExpired:null,xmppDataWrite:null,xmppDataRead:null},timeout:null,debug:{mode:0},set:function(e){"object"===r(e.endpoints)&&e.endpoints.chat&&(i.endpoints.muc="muc."+e.endpoints.chat,i.chatProtocol.bosh="https://"+e.endpoints.chat+":5281",i.chatProtocol.websocket="wss://"+e.endpoints.chat+":5291"),Object.keys(e).forEach((function(t){"set"!==t&&i.hasOwnProperty(t)&&("object"!==r(e[t])?i[t]=e[t]:Object.keys(e[t]).forEach((function(n){i[t].hasOwnProperty(n)&&(i[t][n]=e[t][n])})))}))}};e.exports=i},function(e,t,n){var r,i,o,s,a,c,u,l=n(0),d=n(40);l.getEnv().browser?(r=fetch,i=FormData,o=window.RTCPeerConnection,s=window.RTCSessionDescription,a=window.RTCIceCandidate,c=window.MediaStream,u=navigator.mediaDevices):l.getEnv().nativescript?(r=fetch,i=FormData):l.getEnv().node?(r=n(25),i=n(91)):l.getEnv().reactnative&&(r=fetch,i=FormData),e.exports={fetchImpl:r,formDataImpl:i,XMPPClient:d,RTCPeerConnection:o,RTCSessionDescription:s,RTCIceCandidate:a,MediaStream:c,mediaDevices:u}},function(e,t,n){"use strict";const r=n(47),i=n(14),o=n(22),{escapeXML:s,unescapeXML:a,escapeXMLText:c,unescapeXMLText:u}=n(15),l=n(23);t=e.exports=function(...e){return r(...e)},Object.assign(t,{x:r,Element:i,Parser:o,escapeXML:s,unescapeXML:a,escapeXMLText:c,unescapeXMLText:u,XMLError:l})},function(e,t){e.exports={SignalingConstants:{MODULE_ID:"WebRTCVideoChat",SignalingType:{CALL:"call",ACCEPT:"accept",REJECT:"reject",STOP:"hangUp",CANDIDATE:"iceCandidates"}},SessionConnectionState:{UNDEFINED:0,CONNECTING:1,CONNECTED:2,FAILED:3,DISCONNECTED:4,CLOSED:5,COMPLETED:6},SessionState:{NEW:1,ACTIVE:2,HUNGUP:3,REJECTED:4,CLOSED:5},PeerConnectionState:{NEW:1,CONNECTING:2,CHECKING:3,CONNECTED:4,DISCONNECTED:5,FAILED:6,CLOSED:7,COMPLETED:8},CallType:{VIDEO:1,AUDIO:2}}},function(e,t,n){function r(e){return(r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function i(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}n(0);var o=n(1),s=n(2).XMPPClient,a=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,n,a;return t=e,a=[{key:"buildUserJid",value:function(e){var t;return"userId"in e?(t=e.userId+"-"+o.creds.appId+"@"+o.endpoints.chat,"resource"in e&&(t=t+"/"+e.resource)):"jid"in e&&(t=e.jid),t}},{key:"buildUserJidLocalPart",value:function(e){return e+"-"+o.creds.appId}},{key:"createMessageStanza",value:function(e){return s.xml("message",e)}},{key:"createIqStanza",value:function(e){return s.xml("iq",e)}},{key:"createPresenceStanza",value:function(e){return s.xml("presence",e)}},{key:"createNonza",value:function(e,t){return s.xml(e,t)}},{key:"getAttr",value:function(e,t){return e?("function"==typeof e.getAttribute?n=e.getAttribute(t):e.attrs&&(n=e.attrs[t]),n):null;var n}},{key:"getElement",value:function(e,t){var n;return"function"==typeof e.querySelector?n=e.querySelector(t):"function"==typeof e.getChild&&(n=e.getChild(t)),n}},{key:"isErrorStanza",value:function(e){return!!e.getChild("error")}},{key:"getAllElements",value:function(e,t){var n;return"function"==typeof e.querySelectorAll?n=e.querySelectorAll(t):"function"==typeof e.getChild&&(n=e.getChild(t)),n}},{key:"getElementText",value:function(e,t){var n,r;return"function"==typeof e.querySelector?r=(n=e.querySelector(t))?n.textContent:null:"function"==typeof e.getChildText&&(r=e.getChildText(t)),r}},{key:"getElementTreePath",value:function(e,t){var n=this;return t.reduce((function(e,t){return e?n.getElement(e,t):e}),e)}},{key:"_JStoXML",value:function(e,t,n){var i=this;n=n.c(e),Object.keys(t).forEach((function(e){"object"===r(t[e])?i._JStoXML(e,t[e],n):n=n.c(e).t(t[e]).up()})),n=n.up()}},{key:"_XMLtoJS",value:function(e,t,n){e[t]={};for(var r=n.childNodes||n.children,i=0;i<r.length;i++){var o=r[i],s=o.childNodes||o.children,a=o.tagName||o.name,c=o.textContent||o.children[0];s.length>1?e[t]=this._XMLtoJS(e[t],a,o):e[t][a]=c}return e}},{key:"filledExtraParams",value:function(e,t){var n=this;return Object.keys(t).forEach((function(i){"attachments"===i?t[i].forEach((function(t){e.getChild("extraParams").c("attachment",t).up()})):"object"===r(t[i])?n._JStoXML(i,t[i],e):e.getChild("extraParams").c(i).t(t[i]).up()})),e.up(),e}},{key:"parseExtraParams",value:function(e){if(!e)return null;for(var t,n,r,i={},o=[],s=0,a=e.children.length;s<a;s++){if("attachment"===e.children[s].name){n={},r=e.children[s].attrs;for(var c=Object.keys(r),u=0;u<c.length;u++)"size"===c[u]?n.size=parseInt(r.size):n[c[u]]=r[c[u]];o.push(n)}else"dialog_id"===e.children[s].name&&(t=e.getChildText("dialog_id"),i.dialog_id=t);if(1===e.children[s].children.length){var l=e.children[s];i[l.name]=l.children[0]}}return o.length>0&&(i.attachments=o),i.moduleIdentifier&&delete i.moduleIdentifier,{extension:i,dialogId:t}}},{key:"buildErrorFromXMPPErrorStanza",value:function(e){var t=this.getElement(e,"error");return{code:parseInt(this.getAttr(t,"code")),info:this.getElementText(t,"text")}}},{key:"getUniqueId",value:function(e){var t="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)}));return"string"==typeof e||"number"==typeof e?t+":"+e:t+""}}],(n=null)&&i(t.prototype,n),a&&i(t,a),e}();e.exports=a},function(e,t){e.exports=function(e){return e.webpackPolyfill||(e.deprecate=function(){},e.paths=[],e.children||(e.children=[]),Object.defineProperty(e,"loaded",{enumerable:!0,get:function(){return e.l}}),Object.defineProperty(e,"id",{enumerable:!0,get:function(){return e.i}}),e.webpackPolyfill=1),e}},function(e,t){var n;n=function(){return this}();try{n=n||new Function("return this")()}catch(e){"object"==typeof window&&(n=window)}e.exports=n},function(e,t,n){var r;e.exports=(r=r||function(e,t){var n=Object.create||function(){function e(){}return function(t){var n;return e.prototype=t,n=new e,e.prototype=null,n}}(),r={},i=r.lib={},o=i.Base={extend:function(e){var t=n(this);return e&&t.mixIn(e),t.hasOwnProperty("init")&&this.init!==t.init||(t.init=function(){t.$super.init.apply(this,arguments)}),t.init.prototype=t,t.$super=this,t},create:function(){var e=this.extend();return e.init.apply(e,arguments),e},init:function(){},mixIn:function(e){for(var t in e)e.hasOwnProperty(t)&&(this[t]=e[t]);e.hasOwnProperty("toString")&&(this.toString=e.toString)},clone:function(){return this.init.prototype.extend(this)}},s=i.WordArray=o.extend({init:function(e,t){e=this.words=e||[],this.sigBytes=null!=t?t:4*e.length},toString:function(e){return(e||c).stringify(this)},concat:function(e){var t=this.words,n=e.words,r=this.sigBytes,i=e.sigBytes;if(this.clamp(),r%4)for(var o=0;o<i;o++){var s=n[o>>>2]>>>24-o%4*8&255;t[r+o>>>2]|=s<<24-(r+o)%4*8}else for(o=0;o<i;o+=4)t[r+o>>>2]=n[o>>>2];return this.sigBytes+=i,this},clamp:function(){var t=this.words,n=this.sigBytes;t[n>>>2]&=4294967295<<32-n%4*8,t.length=e.ceil(n/4)},clone:function(){var e=o.clone.call(this);return e.words=this.words.slice(0),e},random:function(t){for(var n,r=[],i=function(t){t=t;var n=987654321,r=4294967295;return function(){var i=((n=36969*(65535&n)+(n>>16)&r)<<16)+(t=18e3*(65535&t)+(t>>16)&r)&r;return i/=4294967296,(i+=.5)*(e.random()>.5?1:-1)}},o=0;o<t;o+=4){var a=i(4294967296*(n||e.random()));n=987654071*a(),r.push(4294967296*a()|0)}return new s.init(r,t)}}),a=r.enc={},c=a.Hex={stringify:function(e){for(var t=e.words,n=e.sigBytes,r=[],i=0;i<n;i++){var o=t[i>>>2]>>>24-i%4*8&255;r.push((o>>>4).toString(16)),r.push((15&o).toString(16))}return r.join("")},parse:function(e){for(var t=e.length,n=[],r=0;r<t;r+=2)n[r>>>3]|=parseInt(e.substr(r,2),16)<<24-r%8*4;return new s.init(n,t/2)}},u=a.Latin1={stringify:function(e){for(var t=e.words,n=e.sigBytes,r=[],i=0;i<n;i++){var o=t[i>>>2]>>>24-i%4*8&255;r.push(String.fromCharCode(o))}return r.join("")},parse:function(e){for(var t=e.length,n=[],r=0;r<t;r++)n[r>>>2]|=(255&e.charCodeAt(r))<<24-r%4*8;return new s.init(n,t)}},l=a.Utf8={stringify:function(e){try{return decodeURIComponent(escape(u.stringify(e)))}catch(e){throw new Error("Malformed UTF-8 data")}},parse:function(e){return u.parse(unescape(encodeURIComponent(e)))}},d=i.BufferedBlockAlgorithm=o.extend({reset:function(){this._data=new s.init,this._nDataBytes=0},_append:function(e){"string"==typeof e&&(e=l.parse(e)),this._data.concat(e),this._nDataBytes+=e.sigBytes},_process:function(t){var n=this._data,r=n.words,i=n.sigBytes,o=this.blockSize,a=i/(4*o),c=(a=t?e.ceil(a):e.max((0|a)-this._minBufferSize,0))*o,u=e.min(4*c,i);if(c){for(var l=0;l<c;l+=o)this._doProcessBlock(r,l);var d=r.splice(0,c);n.sigBytes-=u}return new s.init(d,u)},clone:function(){var e=o.clone.call(this);return e._data=this._data.clone(),e},_minBufferSize:0}),f=(i.Hasher=d.extend({cfg:o.extend(),init:function(e){this.cfg=this.cfg.extend(e),this.reset()},reset:function(){d.reset.call(this),this._doReset()},update:function(e){return this._append(e),this._process(),this},finalize:function(e){return e&&this._append(e),this._doFinalize()},blockSize:16,_createHelper:function(e){return function(t,n){return new e.init(n).finalize(t)}},_createHmacHelper:function(e){return function(t,n){return new f.HMAC.init(e,n).finalize(t)}}}),r.algo={});return r}(Math),r)},function(e,t,n){"use strict";const r=n(43),i=n(19),o=n(13),s=n(44),a=n(10),c=n(45);t.EventEmitter=a,t.timeout=r,t.delay=i,t.TimeoutError=o,t.promise=s,t.Deferred=c},function(e,t,n){"use strict";var r,i="object"==typeof Reflect?Reflect:null,o=i&&"function"==typeof i.apply?i.apply:function(e,t,n){return Function.prototype.apply.call(e,t,n)};r=i&&"function"==typeof i.ownKeys?i.ownKeys:Object.getOwnPropertySymbols?function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:function(e){return Object.getOwnPropertyNames(e)};var s=Number.isNaN||function(e){return e!=e};function a(){a.init.call(this)}e.exports=a,a.EventEmitter=a,a.prototype._events=void 0,a.prototype._eventsCount=0,a.prototype._maxListeners=void 0;var c=10;function u(e){return void 0===e._maxListeners?a.defaultMaxListeners:e._maxListeners}function l(e,t,n,r){var i,o,s,a;if("function"!=typeof n)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof n);if(void 0===(o=e._events)?(o=e._events=Object.create(null),e._eventsCount=0):(void 0!==o.newListener&&(e.emit("newListener",t,n.listener?n.listener:n),o=e._events),s=o[t]),void 0===s)s=o[t]=n,++e._eventsCount;else if("function"==typeof s?s=o[t]=r?[n,s]:[s,n]:r?s.unshift(n):s.push(n),(i=u(e))>0&&s.length>i&&!s.warned){s.warned=!0;var c=new Error("Possible EventEmitter memory leak detected. "+s.length+" "+String(t)+" listeners added. Use emitter.setMaxListeners() to increase limit");c.name="MaxListenersExceededWarning",c.emitter=e,c.type=t,c.count=s.length,a=c,console&&console.warn&&console.warn(a)}return e}function d(){for(var e=[],t=0;t<arguments.length;t++)e.push(arguments[t]);this.fired||(this.target.removeListener(this.type,this.wrapFn),this.fired=!0,o(this.listener,this.target,e))}function f(e,t,n){var r={fired:!1,wrapFn:void 0,target:e,type:t,listener:n},i=d.bind(r);return i.listener=n,r.wrapFn=i,i}function h(e,t,n){var r=e._events;if(void 0===r)return[];var i=r[t];return void 0===i?[]:"function"==typeof i?n?[i.listener||i]:[i]:n?function(e){for(var t=new Array(e.length),n=0;n<t.length;++n)t[n]=e[n].listener||e[n];return t}(i):m(i,i.length)}function p(e){var t=this._events;if(void 0!==t){var n=t[e];if("function"==typeof n)return 1;if(void 0!==n)return n.length}return 0}function m(e,t){for(var n=new Array(t),r=0;r<t;++r)n[r]=e[r];return n}Object.defineProperty(a,"defaultMaxListeners",{enumerable:!0,get:function(){return c},set:function(e){if("number"!=typeof e||e<0||s(e))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+e+".");c=e}}),a.init=function(){void 0!==this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},a.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||s(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this},a.prototype.getMaxListeners=function(){return u(this)},a.prototype.emit=function(e){for(var t=[],n=1;n<arguments.length;n++)t.push(arguments[n]);var r="error"===e,i=this._events;if(void 0!==i)r=r&&void 0===i.error;else if(!r)return!1;if(r){var s;if(t.length>0&&(s=t[0]),s instanceof Error)throw s;var a=new Error("Unhandled error."+(s?" ("+s.message+")":""));throw a.context=s,a}var c=i[e];if(void 0===c)return!1;if("function"==typeof c)o(c,this,t);else{var u=c.length,l=m(c,u);for(n=0;n<u;++n)o(l[n],this,t)}return!0},a.prototype.addListener=function(e,t){return l(this,e,t,!1)},a.prototype.on=a.prototype.addListener,a.prototype.prependListener=function(e,t){return l(this,e,t,!0)},a.prototype.once=function(e,t){if("function"!=typeof t)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof t);return this.on(e,f(this,e,t)),this},a.prototype.prependOnceListener=function(e,t){if("function"!=typeof t)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof t);return this.prependListener(e,f(this,e,t)),this},a.prototype.removeListener=function(e,t){var n,r,i,o,s;if("function"!=typeof t)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof t);if(void 0===(r=this._events))return this;if(void 0===(n=r[e]))return this;if(n===t||n.listener===t)0==--this._eventsCount?this._events=Object.create(null):(delete r[e],r.removeListener&&this.emit("removeListener",e,n.listener||t));else if("function"!=typeof n){for(i=-1,o=n.length-1;o>=0;o--)if(n[o]===t||n[o].listener===t){s=n[o].listener,i=o;break}if(i<0)return this;0===i?n.shift():function(e,t){for(;t+1<e.length;t++)e[t]=e[t+1];e.pop()}(n,i),1===n.length&&(r[e]=n[0]),void 0!==r.removeListener&&this.emit("removeListener",e,s||t)}return this},a.prototype.off=a.prototype.removeListener,a.prototype.removeAllListeners=function(e){var t,n,r;if(void 0===(n=this._events))return this;if(void 0===n.removeListener)return 0===arguments.length?(this._events=Object.create(null),this._eventsCount=0):void 0!==n[e]&&(0==--this._eventsCount?this._events=Object.create(null):delete n[e]),this;if(0===arguments.length){var i,o=Object.keys(n);for(r=0;r<o.length;++r)"removeListener"!==(i=o[r])&&this.removeAllListeners(i);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if("function"==typeof(t=n[e]))this.removeListener(e,t);else if(void 0!==t)for(r=t.length-1;r>=0;r--)this.removeListener(e,t[r]);return this},a.prototype.listeners=function(e){return h(this,e,!0)},a.prototype.rawListeners=function(e){return h(this,e,!1)},a.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):p.call(e,t)},a.prototype.listenerCount=p,a.prototype.eventNames=function(){return this._eventsCount>0?r(this._events):[]}},function(e,t,n){"use strict";const r=n(20),i=n(21),o=n(46);function s(...e){return e[1]||e[2]?new r(...e):o(...e)}(t=e.exports=s.bind()).jid=s,t.JID=r,t.equal=function(e,t){return e.equals(t)},t.detectEscape=i.detect,t.escapeLocal=i.escape,t.unescapeLocal=i.unescape,t.parse=o},function(e,t,n){function r(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var i=n(1),o=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,n,o;return t=e,o=[{key:"getUserJid",value:function(e,t){return e+"-"+t+"@"+i.endpoints.chat}},{key:"getUserIdFromJID",value:function(e){return e.indexOf("@")<0?null:parseInt(e.split("@")[0].split("-")[0])}},{key:"userCurrentJid",value:function(e){return e.jid._local+"@"+e.jid._domain+"/"+e.jid._resource}},{key:"trace",value:function(e){i.debug&&console.log("[VideoChat]:",e)}},{key:"traceWarning",value:function(e){i.debug&&console.warn("[VideoChat]:",e)}},{key:"traceError",value:function(e){i.debug&&console.error("[VideoChat]:",e)}},{key:"getVersionFirefox",value:function(){var e,t=!!navigator&&navigator.userAgent;if(t){var n=t.match(/(?:firefox)[ \/](\d+)/i)||[];e=n[1]?+n[1]:null}return e}},{key:"getVersionSafari",value:function(){var e,t=!!navigator&&navigator.userAgent;if(t)if((t.match(/(?:safari)[ \/](\d+)/i)||[]).length){var n=t.match(/(?:version)[ \/](\d+)/i)||[];e=n&&n[1]?+n[1]:null}else e=null;return e}}],(n=null)&&r(t.prototype,n),o&&r(t,o),e}();e.exports=o},function(e,t,n){"use strict";e.exports=class extends Error{constructor(e){super(e),this.name="TimeoutError"}}},function(e,t,n){"use strict";const r=n(48);e.exports=class extends r{setAttrs(e){"string"==typeof e?this.attrs.xmlns=e:e&&Object.keys(e).forEach((function(t){if("__source"===t||"__self"===t)return;const n=e[t];null!=n&&(this.attrs[t.toString()]=n.toString())}),this)}append(e){return(e=Array.isArray(e)?e:[e]).forEach(e=>{this.children.push(e),"object"==typeof e&&(e.parent=this)}),this}prepend(e){return(e=Array.isArray(e)?e:[e]).forEach(e=>{this.children.unshift(e),"object"==typeof e&&(e.parent=this)}),this}}},function(e,t,n){"use strict";var r={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&apos;"};function i(e){return r[e]}var o={"&amp;":"&","&lt;":"<","&gt;":">","&quot;":'"',"&apos;":"'"};function s(e){if("#"===e[1]){var t;if(9===(t="x"===e[2]?parseInt(e.slice(3),16):parseInt(e.slice(2),10))||10===t||13===t||t>=32&&t<=55295||t>=57344&&t<=65533||t>=65536&&t<=1114111)return String.fromCodePoint(t);throw new Error("Illegal XML character 0x"+t.toString(16))}if(o[e])return o[e]||e;throw new Error("Illegal XML entity "+e)}t.escapeXML=function(e){return e.replace(/&|<|>|"|'/g,i)},t.unescapeXML=function(e){for(var t="",n=-1,r=-1,i=0;-1!==(n=e.indexOf("&",i))&&-1!==(r=e.indexOf(";",n+1));)t=t+e.substring(i,n)+s(e.substring(n,r+1)),i=r+1;return 0===i?e:t+=e.substring(i)},t.escapeXMLText=function(e){return e.replace(/&|<|>/g,i)},t.unescapeXMLText=function(e){return e.replace(/&(amp|#38|lt|#60|gt|#62);/g,s)}},function(e,t,n){"use strict";class r extends Error{constructor(e,t,n){super(e+(t?` - ${t}`:"")),this.name="XMPPError",this.condition=e,this.text=t,this.application=n}static fromElement(e){const[t,n,r]=e.children;let i,o;n&&(n.is("text")?i=n:n&&(o=n),r&&(o=r));const s=new this(t.name,i?i.text():"",o);return s.element=e,s}}e.exports=r},function(e,t,n){var r,i,o,s;e.exports=(r=n(8),o=(i=r).lib.Base,s=i.enc.Utf8,void(i.algo.HMAC=o.extend({init:function(e,t){e=this._hasher=new e.init,"string"==typeof t&&(t=s.parse(t));var n=e.blockSize,r=4*n;t.sigBytes>r&&(t=e.finalize(t)),t.clamp();for(var i=this._oKey=t.clone(),o=this._iKey=t.clone(),a=i.words,c=o.words,u=0;u<n;u++)a[u]^=1549556828,c[u]^=909522486;i.sigBytes=o.sigBytes=r,this.reset()},reset:function(){var e=this._hasher;e.reset(),e.update(this._iKey)},update:function(e){return this._hasher.update(e),this},finalize:function(e){var t=this._hasher,n=t.finalize(e);return t.reset(),t.finalize(this._oKey.clone().concat(n))}})))},function(e,t,n){"use strict";const{EventEmitter:r,promise:i}=n(9),o=n(11),s=n(3),a=n(53),{parseHost:c,parseService:u}=n(54);class l extends r{constructor(e={}){super(),this.jid=null,this.timeout=2e3,this.options=e,this.socketListeners=Object.create(null),this.parserListeners=Object.create(null),this.status="offline",this.socket=null,this.parser=null,this.root=null}_reset(){this.jid=null,this.status="offline",this._detachSocket(),this._detachParser()}async _streamError(e,t){try{await this.send(s("stream:error",{},[s(e,{xmlns:"urn:ietf:params:xml:ns:xmpp-streams"},t)]))}catch(e){}return this._end()}_onData(e){const t=e.toString("utf8");this.emit("input",t),this.parser.write(t)}_onParserError(e){this._streamError("bad-format"),this._detachParser(),this.emit("error",e)}_attachSocket(e){const t=this.socket=e,n=this.socketListeners;n.data=this._onData.bind(this),n.close=(e,t)=>{this._reset(),this._status("disconnect",{clean:!e,event:t})},n.connect=()=>{this._status("connect")},n.error=e=>{this.emit("error",e)},t.on("close",n.close),t.on("data",n.data),t.on("error",n.error),t.on("connect",n.connect)}_detachSocket(){const{socketListeners:e,socket:t}=this;return Object.getOwnPropertyNames(e).forEach(n=>{t.removeListener(n,e[n]),delete e[n]}),this.socket=null,t}_onElement(e){this.emit("element",e),this.emit(this.isStanza(e)?"stanza":"nonza",e),"stream:error"===e.name&&this._onStreamError(e)}_onStreamError(e){const t=a.fromElement(e);"see-other-host"===t.condition?this._onSeeOtherHost(t):this.emit("error",t),this._end()}async _onSeeOtherHost(e){const{protocol:t}=u(this.options.service),n=e.element.getChildText("see-other-host"),{port:r}=c(n);let o;o=r?`${t||"xmpp:"}//${n}`:(t?`${t}//`:"")+n;try{await i(this,"disconnect");const{domain:e,lang:t}=this.options;await this.connect(o),await this.open({domain:e,lang:t})}catch(e){this.emit("error",e)}}_attachParser(e){const t=this.parser=e,n=this.parserListeners;n.element=this._onElement.bind(this),n.error=this._onParserError.bind(this),n.end=e=>{this._detachParser(),this._status("close",e)},n.start=e=>{this._status("open",e)},t.on("error",n.error),t.on("element",n.element),t.on("end",n.end),t.on("start",n.start)}_detachParser(){const e=this.parserListeners;Object.getOwnPropertyNames(e).forEach(t=>{this.parser.removeListener(t,e[t]),delete e[t]}),this.parser=null}_jid(e){return this.jid=o(e),this.jid}_status(e,...t){this.status=e,this.emit("status",e,...t),this.emit(e,...t)}async _end(){let e;try{e=await this.close()}catch(e){}try{await this.disconnect()}catch(e){}return e}async start(){if("offline"!==this.status)throw new Error("Connection is not offline");const{service:e,domain:t,lang:n}=this.options;await this.connect(e);const r=i(this,"online");return await this.open({domain:t,lang:n}),r}async connect(e){this._status("connecting",e);const t=new this.Socket;return this._attachSocket(t),t.connect(this.socketParameters(e)),i(t,"connect")}async disconnect(e=this.timeout){this.socket&&this._status("disconnecting"),this.socket.end(),await i(this.socket,"close","error",e)}async open(e){this._status("opening"),"string"==typeof e&&(e={domain:e});const{domain:t,lang:n,timeout:r=this.timeout}=e,o=this.headerElement();return o.attrs.to=t,o.attrs["xml:lang"]=n,this.root=o,this._attachParser(new this.Parser),await this.write(this.header(o)),i(this,"open","error",r)}async stop(){const e=await this._end();return"offline"!==this.status&&this._status("offline",e),e}async close(e=this.timeout){const t=Promise.all([i(this.parser,"end","error",e),this.write(this.footer(this.footerElement()))]);this.parser&&this.socket&&this._status("closing");const[n]=await t;return this.root=null,n}async restart(){this._detachParser();const{domain:e,lang:t}=this.options;return this.open({domain:e,lang:t})}async send(e){e.parent=this.root,this.emit("outgoing",e),await this.write(e),this.emit("send",e)}sendReceive(e,t=this.timeout){return Promise.all([this.send(e),i(this,"element","error",t)]).then(([,e])=>e)}write(e){return new Promise((t,n)=>{if("closing"===this.status)return void n(new Error("Connection is closing"));const r=e.toString("utf8");this.socket.write(r,e=>{if(e)return n(e);this.emit("output",r),t()})})}isStanza(e){const{name:t}=e;return"iq"===t||"message"===t||"presence"===t}isNonza(e){return!this.isStanza(e)}header(e){return e.toString()}headerElement(){return new s.Element("",{version:"1.0",xmlns:this.NS})}footer(e){return e.toString()}footerElement(){}socketParameters(){}}l.prototype.NS="",l.prototype.Socket=null,l.prototype.Parser=null,e.exports=l},function(e,t,n){"use strict";e.exports=function(e){let t;const n=new Promise(n=>{t=setTimeout(n,e)});return n.timeout=t,n}},function(e,t,n){"use strict";const r=n(21);class i{constructor(e,t,n){if("string"!=typeof t||!t)throw new TypeError("Invalid domain.");this.setDomain(t),this.setLocal("string"==typeof e?e:""),this.setResource("string"==typeof n?n:"")}[Symbol.toPrimitive](e){return"number"===e?NaN:this.toString()}toString(e){let t=this._domain;return this._local&&(t=this.getLocal(e)+"@"+t),this._resource&&(t=t+"/"+this._resource),t}bare(){return this._resource?new i(this._local,this._domain,null):this}equals(e){return this._local===e._local&&this._domain===e._domain&&this._resource===e._resource}setLocal(e,t){return(t=t||r.detect(e))&&(e=r.escape(e)),this._local=e&&e.toLowerCase(),this}getLocal(e){let t=null;return t=(e=e||!1)?r.unescape(this._local):this._local,t}setDomain(e){return this._domain=e.toLowerCase(),this}getDomain(){return this._domain}setResource(e){return this._resource=e,this}getResource(){return this._resource}}Object.defineProperty(i.prototype,"local",{get:i.prototype.getLocal,set:i.prototype.setLocal}),Object.defineProperty(i.prototype,"domain",{get:i.prototype.getDomain,set:i.prototype.setDomain}),Object.defineProperty(i.prototype,"resource",{get:i.prototype.getResource,set:i.prototype.setResource}),e.exports=i},function(e,t,n){"use strict";e.exports.detect=function(e){if(!e)return!1;return-1!==e.replace(/\\20/g,"").replace(/\\22/g,"").replace(/\\26/g,"").replace(/\\27/g,"").replace(/\\2f/g,"").replace(/\\3a/g,"").replace(/\\3c/g,"").replace(/\\3e/g,"").replace(/\\40/g,"").replace(/\\5c/g,"").search(/\\| |"|&|'|\/|:|<|>|@/g)},e.exports.escape=function(e){return null===e?null:e.replace(/^\s+|\s+$/g,"").replace(/\\/g,"\\5c").replace(/ /g,"\\20").replace(/"/g,"\\22").replace(/&/g,"\\26").replace(/'/g,"\\27").replace(/\//g,"\\2f").replace(/:/g,"\\3a").replace(/</g,"\\3c").replace(/>/g,"\\3e").replace(/@/g,"\\40").replace(/\3a/g,"c3a")},e.exports.unescape=function(e){return null===e?null:e.replace(/\\20/g," ").replace(/\\22/g,'"').replace(/\\26/g,"&").replace(/\\27/g,"'").replace(/\\2f/g,"/").replace(/\\3a/g,":").replace(/\\3c/g,"<").replace(/\\3e/g,">").replace(/\\40/g,"@").replace(/\\5c/g,"\\")}},function(e,t,n){"use strict";const r=n(51),i=n(14),o=n(10),s=n(23);class a extends o{constructor(){super();const e=new r;this.root=null,this.cursor=null,e.on("startElement",this.onStartElement.bind(this)),e.on("endElement",this.onEndElement.bind(this)),e.on("text",this.onText.bind(this)),this.parser=e}onStartElement(e,t){const n=new i(e,t),{root:r,cursor:o}=this;r?o!==r&&o.append(n):(this.root=n,this.emit("start",n)),this.cursor=n}onEndElement(e){const{root:t,cursor:n}=this;if(e===n.name){if(n!==t)return n.parent?void(this.cursor=n.parent):(n.parent=t,this.emit("element",n),void(this.cursor=t));this.emit("end",t)}else this.emit("error",new s(`${n.name} must be closed.`))}onText(e){const{cursor:t}=this;t?t.t(e):this.emit("error",new s(`${e} must be a child.`))}write(e){this.parser.write(e)}end(e){e&&this.parser.write(e)}}a.XMLError=s,e.exports=a},function(e,t,n){"use strict";e.exports=class extends Error{constructor(...e){super(...e),this.name="XMLError"}}},function(e,t,n){"use strict";e.exports=class{constructor(e,t){this.stanza=t,this.entity=e;const{name:n,attrs:r}=t,{type:i,id:o}=r;this.name=n,this.id=o||"",this.type="message"===n?i||"normal":"presence"===n?i||"available":i||"",this.from=null,this.to=null,this.local="",this.domain="",this.resource=""}}},function(t,n){t.exports=e},function(e,t,n){var r=n(1),i=n(12),o=n(4).SessionConnectionState,s=n(2).RTCPeerConnection,a=n(2).RTCSessionDescription,c=n(2).RTCIceCandidate,u=n(2).MediaStream,l=n(4).PeerConnectionState;function d(e,t,n){if(!n)return e.replace(/b=AS:.*\r\n/,"").replace(/b=TIAS:.*\r\n/,"");for(var r=e.split("\n"),o=-1,s=i.getVersionFirefox()?"TIAS":"AS",a=i.getVersionFirefox()?1024*n:n,c=0;c<r.length;c++)if(0===r[c].indexOf("m="+t)){o=c;break}if(-1===o)return e;for(o++;0===r[o].indexOf("i=")||0===r[o].indexOf("c=");)o++;if(0===r[o].indexOf("b"))return r[o]="b="+s+":"+a,r.join("\n");var u=r.slice(0,o);return u.push("b="+s+":"+a),(u=u.concat(r.slice(o,r.length))).join("\n")}s.prototype._init=function(e,t,n,r){i.trace("RTCPeerConnection init. userID: "+t+", sessionID: "+n+", type: "+r),this.delegate=e,this.sessionID=n,this.userID=t,this.type=r,this.remoteSDP=null,this.state=l.NEW,this.onicecandidate=this.onIceCandidateCallback.bind(this),this.onsignalingstatechange=this.onSignalingStateCallback.bind(this),this.oniceconnectionstatechange=this.onIceConnectionStateCallback.bind(this),i.getVersionSafari()>=11?(this.remoteStream=new u,this.ontrack=this.onAddRemoteMediaCallback.bind(this),this.onStatusClosedChecker=void 0):(this.remoteStream=null,this.onaddstream=this.onAddRemoteMediaCallback.bind(this)),this.dialingTimer=null,this.answerTimeInterval=0,this.statsReportTimer=null,this.iceCandidates=[],this.released=!1},s.prototype.release=function(){this._clearDialingTimer(),this._clearStatsReportTimer(),this.close(),i.getVersionSafari()>=11&&this.onIceConnectionStateCallback(),this.released=!0},s.prototype.updateRemoteSDP=function(e){if(!e)throw new Error("sdp string can't be empty.");this.remoteSDP=e},s.prototype.getRemoteSDP=function(){return this.remoteSDP},s.prototype.setRemoteSessionDescription=function(e,t){var n=new a({sdp:t,type:e});return n.sdp=d(n.sdp,"video",this.delegate.bandwidth),this.setRemoteDescription(n)},s.prototype.addLocalStream=function(e){if(!e)throw new Error("'RTCPeerConnection.addStream' error: stream is 'null'.");this.addStream(e)},s.prototype.getAndSetLocalSessionDescription=function(e){var t=this;return new Promise((function(e,n){t.state=l.CONNECTING,"offer"===t.type?t.createOffer().then((function(r){r.sdp=d(r.sdp,"video",t.delegate.bandwidth),t.setLocalDescription(r).then(e).catch(n)})).catch(n):t.createAnswer().then((function(r){r.sdp=d(r.sdp,"video",t.delegate.bandwidth),t.setLocalDescription(r).then(e).catch(n)})).catch(n)}))},s.prototype.addCandidates=function(e){for(var t=0,n=e.length;t<n;t++){var r={sdpMLineIndex:e[t].sdpMLineIndex,sdpMid:e[t].sdpMid,candidate:e[t].candidate};this.addIceCandidate(new c(r),(function(){}),(function(e){i.traceError("Error on 'addIceCandidate': "+e)}))}},s.prototype.toString=function(){return"sessionID: "+this.sessionID+", userID:  "+this.userID+", type: "+this.type+", state: "+this.state},s.prototype.onSignalingStateCallback=function(){i.trace("onSignalingStateCallback: "+this.signalingState),"stable"===this.signalingState&&this.iceCandidates.length>0&&(this.delegate._processIceCandidates(this,this.iceCandidates),this.iceCandidates.length=0)},s.prototype.onIceCandidateCallback=function(e){var t=e.candidate;if(t){var n={sdpMLineIndex:t.sdpMLineIndex,sdpMid:t.sdpMid,candidate:t.candidate};"stable"===this.signalingState?this.delegate._processIceCandidates(this,[n]):this.iceCandidates.push(n)}},s.prototype.onAddRemoteMediaCallback=function(e){"function"==typeof this.delegate._onRemoteStreamListener&&("addstream"===e.type?this.remoteStream=e.stream:this.remoteStream.addTrack(e.track),(1==this.delegate.callType&&this.remoteStream.getVideoTracks().length||2==this.delegate.callType&&this.remoteStream.getAudioTracks().length)&&this.delegate._onRemoteStreamListener(this.userID,this.remoteStream),this._getStatsWrap())},s.prototype.onIceConnectionStateCallback=function(){var e=this;if(i.trace("onIceConnectionStateCallback: "+this.iceConnectionState),"function"==typeof this.delegate._onSessionConnectionStateChangedListener){var t=null;switch(i.getVersionSafari()>=11&&clearTimeout(this.onStatusClosedChecker),this.iceConnectionState){case"checking":this.state=l.CHECKING,t=o.CONNECTING;break;case"connected":this._clearWaitingReconnectTimer(),this.state=l.CONNECTED,t=o.CONNECTED;break;case"completed":this._clearWaitingReconnectTimer(),this.state=l.COMPLETED,t=o.COMPLETED;break;case"failed":this.state=l.FAILED,t=o.FAILED;break;case"disconnected":this._startWaitingReconnectTimer(),this.state=l.DISCONNECTED,t=o.DISCONNECTED,i.getVersionSafari()>=11&&(this.onStatusClosedChecker=setTimeout((function(){e.onIceConnectionStateCallback()}),500));break;case"closed":this._clearWaitingReconnectTimer(),this.state=l.CLOSED,t=o.CLOSED}t&&this.delegate._onSessionConnectionStateChangedListener(this.userID,t)}},s.prototype._clearStatsReportTimer=function(){this.statsReportTimer&&(clearInterval(this.statsReportTimer),this.statsReportTimer=null)},s.prototype._getStatsWrap=function(){var e,t,n=this;if(r.videochat&&r.videochat.statsReportTimeInterval){if(isNaN(+r.videochat.statsReportTimeInterval))return void i.traceError("statsReportTimeInterval ("+r.videochat.statsReportTimeInterval+") must be integer.");e=1e3*r.videochat.statsReportTimeInterval;i.trace("Stats tracker has been started."),this.statsReportTimer=setInterval((function(){!function(e,t,n,r){var o={local:{audio:{},video:{},candidate:{}},remote:{audio:{},video:{},candidate:{}}};if(i.getVersionFirefox()){var s=e.getLocalStreams().length?e.getLocalStreams()[0]:e.delegate.localStream,a=s.getVideoTracks().length?s.getVideoTracks()[0].getSettings():null;o.local.video.frameHeight=a&&a.height,o.local.video.frameWidth=a&&a.width}e.getStats(null).then((function(e){e.forEach((function(e){var n;e.bytesReceived&&"inbound-rtp"===e.type?((n=o.remote[e.mediaType]).bitrate=c(e,t,!1),n.bytesReceived=e.bytesReceived,n.packetsReceived=e.packetsReceived,n.timestamp=e.timestamp,"video"===e.mediaType&&e.framerateMean&&(n.framesPerSecond=Math.round(10*e.framerateMean)/10)):e.bytesSent&&"outbound-rtp"===e.type?((n=o.local[e.mediaType]).bitrate=c(e,t,!0),n.bytesSent=e.bytesSent,n.packetsSent=e.packetsSent,n.timestamp=e.timestamp,"video"===e.mediaType&&e.framerateMean&&(n.framesPerSecond=Math.round(10*e.framerateMean)/10)):"local-candidate"===e.type?(n=o.local.candidate,"host"===e.candidateType&&"udp"===e.mozLocalTransport&&"udp"===e.transport?(n.protocol=e.transport,n.ip=e.ipAddress,n.port=e.portNumber):i.getVersionFirefox()||(n.protocol=e.protocol,n.ip=e.ip,n.port=e.port)):"remote-candidate"===e.type?((n=o.remote.candidate).protocol=e.protocol||e.transport,n.ip=e.ip||e.ipAddress,n.port=e.port||e.portNumber):"track"!==e.type||"video"!==e.kind||i.getVersionFirefox()||(e.remoteSource?((n=o.remote.video).frameHeight=e.frameHeight,n.frameWidth=e.frameWidth,n.framesPerSecond=u(e,t,!1)):((n=o.local.video).frameHeight=e.frameHeight,n.frameWidth=e.frameWidth,n.framesPerSecond=u(e,t,!0)))})),n(o,e)}),r);var c=function(e,t,n){var r,i=t&&t.get(e.id),o=i?(e.timestamp-i.timestamp)/1e3:5;return r=i?n?8*(e.bytesSent-i.bytesSent)/(1024*o):8*(e.bytesReceived-i.bytesReceived)/(1024*o):0,Math.round(r)},u=function(e,t,n){var r,i=t&&t.get(e.id),o=i?(e.timestamp-i.timestamp)/1e3:5;return r=i?n?(e.framesSent-i.framesSent)/o:(e.framesReceived-i.framesReceived)/o:0,Math.round(10*r)/10}}(n,t,(function(e,r){t=r,n.delegate._onCallStatsReport(n.userID,e,null)}),(function(e){i.traceError("_getStats error. "+e.name+": "+e.message),n.delegate._onCallStatsReport(n.userID,null,e)}))}),e)}},s.prototype._clearWaitingReconnectTimer=function(){this.waitingReconnectTimeoutCallback&&(i.trace("_clearWaitingReconnectTimer"),clearTimeout(this.waitingReconnectTimeoutCallback),this.waitingReconnectTimeoutCallback=null)},s.prototype._startWaitingReconnectTimer=function(){var e=this,t=1e3*r.videochat.disconnectTimeInterval;i.trace("_startWaitingReconnectTimer, timeout: "+t),this.waitingReconnectTimeoutCallback=setTimeout((function(){i.trace("waitingReconnectTimeoutCallback"),clearTimeout(e.waitingReconnectTimeoutCallback),e.release(),e.delegate._closeSessionIfAllConnectionsClosed()}),t)},s.prototype._clearDialingTimer=function(){this.dialingTimer&&(i.trace("_clearDialingTimer"),clearInterval(this.dialingTimer),this.dialingTimer=null,this.answerTimeInterval=0)},s.prototype._startDialingTimer=function(e,t){var n=this,o=1e3*r.videochat.dialingTimeInterval;i.trace("_startDialingTimer, dialingTimeInterval: "+o);var s=function(e,t,o){o||(n.answerTimeInterval+=1e3*r.videochat.dialingTimeInterval),i.trace("_dialingCallback, answerTimeInterval: "+n.answerTimeInterval),n.answerTimeInterval>=1e3*r.videochat.answerTimeInterval?(n._clearDialingTimer(),t&&n.delegate._processOnNotAnswer(n)):n.delegate._processCall(n,e)};this.dialingTimer=setInterval(s,o,e,t,!1),s(e,t,!0)},e.exports=s},function(e,t,n){"use strict";var r=function(e){function t(n,r,i){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),e.call(this,n),this.listener=r,this.context=i}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,e),t}(n(114));e.exports=r},function(e,t,n){"use strict";e.exports=function(e,t,n,r,i,o,s,a){if(!e){var c;if(void 0===t)c=new Error("Minified exception occurred; use the non-minified dev environment for the full error message and additional helpful warnings.");else{var u=[n,r,i,o,s,a],l=0;(c=new Error(t.replace(/%s/g,(function(){return u[l++]})))).name="Invariant Violation"}throw c.framesToPop=1,c}}},function(e,t,n){function r(e){return(r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function i(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var o=n(1),s=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,s,a;return t=e,(s=[{key:"init",value:function(e,t){t&&"object"===r(t)&&o.set(t);var i=n(31),s=n(92),a=n(93),c=n(94),u=n(95),l=n(96),d=n(97),f=n(98),h=n(104),p=n(105),m=n(0);if(this.service=new i,this.auth=new s(this.service),this.users=new a(this.service),this.storage=new c(this.service),this.pushnotifications=new u(this.service),this.data=new l(this.service),this.addressbook=new d(this.service),this.chat=new f(this.service),this.chat.dialog=new h(this.service),this.chat.message=new p(this.service),this.utils=m,m.isWebRTCAvailble()){var g=n(106);this.videochat=new g(this.chat.xmppClient),this.chat.webrtcSignalingProcessor=this.videochat.signalingProcessor,this.videochatconference=n(110),m.getEnv().reactnative&&(this.RTCView=n(2).RTCView)}else this.videochat=null,this.videochatconference=null;e.token?(o.creds.appId=e.appId,this.service.setSession({token:e.token})):(o.creds.appId=e.appId,o.creds.authKey=e.authKey,o.creds.authSecret=e.authSecret)}},{key:"getSession",value:function(){return this.auth.getSession()}},{key:"createSession",value:function(e){return this.auth.createSession(e)}},{key:"destroySession",value:function(){return this.auth.destroySession()}},{key:"createWebSession",value:function(e){return this.auth.createWebSession(e)}},{key:"checkWebSessionUntilUpgrade",value:function(e){return this.auth.checkWebSessionUntilUpgrade(e)}},{key:"upgradeWebSession",value:function(e){return this.auth.upgradeWebSession(e)}},{key:"login",value:function(e){return this.auth.login(e)}},{key:"logout",value:function(){return this.auth.logout()}}])&&i(t.prototype,s),a&&i(t,a),e}(),a=new s;a.ConnectyCube=s,e.exports=a},function(e){e.exports=JSON.parse('{"name":"connectycube","description":"ConnectyCube chat and video chat JavaScript SDK","version":"2.1.6","homepage":"https://developers.connectycube.com/reactnative","main":"lib/cubeMain.js","license":"Apache-2.0","keywords":["connectycube","messaging","videocalling","javascript","nativescript","react-native","nodejs","sdk","cloud","api","chat","videochat","communication","webrtc","storage","users","push notifications","calling"],"author":"ConnectyCube team <support@connectycube.com>","directories":{"lib":"lib","test":"__tests__"},"files":["lib","dist/connectycube.min.js","dist/connectycube.min.map"],"repository":{"type":"git","url":"https://github.com/ConnectyCube/connectycube-js-sdk-releases"},"bugs":{"url":"https://github.com/ConnectyCube/connectycube-js-sdk-releases/issues"},"scripts":{"build.release":"./node_modules/.bin/webpack --config webpack.config.js --env.production","build.dev":"./node_modules/.bin/webpack --config webpack.config.js --env.development","build.all":"npm run build.release && npm run build.dev","docs":"rimraf docs && mkdir docs && jsdoc -c ./jsdoc.conf","installDependencies":"npm install && npm install -g jasmine","test":"jasmine --config=__tests__/support/jasmine.json","watch":"./node_modules/.bin/webpack --watch --config webpack.config.js --env.development"},"dependencies":{"@xmpp/client":"0.9.2","crypto-js":"3.1.9-1","fbemitter":"^2.1.1","form-data":"^2.3.2","node-fetch":"^1.7.3"},"devDependencies":{"@babel/core":"^7.5.5","@babel/plugin-proposal-object-rest-spread":"^7.7.7","@babel/preset-env":"^7.5.5","babel-loader":"^8.0.6","clean-webpack-plugin":"^3.0.0","ghooks":"^1.3.2","jaguarjs-jsdoc":"^1.1.0","jasmine":"3.5.0","jasmine-core":"3.5.0","jsdoc":"^3.6.3","webpack":"^4.39.1","webpack-cli":"^3.3.6"}}')},function(e,t,n){function r(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var i=n(1),o=n(0),s=n(2).fetchImpl,a=n(2).formDataImpl,c=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.sdkInstance={config:i,session:null},this.currentUserId=null,this.requestsNumber=0}var t,n,c;return t=e,(n=[{key:"setSession",value:function(e){this.sdkInstance.session=e}},{key:"getSession",value:function(){return this.sdkInstance.session}},{key:"setCurrentUserId",value:function(e){this.currentUserId=e}},{key:"getCurrentUserId",value:function(){return this.currentUserId}},{key:"logRequest",value:function(e){++this.requestsNumber,o.DLog("[Request]["+this.requestsNumber+"]",(e.type||"GET")+" "+e.url,e)}},{key:"logResponse",value:function(e){o.DLog("[Response]["+this.requestsNumber+"]",e)}},{key:"buildRequestAndURL",value:function(e){var t,n=!e.type||"GET"===e.type||"HEAD"===e.type,r=e.type&&("POST"===e.type||"PUT"===e.type),o=this.sdkInstance&&this.sdkInstance.session&&this.sdkInstance.session.token,s=-1===e.url.indexOf("s3.amazonaws.com"),a=!1===e.contentType,c=e.url,u={};return u.method=e.type||"GET",e.data&&(t=this.buildRequestBody(e,a,r),n?c+="?"+t:u.body=t),a||(u.headers={"Content-Type":r?"application/json;charset=utf-8":"application/x-www-form-urlencoded; charset=UTF-8"}),s&&(u.headers||(u.headers={}),u.headers["CB-SDK"]="JS "+i.version+" - Client",o&&(u.headers["CB-Token"]=o)),i.timeout&&(u.timeout=i.timeout),[u,c]}},{key:"buildRequestBody",value:function(e,t,n){var r,i=this,s=e.data;return t?(r=new a,Object.keys(s).forEach((function(t){e.fileToCustomObject&&"file"===t?r.append(t,s[t].data,s[t].name):r.append(t,e.data[t])}))):r=n?JSON.stringify(s):Object.keys(s).map((function(e){return o.isObject(s[e])?Object.keys(s[e]).map((function(t){return i.encodeURIComponent(e)+"["+(o.isArray(s[e])?"":t)+"]="+i.encodeURIComponent(s[e][t])})).sort().join("&"):i.encodeURIComponent(e)+(o.isArray(s[e])?"[]":"")+"="+i.encodeURIComponent(s[e])})).sort().join("&"),r}},{key:"encodeURIComponent",value:function(e){function t(t){return e.apply(this,arguments)}return t.toString=function(){return e.toString()},t}((function(e){return encodeURIComponent(e).replace(/[#$&+,/:;=?@\[\]]/g,(function(e){return"%"+e.charCodeAt(0).toString(16)}))}))},{key:"ajax",value:function(e){var t=this;return new Promise((function(n,r){t.logRequest(e);var i,o=t.buildRequestAndURL(e),a=o[0],c=o[1];s(c,a).then((function(t){return i=t,"text"===(e.dataType||"json")?i.text():i.json()})).then((function(o){i.ok?t.processAjaxResponse(o,n):t.processAjaxError(i,o,null,r,n,e)})).catch((function(o){t.processAjaxError(i," ",o,r,n,e)}))}))}},{key:"processAjaxResponse",value:function(e,t){var n=e&&" "!==e?e:"empty body";this.logResponse(n),t(e)}},{key:"processAjaxError",value:function(e,t,n,r,s,a){var c=e&&(e.status||e.statusCode),u={code:e&&c||n&&n.code,info:(t&&"string"==typeof t?JSON.parse(t):t)||n&&n.errno},l=t||n||t.errors;this.logResponse(l),-1===e.url.indexOf(i.urls.session)&&o.isExpiredSessionError(u)&&"function"==typeof i.on.sessionExpired?this.handleExpiredSessionResponse(u,null,r,s,a):r(u)}},{key:"handleExpiredSessionResponse",value:function(e,t,n,r,o){i.on.sessionExpired((function(){e?n(e):r(t)}),(function(e){if(e)return this.setSession(e),this.ajax(o)}))}}])&&r(t.prototype,n),c&&r(t,c),e}();e.exports=c},function(e,t,n){"use strict";(function(e){
/*!
 * The buffer module from node.js, for the browser.
 *
 * @author   Feross Aboukhadijeh <http://feross.org>
 * @license  MIT
 */
var r=n(33),i=n(34),o=n(35);function s(){return c.TYPED_ARRAY_SUPPORT?2147483647:1073741823}function a(e,t){if(s()<t)throw new RangeError("Invalid typed array length");return c.TYPED_ARRAY_SUPPORT?(e=new Uint8Array(t)).__proto__=c.prototype:(null===e&&(e=new c(t)),e.length=t),e}function c(e,t,n){if(!(c.TYPED_ARRAY_SUPPORT||this instanceof c))return new c(e,t,n);if("number"==typeof e){if("string"==typeof t)throw new Error("If encoding is specified then the first argument must be a string");return d(this,e)}return u(this,e,t,n)}function u(e,t,n,r){if("number"==typeof t)throw new TypeError('"value" argument must not be a number');return"undefined"!=typeof ArrayBuffer&&t instanceof ArrayBuffer?function(e,t,n,r){if(t.byteLength,n<0||t.byteLength<n)throw new RangeError("'offset' is out of bounds");if(t.byteLength<n+(r||0))throw new RangeError("'length' is out of bounds");t=void 0===n&&void 0===r?new Uint8Array(t):void 0===r?new Uint8Array(t,n):new Uint8Array(t,n,r);c.TYPED_ARRAY_SUPPORT?(e=t).__proto__=c.prototype:e=f(e,t);return e}(e,t,n,r):"string"==typeof t?function(e,t,n){"string"==typeof n&&""!==n||(n="utf8");if(!c.isEncoding(n))throw new TypeError('"encoding" must be a valid string encoding');var r=0|p(t,n),i=(e=a(e,r)).write(t,n);i!==r&&(e=e.slice(0,i));return e}(e,t,n):function(e,t){if(c.isBuffer(t)){var n=0|h(t.length);return 0===(e=a(e,n)).length?e:(t.copy(e,0,0,n),e)}if(t){if("undefined"!=typeof ArrayBuffer&&t.buffer instanceof ArrayBuffer||"length"in t)return"number"!=typeof t.length||(r=t.length)!=r?a(e,0):f(e,t);if("Buffer"===t.type&&o(t.data))return f(e,t.data)}var r;throw new TypeError("First argument must be a string, Buffer, ArrayBuffer, Array, or array-like object.")}(e,t)}function l(e){if("number"!=typeof e)throw new TypeError('"size" argument must be a number');if(e<0)throw new RangeError('"size" argument must not be negative')}function d(e,t){if(l(t),e=a(e,t<0?0:0|h(t)),!c.TYPED_ARRAY_SUPPORT)for(var n=0;n<t;++n)e[n]=0;return e}function f(e,t){var n=t.length<0?0:0|h(t.length);e=a(e,n);for(var r=0;r<n;r+=1)e[r]=255&t[r];return e}function h(e){if(e>=s())throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+s().toString(16)+" bytes");return 0|e}function p(e,t){if(c.isBuffer(e))return e.length;if("undefined"!=typeof ArrayBuffer&&"function"==typeof ArrayBuffer.isView&&(ArrayBuffer.isView(e)||e instanceof ArrayBuffer))return e.byteLength;"string"!=typeof e&&(e=""+e);var n=e.length;if(0===n)return 0;for(var r=!1;;)switch(t){case"ascii":case"latin1":case"binary":return n;case"utf8":case"utf-8":case void 0:return z(e).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return 2*n;case"hex":return n>>>1;case"base64":return q(e).length;default:if(r)return z(e).length;t=(""+t).toLowerCase(),r=!0}}function m(e,t,n){var r=!1;if((void 0===t||t<0)&&(t=0),t>this.length)return"";if((void 0===n||n>this.length)&&(n=this.length),n<=0)return"";if((n>>>=0)<=(t>>>=0))return"";for(e||(e="utf8");;)switch(e){case"hex":return A(this,t,n);case"utf8":case"utf-8":return I(this,t,n);case"ascii":return _(this,t,n);case"latin1":case"binary":return E(this,t,n);case"base64":return T(this,t,n);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return D(this,t,n);default:if(r)throw new TypeError("Unknown encoding: "+e);e=(e+"").toLowerCase(),r=!0}}function g(e,t,n){var r=e[t];e[t]=e[n],e[n]=r}function v(e,t,n,r,i){if(0===e.length)return-1;if("string"==typeof n?(r=n,n=0):n>2147483647?n=2147483647:n<-2147483648&&(n=-2147483648),n=+n,isNaN(n)&&(n=i?0:e.length-1),n<0&&(n=e.length+n),n>=e.length){if(i)return-1;n=e.length-1}else if(n<0){if(!i)return-1;n=0}if("string"==typeof t&&(t=c.from(t,r)),c.isBuffer(t))return 0===t.length?-1:y(e,t,n,r,i);if("number"==typeof t)return t&=255,c.TYPED_ARRAY_SUPPORT&&"function"==typeof Uint8Array.prototype.indexOf?i?Uint8Array.prototype.indexOf.call(e,t,n):Uint8Array.prototype.lastIndexOf.call(e,t,n):y(e,[t],n,r,i);throw new TypeError("val must be string, number or Buffer")}function y(e,t,n,r,i){var o,s=1,a=e.length,c=t.length;if(void 0!==r&&("ucs2"===(r=String(r).toLowerCase())||"ucs-2"===r||"utf16le"===r||"utf-16le"===r)){if(e.length<2||t.length<2)return-1;s=2,a/=2,c/=2,n/=2}function u(e,t){return 1===s?e[t]:e.readUInt16BE(t*s)}if(i){var l=-1;for(o=n;o<a;o++)if(u(e,o)===u(t,-1===l?0:o-l)){if(-1===l&&(l=o),o-l+1===c)return l*s}else-1!==l&&(o-=o-l),l=-1}else for(n+c>a&&(n=a-c),o=n;o>=0;o--){for(var d=!0,f=0;f<c;f++)if(u(e,o+f)!==u(t,f)){d=!1;break}if(d)return o}return-1}function b(e,t,n,r){n=Number(n)||0;var i=e.length-n;r?(r=Number(r))>i&&(r=i):r=i;var o=t.length;if(o%2!=0)throw new TypeError("Invalid hex string");r>o/2&&(r=o/2);for(var s=0;s<r;++s){var a=parseInt(t.substr(2*s,2),16);if(isNaN(a))return s;e[n+s]=a}return s}function w(e,t,n,r){return J(z(t,e.length-n),e,n,r)}function S(e,t,n,r){return J(function(e){for(var t=[],n=0;n<e.length;++n)t.push(255&e.charCodeAt(n));return t}(t),e,n,r)}function C(e,t,n,r){return S(e,t,n,r)}function k(e,t,n,r){return J(q(t),e,n,r)}function x(e,t,n,r){return J(function(e,t){for(var n,r,i,o=[],s=0;s<e.length&&!((t-=2)<0);++s)n=e.charCodeAt(s),r=n>>8,i=n%256,o.push(i),o.push(r);return o}(t,e.length-n),e,n,r)}function T(e,t,n){return 0===t&&n===e.length?r.fromByteArray(e):r.fromByteArray(e.slice(t,n))}function I(e,t,n){n=Math.min(e.length,n);for(var r=[],i=t;i<n;){var o,s,a,c,u=e[i],l=null,d=u>239?4:u>223?3:u>191?2:1;if(i+d<=n)switch(d){case 1:u<128&&(l=u);break;case 2:128==(192&(o=e[i+1]))&&(c=(31&u)<<6|63&o)>127&&(l=c);break;case 3:o=e[i+1],s=e[i+2],128==(192&o)&&128==(192&s)&&(c=(15&u)<<12|(63&o)<<6|63&s)>2047&&(c<55296||c>57343)&&(l=c);break;case 4:o=e[i+1],s=e[i+2],a=e[i+3],128==(192&o)&&128==(192&s)&&128==(192&a)&&(c=(15&u)<<18|(63&o)<<12|(63&s)<<6|63&a)>65535&&c<1114112&&(l=c)}null===l?(l=65533,d=1):l>65535&&(l-=65536,r.push(l>>>10&1023|55296),l=56320|1023&l),r.push(l),i+=d}return function(e){var t=e.length;if(t<=4096)return String.fromCharCode.apply(String,e);var n="",r=0;for(;r<t;)n+=String.fromCharCode.apply(String,e.slice(r,r+=4096));return n}(r)}t.Buffer=c,t.SlowBuffer=function(e){+e!=e&&(e=0);return c.alloc(+e)},t.INSPECT_MAX_BYTES=50,c.TYPED_ARRAY_SUPPORT=void 0!==e.TYPED_ARRAY_SUPPORT?e.TYPED_ARRAY_SUPPORT:function(){try{var e=new Uint8Array(1);return e.__proto__={__proto__:Uint8Array.prototype,foo:function(){return 42}},42===e.foo()&&"function"==typeof e.subarray&&0===e.subarray(1,1).byteLength}catch(e){return!1}}(),t.kMaxLength=s(),c.poolSize=8192,c._augment=function(e){return e.__proto__=c.prototype,e},c.from=function(e,t,n){return u(null,e,t,n)},c.TYPED_ARRAY_SUPPORT&&(c.prototype.__proto__=Uint8Array.prototype,c.__proto__=Uint8Array,"undefined"!=typeof Symbol&&Symbol.species&&c[Symbol.species]===c&&Object.defineProperty(c,Symbol.species,{value:null,configurable:!0})),c.alloc=function(e,t,n){return function(e,t,n,r){return l(t),t<=0?a(e,t):void 0!==n?"string"==typeof r?a(e,t).fill(n,r):a(e,t).fill(n):a(e,t)}(null,e,t,n)},c.allocUnsafe=function(e){return d(null,e)},c.allocUnsafeSlow=function(e){return d(null,e)},c.isBuffer=function(e){return!(null==e||!e._isBuffer)},c.compare=function(e,t){if(!c.isBuffer(e)||!c.isBuffer(t))throw new TypeError("Arguments must be Buffers");if(e===t)return 0;for(var n=e.length,r=t.length,i=0,o=Math.min(n,r);i<o;++i)if(e[i]!==t[i]){n=e[i],r=t[i];break}return n<r?-1:r<n?1:0},c.isEncoding=function(e){switch(String(e).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},c.concat=function(e,t){if(!o(e))throw new TypeError('"list" argument must be an Array of Buffers');if(0===e.length)return c.alloc(0);var n;if(void 0===t)for(t=0,n=0;n<e.length;++n)t+=e[n].length;var r=c.allocUnsafe(t),i=0;for(n=0;n<e.length;++n){var s=e[n];if(!c.isBuffer(s))throw new TypeError('"list" argument must be an Array of Buffers');s.copy(r,i),i+=s.length}return r},c.byteLength=p,c.prototype._isBuffer=!0,c.prototype.swap16=function(){var e=this.length;if(e%2!=0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(var t=0;t<e;t+=2)g(this,t,t+1);return this},c.prototype.swap32=function(){var e=this.length;if(e%4!=0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(var t=0;t<e;t+=4)g(this,t,t+3),g(this,t+1,t+2);return this},c.prototype.swap64=function(){var e=this.length;if(e%8!=0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(var t=0;t<e;t+=8)g(this,t,t+7),g(this,t+1,t+6),g(this,t+2,t+5),g(this,t+3,t+4);return this},c.prototype.toString=function(){var e=0|this.length;return 0===e?"":0===arguments.length?I(this,0,e):m.apply(this,arguments)},c.prototype.equals=function(e){if(!c.isBuffer(e))throw new TypeError("Argument must be a Buffer");return this===e||0===c.compare(this,e)},c.prototype.inspect=function(){var e="",n=t.INSPECT_MAX_BYTES;return this.length>0&&(e=this.toString("hex",0,n).match(/.{2}/g).join(" "),this.length>n&&(e+=" ... ")),"<Buffer "+e+">"},c.prototype.compare=function(e,t,n,r,i){if(!c.isBuffer(e))throw new TypeError("Argument must be a Buffer");if(void 0===t&&(t=0),void 0===n&&(n=e?e.length:0),void 0===r&&(r=0),void 0===i&&(i=this.length),t<0||n>e.length||r<0||i>this.length)throw new RangeError("out of range index");if(r>=i&&t>=n)return 0;if(r>=i)return-1;if(t>=n)return 1;if(this===e)return 0;for(var o=(i>>>=0)-(r>>>=0),s=(n>>>=0)-(t>>>=0),a=Math.min(o,s),u=this.slice(r,i),l=e.slice(t,n),d=0;d<a;++d)if(u[d]!==l[d]){o=u[d],s=l[d];break}return o<s?-1:s<o?1:0},c.prototype.includes=function(e,t,n){return-1!==this.indexOf(e,t,n)},c.prototype.indexOf=function(e,t,n){return v(this,e,t,n,!0)},c.prototype.lastIndexOf=function(e,t,n){return v(this,e,t,n,!1)},c.prototype.write=function(e,t,n,r){if(void 0===t)r="utf8",n=this.length,t=0;else if(void 0===n&&"string"==typeof t)r=t,n=this.length,t=0;else{if(!isFinite(t))throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");t|=0,isFinite(n)?(n|=0,void 0===r&&(r="utf8")):(r=n,n=void 0)}var i=this.length-t;if((void 0===n||n>i)&&(n=i),e.length>0&&(n<0||t<0)||t>this.length)throw new RangeError("Attempt to write outside buffer bounds");r||(r="utf8");for(var o=!1;;)switch(r){case"hex":return b(this,e,t,n);case"utf8":case"utf-8":return w(this,e,t,n);case"ascii":return S(this,e,t,n);case"latin1":case"binary":return C(this,e,t,n);case"base64":return k(this,e,t,n);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return x(this,e,t,n);default:if(o)throw new TypeError("Unknown encoding: "+r);r=(""+r).toLowerCase(),o=!0}},c.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};function _(e,t,n){var r="";n=Math.min(e.length,n);for(var i=t;i<n;++i)r+=String.fromCharCode(127&e[i]);return r}function E(e,t,n){var r="";n=Math.min(e.length,n);for(var i=t;i<n;++i)r+=String.fromCharCode(e[i]);return r}function A(e,t,n){var r=e.length;(!t||t<0)&&(t=0),(!n||n<0||n>r)&&(n=r);for(var i="",o=t;o<n;++o)i+=F(e[o]);return i}function D(e,t,n){for(var r=e.slice(t,n),i="",o=0;o<r.length;o+=2)i+=String.fromCharCode(r[o]+256*r[o+1]);return i}function O(e,t,n){if(e%1!=0||e<0)throw new RangeError("offset is not uint");if(e+t>n)throw new RangeError("Trying to access beyond buffer length")}function P(e,t,n,r,i,o){if(!c.isBuffer(e))throw new TypeError('"buffer" argument must be a Buffer instance');if(t>i||t<o)throw new RangeError('"value" argument is out of bounds');if(n+r>e.length)throw new RangeError("Index out of range")}function j(e,t,n,r){t<0&&(t=65535+t+1);for(var i=0,o=Math.min(e.length-n,2);i<o;++i)e[n+i]=(t&255<<8*(r?i:1-i))>>>8*(r?i:1-i)}function R(e,t,n,r){t<0&&(t=4294967295+t+1);for(var i=0,o=Math.min(e.length-n,4);i<o;++i)e[n+i]=t>>>8*(r?i:3-i)&255}function L(e,t,n,r,i,o){if(n+r>e.length)throw new RangeError("Index out of range");if(n<0)throw new RangeError("Index out of range")}function U(e,t,n,r,o){return o||L(e,0,n,4),i.write(e,t,n,r,23,4),n+4}function M(e,t,n,r,o){return o||L(e,0,n,8),i.write(e,t,n,r,52,8),n+8}c.prototype.slice=function(e,t){var n,r=this.length;if((e=~~e)<0?(e+=r)<0&&(e=0):e>r&&(e=r),(t=void 0===t?r:~~t)<0?(t+=r)<0&&(t=0):t>r&&(t=r),t<e&&(t=e),c.TYPED_ARRAY_SUPPORT)(n=this.subarray(e,t)).__proto__=c.prototype;else{var i=t-e;n=new c(i,void 0);for(var o=0;o<i;++o)n[o]=this[o+e]}return n},c.prototype.readUIntLE=function(e,t,n){e|=0,t|=0,n||O(e,t,this.length);for(var r=this[e],i=1,o=0;++o<t&&(i*=256);)r+=this[e+o]*i;return r},c.prototype.readUIntBE=function(e,t,n){e|=0,t|=0,n||O(e,t,this.length);for(var r=this[e+--t],i=1;t>0&&(i*=256);)r+=this[e+--t]*i;return r},c.prototype.readUInt8=function(e,t){return t||O(e,1,this.length),this[e]},c.prototype.readUInt16LE=function(e,t){return t||O(e,2,this.length),this[e]|this[e+1]<<8},c.prototype.readUInt16BE=function(e,t){return t||O(e,2,this.length),this[e]<<8|this[e+1]},c.prototype.readUInt32LE=function(e,t){return t||O(e,4,this.length),(this[e]|this[e+1]<<8|this[e+2]<<16)+16777216*this[e+3]},c.prototype.readUInt32BE=function(e,t){return t||O(e,4,this.length),16777216*this[e]+(this[e+1]<<16|this[e+2]<<8|this[e+3])},c.prototype.readIntLE=function(e,t,n){e|=0,t|=0,n||O(e,t,this.length);for(var r=this[e],i=1,o=0;++o<t&&(i*=256);)r+=this[e+o]*i;return r>=(i*=128)&&(r-=Math.pow(2,8*t)),r},c.prototype.readIntBE=function(e,t,n){e|=0,t|=0,n||O(e,t,this.length);for(var r=t,i=1,o=this[e+--r];r>0&&(i*=256);)o+=this[e+--r]*i;return o>=(i*=128)&&(o-=Math.pow(2,8*t)),o},c.prototype.readInt8=function(e,t){return t||O(e,1,this.length),128&this[e]?-1*(255-this[e]+1):this[e]},c.prototype.readInt16LE=function(e,t){t||O(e,2,this.length);var n=this[e]|this[e+1]<<8;return 32768&n?4294901760|n:n},c.prototype.readInt16BE=function(e,t){t||O(e,2,this.length);var n=this[e+1]|this[e]<<8;return 32768&n?4294901760|n:n},c.prototype.readInt32LE=function(e,t){return t||O(e,4,this.length),this[e]|this[e+1]<<8|this[e+2]<<16|this[e+3]<<24},c.prototype.readInt32BE=function(e,t){return t||O(e,4,this.length),this[e]<<24|this[e+1]<<16|this[e+2]<<8|this[e+3]},c.prototype.readFloatLE=function(e,t){return t||O(e,4,this.length),i.read(this,e,!0,23,4)},c.prototype.readFloatBE=function(e,t){return t||O(e,4,this.length),i.read(this,e,!1,23,4)},c.prototype.readDoubleLE=function(e,t){return t||O(e,8,this.length),i.read(this,e,!0,52,8)},c.prototype.readDoubleBE=function(e,t){return t||O(e,8,this.length),i.read(this,e,!1,52,8)},c.prototype.writeUIntLE=function(e,t,n,r){(e=+e,t|=0,n|=0,r)||P(this,e,t,n,Math.pow(2,8*n)-1,0);var i=1,o=0;for(this[t]=255&e;++o<n&&(i*=256);)this[t+o]=e/i&255;return t+n},c.prototype.writeUIntBE=function(e,t,n,r){(e=+e,t|=0,n|=0,r)||P(this,e,t,n,Math.pow(2,8*n)-1,0);var i=n-1,o=1;for(this[t+i]=255&e;--i>=0&&(o*=256);)this[t+i]=e/o&255;return t+n},c.prototype.writeUInt8=function(e,t,n){return e=+e,t|=0,n||P(this,e,t,1,255,0),c.TYPED_ARRAY_SUPPORT||(e=Math.floor(e)),this[t]=255&e,t+1},c.prototype.writeUInt16LE=function(e,t,n){return e=+e,t|=0,n||P(this,e,t,2,65535,0),c.TYPED_ARRAY_SUPPORT?(this[t]=255&e,this[t+1]=e>>>8):j(this,e,t,!0),t+2},c.prototype.writeUInt16BE=function(e,t,n){return e=+e,t|=0,n||P(this,e,t,2,65535,0),c.TYPED_ARRAY_SUPPORT?(this[t]=e>>>8,this[t+1]=255&e):j(this,e,t,!1),t+2},c.prototype.writeUInt32LE=function(e,t,n){return e=+e,t|=0,n||P(this,e,t,4,4294967295,0),c.TYPED_ARRAY_SUPPORT?(this[t+3]=e>>>24,this[t+2]=e>>>16,this[t+1]=e>>>8,this[t]=255&e):R(this,e,t,!0),t+4},c.prototype.writeUInt32BE=function(e,t,n){return e=+e,t|=0,n||P(this,e,t,4,4294967295,0),c.TYPED_ARRAY_SUPPORT?(this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=255&e):R(this,e,t,!1),t+4},c.prototype.writeIntLE=function(e,t,n,r){if(e=+e,t|=0,!r){var i=Math.pow(2,8*n-1);P(this,e,t,n,i-1,-i)}var o=0,s=1,a=0;for(this[t]=255&e;++o<n&&(s*=256);)e<0&&0===a&&0!==this[t+o-1]&&(a=1),this[t+o]=(e/s>>0)-a&255;return t+n},c.prototype.writeIntBE=function(e,t,n,r){if(e=+e,t|=0,!r){var i=Math.pow(2,8*n-1);P(this,e,t,n,i-1,-i)}var o=n-1,s=1,a=0;for(this[t+o]=255&e;--o>=0&&(s*=256);)e<0&&0===a&&0!==this[t+o+1]&&(a=1),this[t+o]=(e/s>>0)-a&255;return t+n},c.prototype.writeInt8=function(e,t,n){return e=+e,t|=0,n||P(this,e,t,1,127,-128),c.TYPED_ARRAY_SUPPORT||(e=Math.floor(e)),e<0&&(e=255+e+1),this[t]=255&e,t+1},c.prototype.writeInt16LE=function(e,t,n){return e=+e,t|=0,n||P(this,e,t,2,32767,-32768),c.TYPED_ARRAY_SUPPORT?(this[t]=255&e,this[t+1]=e>>>8):j(this,e,t,!0),t+2},c.prototype.writeInt16BE=function(e,t,n){return e=+e,t|=0,n||P(this,e,t,2,32767,-32768),c.TYPED_ARRAY_SUPPORT?(this[t]=e>>>8,this[t+1]=255&e):j(this,e,t,!1),t+2},c.prototype.writeInt32LE=function(e,t,n){return e=+e,t|=0,n||P(this,e,t,4,2147483647,-2147483648),c.TYPED_ARRAY_SUPPORT?(this[t]=255&e,this[t+1]=e>>>8,this[t+2]=e>>>16,this[t+3]=e>>>24):R(this,e,t,!0),t+4},c.prototype.writeInt32BE=function(e,t,n){return e=+e,t|=0,n||P(this,e,t,4,2147483647,-2147483648),e<0&&(e=4294967295+e+1),c.TYPED_ARRAY_SUPPORT?(this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=255&e):R(this,e,t,!1),t+4},c.prototype.writeFloatLE=function(e,t,n){return U(this,e,t,!0,n)},c.prototype.writeFloatBE=function(e,t,n){return U(this,e,t,!1,n)},c.prototype.writeDoubleLE=function(e,t,n){return M(this,e,t,!0,n)},c.prototype.writeDoubleBE=function(e,t,n){return M(this,e,t,!1,n)},c.prototype.copy=function(e,t,n,r){if(n||(n=0),r||0===r||(r=this.length),t>=e.length&&(t=e.length),t||(t=0),r>0&&r<n&&(r=n),r===n)return 0;if(0===e.length||0===this.length)return 0;if(t<0)throw new RangeError("targetStart out of bounds");if(n<0||n>=this.length)throw new RangeError("sourceStart out of bounds");if(r<0)throw new RangeError("sourceEnd out of bounds");r>this.length&&(r=this.length),e.length-t<r-n&&(r=e.length-t+n);var i,o=r-n;if(this===e&&n<t&&t<r)for(i=o-1;i>=0;--i)e[i+t]=this[i+n];else if(o<1e3||!c.TYPED_ARRAY_SUPPORT)for(i=0;i<o;++i)e[i+t]=this[i+n];else Uint8Array.prototype.set.call(e,this.subarray(n,n+o),t);return o},c.prototype.fill=function(e,t,n,r){if("string"==typeof e){if("string"==typeof t?(r=t,t=0,n=this.length):"string"==typeof n&&(r=n,n=this.length),1===e.length){var i=e.charCodeAt(0);i<256&&(e=i)}if(void 0!==r&&"string"!=typeof r)throw new TypeError("encoding must be a string");if("string"==typeof r&&!c.isEncoding(r))throw new TypeError("Unknown encoding: "+r)}else"number"==typeof e&&(e&=255);if(t<0||this.length<t||this.length<n)throw new RangeError("Out of range index");if(n<=t)return this;var o;if(t>>>=0,n=void 0===n?this.length:n>>>0,e||(e=0),"number"==typeof e)for(o=t;o<n;++o)this[o]=e;else{var s=c.isBuffer(e)?e:z(new c(e,r).toString()),a=s.length;for(o=0;o<n-t;++o)this[o+t]=s[o%a]}return this};var N=/[^+\/0-9A-Za-z-_]/g;function F(e){return e<16?"0"+e.toString(16):e.toString(16)}function z(e,t){var n;t=t||1/0;for(var r=e.length,i=null,o=[],s=0;s<r;++s){if((n=e.charCodeAt(s))>55295&&n<57344){if(!i){if(n>56319){(t-=3)>-1&&o.push(239,191,189);continue}if(s+1===r){(t-=3)>-1&&o.push(239,191,189);continue}i=n;continue}if(n<56320){(t-=3)>-1&&o.push(239,191,189),i=n;continue}n=65536+(i-55296<<10|n-56320)}else i&&(t-=3)>-1&&o.push(239,191,189);if(i=null,n<128){if((t-=1)<0)break;o.push(n)}else if(n<2048){if((t-=2)<0)break;o.push(n>>6|192,63&n|128)}else if(n<65536){if((t-=3)<0)break;o.push(n>>12|224,n>>6&63|128,63&n|128)}else{if(!(n<1114112))throw new Error("Invalid code point");if((t-=4)<0)break;o.push(n>>18|240,n>>12&63|128,n>>6&63|128,63&n|128)}}return o}function q(e){return r.toByteArray(function(e){if((e=function(e){return e.trim?e.trim():e.replace(/^\s+|\s+$/g,"")}(e).replace(N,"")).length<2)return"";for(;e.length%4!=0;)e+="=";return e}(e))}function J(e,t,n,r){for(var i=0;i<r&&!(i+n>=t.length||i>=e.length);++i)t[i+n]=e[i];return i}}).call(this,n(7))},function(e,t,n){"use strict";t.byteLength=function(e){var t=u(e),n=t[0],r=t[1];return 3*(n+r)/4-r},t.toByteArray=function(e){var t,n,r=u(e),s=r[0],a=r[1],c=new o(function(e,t,n){return 3*(t+n)/4-n}(0,s,a)),l=0,d=a>0?s-4:s;for(n=0;n<d;n+=4)t=i[e.charCodeAt(n)]<<18|i[e.charCodeAt(n+1)]<<12|i[e.charCodeAt(n+2)]<<6|i[e.charCodeAt(n+3)],c[l++]=t>>16&255,c[l++]=t>>8&255,c[l++]=255&t;2===a&&(t=i[e.charCodeAt(n)]<<2|i[e.charCodeAt(n+1)]>>4,c[l++]=255&t);1===a&&(t=i[e.charCodeAt(n)]<<10|i[e.charCodeAt(n+1)]<<4|i[e.charCodeAt(n+2)]>>2,c[l++]=t>>8&255,c[l++]=255&t);return c},t.fromByteArray=function(e){for(var t,n=e.length,i=n%3,o=[],s=0,a=n-i;s<a;s+=16383)o.push(l(e,s,s+16383>a?a:s+16383));1===i?(t=e[n-1],o.push(r[t>>2]+r[t<<4&63]+"==")):2===i&&(t=(e[n-2]<<8)+e[n-1],o.push(r[t>>10]+r[t>>4&63]+r[t<<2&63]+"="));return o.join("")};for(var r=[],i=[],o="undefined"!=typeof Uint8Array?Uint8Array:Array,s="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",a=0,c=s.length;a<c;++a)r[a]=s[a],i[s.charCodeAt(a)]=a;function u(e){var t=e.length;if(t%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var n=e.indexOf("=");return-1===n&&(n=t),[n,n===t?0:4-n%4]}function l(e,t,n){for(var i,o,s=[],a=t;a<n;a+=3)i=(e[a]<<16&16711680)+(e[a+1]<<8&65280)+(255&e[a+2]),s.push(r[(o=i)>>18&63]+r[o>>12&63]+r[o>>6&63]+r[63&o]);return s.join("")}i["-".charCodeAt(0)]=62,i["_".charCodeAt(0)]=63},function(e,t){t.read=function(e,t,n,r,i){var o,s,a=8*i-r-1,c=(1<<a)-1,u=c>>1,l=-7,d=n?i-1:0,f=n?-1:1,h=e[t+d];for(d+=f,o=h&(1<<-l)-1,h>>=-l,l+=a;l>0;o=256*o+e[t+d],d+=f,l-=8);for(s=o&(1<<-l)-1,o>>=-l,l+=r;l>0;s=256*s+e[t+d],d+=f,l-=8);if(0===o)o=1-u;else{if(o===c)return s?NaN:1/0*(h?-1:1);s+=Math.pow(2,r),o-=u}return(h?-1:1)*s*Math.pow(2,o-r)},t.write=function(e,t,n,r,i,o){var s,a,c,u=8*o-i-1,l=(1<<u)-1,d=l>>1,f=23===i?Math.pow(2,-24)-Math.pow(2,-77):0,h=r?0:o-1,p=r?1:-1,m=t<0||0===t&&1/t<0?1:0;for(t=Math.abs(t),isNaN(t)||t===1/0?(a=isNaN(t)?1:0,s=l):(s=Math.floor(Math.log(t)/Math.LN2),t*(c=Math.pow(2,-s))<1&&(s--,c*=2),(t+=s+d>=1?f/c:f*Math.pow(2,1-d))*c>=2&&(s++,c/=2),s+d>=l?(a=0,s=l):s+d>=1?(a=(t*c-1)*Math.pow(2,i),s+=d):(a=t*Math.pow(2,d-1)*Math.pow(2,i),s=0));i>=8;e[n+h]=255&a,h+=p,a/=256,i-=8);for(s=s<<i|a,u+=i;u>0;e[n+h]=255&s,h+=p,s/=256,u-=8);e[n+h-p]|=128*m}},function(e,t){var n={}.toString;e.exports=Array.isArray||function(e){return"[object Array]"==n.call(e)}},function(e,t,n){var r;e.exports=(r=n(8),n(37),n(17),r.HmacSHA1)},function(e,t,n){var r,i,o,s,a,c,u,l;e.exports=(l=n(8),i=(r=l).lib,o=i.WordArray,s=i.Hasher,a=r.algo,c=[],u=a.SHA1=s.extend({_doReset:function(){this._hash=new o.init([1732584193,4023233417,2562383102,271733878,3285377520])},_doProcessBlock:function(e,t){for(var n=this._hash.words,r=n[0],i=n[1],o=n[2],s=n[3],a=n[4],u=0;u<80;u++){if(u<16)c[u]=0|e[t+u];else{var l=c[u-3]^c[u-8]^c[u-14]^c[u-16];c[u]=l<<1|l>>>31}var d=(r<<5|r>>>27)+a+c[u];d+=u<20?1518500249+(i&o|~i&s):u<40?1859775393+(i^o^s):u<60?(i&o|i&s|o&s)-1894007588:(i^o^s)-899497514,a=s,s=o,o=i<<30|i>>>2,i=r,r=d}n[0]=n[0]+r|0,n[1]=n[1]+i|0,n[2]=n[2]+o|0,n[3]=n[3]+s|0,n[4]=n[4]+a|0},_doFinalize:function(){var e=this._data,t=e.words,n=8*this._nDataBytes,r=8*e.sigBytes;return t[r>>>5]|=128<<24-r%32,t[14+(r+64>>>9<<4)]=Math.floor(n/4294967296),t[15+(r+64>>>9<<4)]=n,e.sigBytes=4*t.length,this._process(),this._hash},clone:function(){var e=s.clone.call(this);return e._hash=this._hash.clone(),e}}),r.SHA1=s._createHelper(u),r.HmacSHA1=s._createHmacHelper(u),l.SHA1)},function(e,t,n){var r;e.exports=(r=n(8),n(39),n(17),r.HmacSHA256)},function(e,t,n){var r;e.exports=(r=n(8),function(e){var t=r,n=t.lib,i=n.WordArray,o=n.Hasher,s=t.algo,a=[],c=[];!function(){function t(t){for(var n=e.sqrt(t),r=2;r<=n;r++)if(!(t%r))return!1;return!0}function n(e){return 4294967296*(e-(0|e))|0}for(var r=2,i=0;i<64;)t(r)&&(i<8&&(a[i]=n(e.pow(r,.5))),c[i]=n(e.pow(r,1/3)),i++),r++}();var u=[],l=s.SHA256=o.extend({_doReset:function(){this._hash=new i.init(a.slice(0))},_doProcessBlock:function(e,t){for(var n=this._hash.words,r=n[0],i=n[1],o=n[2],s=n[3],a=n[4],l=n[5],d=n[6],f=n[7],h=0;h<64;h++){if(h<16)u[h]=0|e[t+h];else{var p=u[h-15],m=(p<<25|p>>>7)^(p<<14|p>>>18)^p>>>3,g=u[h-2],v=(g<<15|g>>>17)^(g<<13|g>>>19)^g>>>10;u[h]=m+u[h-7]+v+u[h-16]}var y=r&i^r&o^i&o,b=(r<<30|r>>>2)^(r<<19|r>>>13)^(r<<10|r>>>22),w=f+((a<<26|a>>>6)^(a<<21|a>>>11)^(a<<7|a>>>25))+(a&l^~a&d)+c[h]+u[h];f=d,d=l,l=a,a=s+w|0,s=o,o=i,i=r,r=w+(b+y)|0}n[0]=n[0]+r|0,n[1]=n[1]+i|0,n[2]=n[2]+o|0,n[3]=n[3]+s|0,n[4]=n[4]+a|0,n[5]=n[5]+l|0,n[6]=n[6]+d|0,n[7]=n[7]+f|0},_doFinalize:function(){var t=this._data,n=t.words,r=8*this._nDataBytes,i=8*t.sigBytes;return n[i>>>5]|=128<<24-i%32,n[14+(i+64>>>9<<4)]=e.floor(r/4294967296),n[15+(i+64>>>9<<4)]=r,t.sigBytes=4*n.length,this._process(),this._hash},clone:function(){var e=o.clone.call(this);return e._hash=this._hash.clone(),e}});t.SHA256=o._createHelper(l),t.HmacSHA256=o._createHmacHelper(l)}(Math),r.SHA256)},function(e,t,n){"use strict";const{xml:r,jid:i,Client:o}=n(41),s=n(55),a=n(56),c=n(57),u=n(62),l=n(66),d=n(68),f=n(71),h=n(72),p=n(78),m=n(83),g=n(84),v=n(85),y=n(88);e.exports.xml=r,e.exports.jid=i,e.exports.client=function(e={}){const{resource:t,credentials:n,username:r,password:i,...b}=e,{domain:w,service:S}=b;!w&&S&&(b.domain=s(S));const C=new o(b),k=a({entity:C}),x=c({entity:C}),T=u({entity:C}),I=l({middleware:T}),_=d({middleware:T,entity:C}),E=f({middleware:T,entity:C}),A=h({entity:C}),D=p({streamFeatures:I},n||{username:r,password:i}),O=m({iqCaller:_,streamFeatures:I},t),P=g({iqCaller:_,streamFeatures:I}),j=Object.entries({plain:y,anonymous:v}).map(([e,t])=>({[e]:t(D)}));return Object.assign(C,{entity:C,reconnect:k,websocket:x,middleware:T,streamFeatures:I,iqCaller:_,iqCallee:E,resolve:A,sasl:D,resourceBinding:O,sessionEstablishment:P,mechanisms:j})}},function(e,t,n){"use strict";const r=n(42),i=n(3),o=n(11);e.exports.Client=r,e.exports.xml=i,e.exports.jid=o},function(e,t,n){"use strict";const r=n(18);class i extends r{constructor(e){super(e),this.transports=[]}send(e,...t){return this.Transport.prototype.send.call(this,e,...t)}_findTransport(e){return this.transports.find(t=>{try{return void 0!==t.prototype.socketParameters(e)}catch(e){return!1}})}connect(e){const t=this._findTransport(e);if(!t)throw new Error("No compatible connection method found.");return this.Transport=t,this.Socket=t.prototype.Socket,this.Parser=t.prototype.Parser,super.connect(e)}socketParameters(...e){return this.Transport.prototype.socketParameters(...e)}header(...e){return this.Transport.prototype.header(...e)}headerElement(...e){return this.Transport.prototype.headerElement(...e)}footer(...e){return this.Transport.prototype.footer(...e)}footerElement(...e){return this.Transport.prototype.footerElement(...e)}}i.prototype.NS="jabber:client",e.exports=i},function(e,t,n){"use strict";const r=n(13),i=n(19);e.exports=function(e,t){const n=i(t);return Promise.race([e.finally((function(){clearTimeout(n.timeout)})),n.then(()=>{throw new r})])}},function(e,t,n){"use strict";const r=n(13);e.exports=function(e,t,n="error",i){return new Promise((o,s)=>{let a;const c=()=>{clearTimeout(a),e.removeListener(t,l),e.removeListener(n,u)};function u(e){s(e),c()}function l(e){o(e),c()}e.once(t,l),n&&e.once(n,u),i&&(a=setTimeout(()=>{c(),s(new r)},i))})}},function(e,t,n){"use strict";e.exports=function(){this.promise=new Promise((e,t)=>{this.resolve=e,this.reject=t})}},function(e,t,n){"use strict";const r=n(20);e.exports=function(e){let t,n;const i=e.indexOf("/");-1!==i&&(n=e.slice(i+1),e=e.slice(0,i));const o=e.indexOf("@");return-1!==o&&(t=e.slice(0,o),e=e.slice(o+1)),new r(t,e,n)}},function(e,t,n){"use strict";const r=n(14);function i(e,t){!1!==t&&null!=t&&(t instanceof r?e.append(t):Array.isArray(t)?t.forEach(t=>i(e,t)):e.append(String(t)))}e.exports=function(e,t,...n){const o=new r(e,t);for(let e=0;e<n.length;e++)i(o,n[e]);return o}},function(e,t,n){"use strict";var r=n(15),i=r.escapeXML,o=r.escapeXMLText,s=n(49),a=s.equal,c=s.name,u=s.attrs,l=s.children,d=n(50);function f(e,t){this.name=e,this.parent=null,this.children=[],this.attrs={},this.setAttrs(t)}f.prototype.is=function(e,t){return this.getName()===e&&(!t||this.getNS()===t)},f.prototype.getName=function(){return this.name.indexOf(":")>=0?this.name.substr(this.name.indexOf(":")+1):this.name},f.prototype.getNS=function(){if(this.name.indexOf(":")>=0){var e=this.name.substr(0,this.name.indexOf(":"));return this.findNS(e)}return this.findNS()},f.prototype.findNS=function(e){if(e){var t="xmlns:"+e;if(this.attrs[t])return this.attrs[t];if(this.parent)return this.parent.findNS(e)}else{if(this.attrs.xmlns)return this.attrs.xmlns;if(this.parent)return this.parent.findNS()}},f.prototype.getXmlns=function(){var e={};for(var t in this.parent&&(e=this.parent.getXmlns()),this.attrs){var n=t.match("xmlns:?(.*)");this.attrs.hasOwnProperty(t)&&n&&(e[this.attrs[t]]=n[1])}return e},f.prototype.setAttrs=function(e){"string"==typeof e?this.attrs.xmlns=e:e&&Object.keys(e).forEach((function(t){this.attrs[t]=e[t]}),this)},f.prototype.getAttr=function(e,t){if(!t)return this.attrs[e];var n=this.getXmlns();return n[t]?this.attrs[[n[t],e].join(":")]:null},f.prototype.getChild=function(e,t){return this.getChildren(e,t)[0]},f.prototype.getChildren=function(e,t){for(var n=[],r=0;r<this.children.length;r++){var i=this.children[r];!i.getName||i.getName()!==e||t&&i.getNS()!==t||n.push(i)}return n},f.prototype.getChildByAttr=function(e,t,n,r){return this.getChildrenByAttr(e,t,n,r)[0]},f.prototype.getChildrenByAttr=function(e,t,n,r){for(var i=[],o=0;o<this.children.length;o++){var s=this.children[o];!s.attrs||s.attrs[e]!==t||n&&s.getNS()!==n||i.push(s),r&&s.getChildrenByAttr&&i.push(s.getChildrenByAttr(e,t,n,!0))}return r&&(i=[].concat.apply([],i)),i},f.prototype.getChildrenByFilter=function(e,t){for(var n=[],r=0;r<this.children.length;r++){var i=this.children[r];e(i)&&n.push(i),t&&i.getChildrenByFilter&&n.push(i.getChildrenByFilter(e,!0))}return t&&(n=[].concat.apply([],n)),n},f.prototype.getText=function(){for(var e="",t=0;t<this.children.length;t++){var n=this.children[t];"string"!=typeof n&&"number"!=typeof n||(e+=n)}return e},f.prototype.getChildText=function(e,t){var n=this.getChild(e,t);return n?n.getText():null},f.prototype.getChildElements=function(){return this.getChildrenByFilter((function(e){return e instanceof f}))},f.prototype.root=function(){return this.parent?this.parent.root():this},f.prototype.tree=f.prototype.root,f.prototype.up=function(){return this.parent?this.parent:this},f.prototype.c=function(e,t){return this.cnode(new f(e,t))},f.prototype.cnode=function(e){return this.children.push(e),"object"==typeof e&&(e.parent=this),e},f.prototype.t=function(e){return this.children.push(e),this},f.prototype.remove=function(e,t){var n;return n="string"==typeof e?function(n){return!(n.is&&n.is(e,t))}:function(t){return t!==e},this.children=this.children.filter(n),this},f.prototype.clone=function(){return d(this)},f.prototype.text=function(e){return e&&1===this.children.length?(this.children[0]=e,this):this.getText()},f.prototype.attr=function(e,t){return void 0!==t||null===t?(this.attrs||(this.attrs={}),this.attrs[e]=t,this):this.attrs[e]},f.prototype.toString=function(){var e="";return this.write((function(t){e+=t})),e},f.prototype.toJSON=function(){return{name:this.name,attrs:this.attrs,children:this.children.map((function(e){return e&&e.toJSON?e.toJSON():e}))}},f.prototype._addChildren=function(e){e(">");for(var t=0;t<this.children.length;t++){var n=this.children[t];(n||0===n)&&(n.write?n.write(e):"string"==typeof n?e(o(n)):n.toString&&e(o(n.toString(10))))}e("</"),e(this.name),e(">")},f.prototype.write=function(e){for(var t in e("<"),e(this.name),this.attrs){var n=this.attrs[t];null!=n&&(e(" "),e(t),e('="'),"string"!=typeof n&&(n=n.toString()),e(i(n)),e('"'))}0===this.children.length?e("/>"):this._addChildren(e)},f.prototype.nameEquals=function(e){return c(this,e)},f.prototype.attrsEquals=function(e){return u(this,e)},f.prototype.childrenEquals=function(e){return l(this,e)},f.prototype.equals=function(e){return a(this,e)},e.exports=f},function(e,t,n){"use strict";function r(e,t){return e.name===t.name}function i(e,t){var n=e.attrs,r=Object.keys(n),i=r.length;if(i!==Object.keys(t.attrs).length)return!1;for(var o=0,s=i;o<s;o++){var a=r[o],c=n[a];if(null==c||null==t.attrs[a]){if(c!==t.attrs[a])return!1}else if(c.toString()!==t.attrs[a].toString())return!1}return!0}function o(e,t){var n=e.children,r=n.length;if(r!==t.children.length)return!1;for(var i=0,o=r;i<o;i++){var s=n[i];if("string"==typeof s){if(s!==t.children[i])return!1}else if(!s.equals(t.children[i]))return!1}return!0}e.exports.name=r,e.exports.attrs=i,e.exports.children=o,e.exports.equal=function(e,t){return!!r(e,t)&&(!!i(e,t)&&!!o(e,t))}},function(e,t,n){"use strict";e.exports=function(e){for(var t=new e.constructor(e.name,e.attrs),n=0;n<e.children.length;n++){var r=e.children[n];t.cnode(r.clone?r.clone():r)}return t}},function(e,t,n){"use strict";var r=n(52),i=n(10).EventEmitter,o=n(15).unescapeXML,s=e.exports=function(){i.call(this);var e,t,n,r,s,a,c,u,l=0,d=0;this._handleTagOpening=function(e,t,n){e?this.emit("endElement",t):(this.emit("startElement",t,n),s&&this.emit("endElement",t))},this.write=function(i){"string"!=typeof i&&(i=i.toString());var f=0;function h(){if("number"==typeof d){var e=i.substring(d,f);return d=void 0,e}}for(e&&(i=e+i,f+=e.length,e=null);f<i.length;f++){if(0===l){var p=i.indexOf("<",f);-1!==p&&f!==p&&(f=p)}else if(8===l){var m=i.indexOf(c,f);-1!==m&&(f=m)}else if(1===l){var g=i.indexOf("--\x3e",f);-1!==g&&(f=g+2)}else if(10===l){var v=i.indexOf("]]>",f);-1!==v&&(f=v+2)}var y=i.charCodeAt(f);switch(l){case 0:if(60===y){var b=h();b&&this.emit("text",o(b)),l=3,d=f+1,n={}}break;case 9:if(93===y&&"]>"===i.substr(f+1,2)){var w=h();w&&this.emit("text",w),l=0}break;case 3:47===y&&d===f?(d=f+1,r=!0):33===y?"[CDATA["===i.substr(f+1,7)?(d=f+8,l=9):(d=void 0,l=1):63===y?(d=void 0,l=2):(y<=32||47===y||62===y)&&(t=h(),f--,l=4);break;case 1:if(62===y){var S=i.charCodeAt(f-1),C=i.charCodeAt(f-2);(45===S&&45===C||93===S&&93===C)&&(l=0)}break;case 2:if(62===y)63===i.charCodeAt(f-1)&&(l=0);break;case 4:62===y?(this._handleTagOpening(r,t,n),t=void 0,n=void 0,r=void 0,s=void 0,l=0,d=f+1):47===y?s=!0:y>32&&(d=f,l=5);break;case 5:(y<=32||61===y)&&(u=h(),f--,l=6);break;case 6:61===y&&(l=7);break;case 7:34!==y&&39!==y||(a=y,c=34===y?'"':"'",l=8,d=f+1);break;case 8:if(y===a){var k=o(h());n[u]=k,u=void 0,l=4}}}"number"==typeof d&&d<=i.length&&(e=i.slice(d),d=0)}};r(s,i),s.prototype.end=function(e){e&&this.write(e),this.write=function(){}}},function(e,t){"function"==typeof Object.create?e.exports=function(e,t){t&&(e.super_=t,e.prototype=Object.create(t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}))}:e.exports=function(e,t){if(t){e.super_=t;var n=function(){};n.prototype=t.prototype,e.prototype=new n,e.prototype.constructor=e}}},function(e,t,n){"use strict";const r=n(16);e.exports=class extends r{constructor(...e){super(...e),this.name="StreamError"}}},function(e,t,n){"use strict";function r(e){let{port:t,hostname:n,protocol:r}=new URL(e);return"[::1]"===n&&(n="::1"),{port:t,hostname:n,protocol:r}}function i(e){const{port:t,hostname:n}=r(`http://${e}`);return{port:t,hostname:n}}Object.assign(e.exports,{parseURI:r,parseHost:i,parseService:function(e){return e.includes("://")?r(e):i(e)}})},function(e,t,n){"use strict";e.exports=function(e){return(e.split("://")[1]||e).split(":")[0].split("/")[0]}},function(e,t,n){"use strict";const{EventEmitter:r}=n(9);class i extends r{constructor(e){super(),this.delay=1e3,this.entity=e,this._timeout=null}scheduleReconnect(){const{entity:e,delay:t,_timeout:n}=this;clearTimeout(n),this._timeout=setTimeout(async()=>{if("disconnect"===e.status)try{await this.reconnect()}catch(e){}},t)}async reconnect(){const{entity:e}=this;this.emit("reconnecting");const{service:t,domain:n,lang:r}=e.options;await e.connect(t),await e.open({domain:n,lang:r}),this.emit("reconnected")}start(){const{entity:e}=this,t={};t.disconnect=()=>{this.scheduleReconnect()},this.listeners=t,e.on("disconnect",t.disconnect)}stop(){const{entity:e,listeners:t,_timeout:n}=this;e.removeListener("disconnect",t.disconnect),clearTimeout(n)}}e.exports=function({entity:e}){const t=new i(e);return t.start(),t}},function(e,t,n){"use strict";const r=n(58);e.exports=function({entity:e}){e.transports.push(r)}},function(e,t,n){"use strict";const r=n(59),i=n(18),o=n(3),s=n(61),a="urn:ietf:params:xml:ns:xmpp-framing";class c extends i{send(e,...t){return!e.attrs.xmlns&&super.isStanza(e)&&(e.attrs.xmlns="jabber:client"),super.send(e,...t)}footerElement(){return new o.Element("close",{xmlns:a})}headerElement(){const e=super.headerElement();return e.name="open",e.attrs.xmlns=a,e}socketParameters(e){return e.match(/^wss?:\/\//)?e:void 0}}c.prototype.Socket=r,c.prototype.NS="jabber:client",c.prototype.Parser=s,e.exports=c},function(e,t,n){"use strict";(function(t){const r=n(60),i=t.WebSocket||r,o=n(10),s="ECONNERROR";e.exports=class extends o{constructor(){super(),this.listeners=Object.create(null)}connect(e){this.url=e,this._attachSocket(new i(e,["xmpp"]))}_attachSocket(e){const t=this.socket=e,{listeners:n}=this;n.open=()=>{this.emit("connect")},n.message=({data:e})=>this.emit("data",e),n.error=e=>{let{error:t}=e;t||(t=new Error(`WebSocket ${s} ${this.url}`),t.errno=s,t.code=s),t.event=e,t.url=this.url,this.emit("error",t)},n.close=e=>{this._detachSocket(),this.emit("close",!e.wasClean,e)},t.addEventListener("open",n.open),t.addEventListener("message",n.message),t.addEventListener("error",n.error),t.addEventListener("close",n.close)}_detachSocket(){delete this.url;const{socket:e,listeners:t}=this;Object.getOwnPropertyNames(t).forEach(n=>{e.removeEventListener(n,t[n]),delete t[n]}),delete this.socket}end(){this.socket.close()}write(e,t){i===r?this.socket.send(e,t):(this.socket.send(e),t())}}}).call(this,n(7))},function(e,t){},function(e,t,n){"use strict";const{Parser:r,Element:i,XMLError:o}=n(3);e.exports=class extends r{onStartElement(e,t){const n=new i(e,t),{cursor:r}=this;r&&r.append(n),this.cursor=n}onEndElement(e){const{cursor:t}=this;e===t.name?t.parent?this.cursor=t.parent:(t.is("open","urn:ietf:params:xml:ns:xmpp-framing")?this.emit("start",t):t.is("close","urn:ietf:params:xml:ns:xmpp-framing")?this.emit("end",t):this.emit("element",t),this.cursor=null):this.emit("error",new o(`${t.name} must be closed.`))}}},function(e,t,n){"use strict";const r=n(63),i=n(64),o=n(65);function s(e,t,n){return function(i){const o=new n(e,i);return r(t)(o)}}function a(e){return function(t,n){n().then(t=>t&&e.send(t)).catch(t=>e.emit("error",t))}}e.exports=function({entity:e}){const t=[a(e)],n=[],r=s(e,t,i),c=s(e,n,o);return e.on("element",r),e.hookOutgoing=c,{use:e=>(t.push(e),e),filter:e=>(n.push(e),e)}}},function(e,t,n){"use strict";e.exports=function(e){if(!Array.isArray(e))throw new TypeError("Middleware stack must be an array!");for(const t of e)if("function"!=typeof t)throw new TypeError("Middleware must be composed of functions!");return function(t,n){let r=-1;return function i(o){if(o<=r)return Promise.reject(new Error("next() called multiple times"));r=o;let s=e[o];o===e.length&&(s=n);if(!s)return Promise.resolve();try{return Promise.resolve(s(t,i.bind(null,o+1)))}catch(e){return Promise.reject(e)}}(0)}}},function(e,t,n){"use strict";const r=n(24),i=n(11);e.exports=class extends r{constructor(e,t){super(e,t);const{jid:n,domain:r}=e,o=t.attrs.to||n&&n.toString(),s=t.attrs.from||r;o&&(this.to=new i(o)),s&&(this.from=new i(s),this.local=this.from.local,this.domain=this.from.domain,this.resource=this.from.resource)}}},function(e,t,n){"use strict";const r=n(24),i=n(11);e.exports=class extends r{constructor(e,t){super(e,t);const{jid:n,domain:r}=e,o=t.attrs.from||n&&n.toString(),s=t.attrs.to||r;o&&(this.from=new i(o)),s&&(this.to=new i(s),this.local=this.to.local,this.domain=this.to.domain,this.resource=this.to.resource)}}},function(e,t,n){"use strict";const r=n(67);e.exports=function({middleware:e}){return e.use(r()),{use:function(t,n,r){return e.use((e,i)=>{const{stanza:o}=e;if(!o.is("features","http://etherx.jabber.org/streams"))return i();const s=o.getChild(t,n);return s?r(e,i,s):i()})}}}},function(e,t,n){"use strict";e.exports=function(){return async function({stanza:e,entity:t},n){if(!e.is("features","http://etherx.jabber.org/streams"))return n();await n(),t.jid&&t._status("online",t.jid)}}},function(e,t,n){"use strict";const r=n(69),i=n(70),{Deferred:o}=n(9),s=n(9).timeout,a=n(3);class c{constructor({entity:e,middleware:t}){this.handlers=new Map,this.entity=e,this.middleware=t}start(){this.middleware.use(this._route.bind(this))}_route({type:e,name:t,id:n,stanza:r},o){if(!function({name:e,type:t}){return"iq"===e&&("error"===t||"result"===t)}({name:t,type:e}))return o();const s=this.handlers.get(n);if(!s)return o();"error"===e?s.reject(i.fromElement(r.getChild("error"))):s.resolve(r),this.handlers.delete(n)}async request(e,t=3e4){e.attrs.id||(e.attrs.id=r());const n=new o;this.handlers.set(e.attrs.id,n);try{await this.entity.send(e),await s(n.promise,t)}catch(t){throw this.handlers.delete(e.attrs.id),t}return n.promise}_childRequest(e,t,n,...r){const{name:i}=t,{xmlns:o}=t.attrs;return this.request(a("iq",{type:e,to:n},t),...r).then(e=>e.getChild(i,o))}async get(...e){return this._childRequest("get",...e)}async set(...e){return this._childRequest("set",...e)}}e.exports=function(...e){const t=new c(...e);return t.start(),t}},function(e,t,n){"use strict";e.exports=function(){let e;for(;!e;)e=Math.random().toString(36).slice(2,12);return e}},function(e,t,n){"use strict";const r=n(16);e.exports=class extends r{constructor(e,t,n,r){super(e,t,n),this.type=r,this.name="StanzaError"}static fromElement(e){const t=super.fromElement(e);return t.type=e.attrs.type,t}}},function(e,t,n){"use strict";const r=n(3);function i({stanza:e}){return r("iq",{to:e.attrs.from,from:e.attrs.to,id:e.attrs.id})}function o(e,t,n){const r=i(e);return r.attrs.type="error",n&&r.append(n),r.append(t),r}function s(e,t){return r("error",{type:e},r(t,"urn:ietf:params:xml:ns:xmpp-stanzas"))}function a(e){return async function(t,n){if(!function({name:e,type:t}){return"iq"===e&&("error"!==t&&"result"!==t)}(t))return n();const{stanza:a}=t,c=a.getChildElements(),[u]=c;if(!function({type:e},t,n){return("get"===e||"set"===e)&&(1===t.length&&!!n)}(t,c,u))return o(t,s("modify","bad-request"),u);let l;t.element=u;try{l=await n()}catch(t){e.emit("error",t),l=s("cancel","internal-server-error")}return l||(l=s("cancel","service-unavailable")),l instanceof r.Element&&l.is("error")?o(t,l,u):function(e,t){const n=i(e);return n.attrs.type="result",t&&n.append(t),n}(t,l instanceof r.Element?l:void 0)}}function c(e,t,n,r){return function(i,o){return i.type!==e|!i.element||!i.element.is(n,t)?o():r(i,o)}}e.exports=function({middleware:e,entity:t}){return e.use(a(t)),{get(t,n,r){e.use(c("get",t,n,r))},set(t,n,r){e.use(c("set",t,n,r))}}}},function(e,t,n){"use strict";const r=n(73),{promise:i}=n(9);e.exports=function({entity:e}){const t=e.connect;e.connect=async function(n){if(!n||n.match(/:\/\//))return t.call(this,n);const o=function(e,t){return t.filter(t=>e._findTransport(t))}(e,await async function(e){return[...new Set((await r(e,{srv:[{service:"xmpps-client",protocol:"tcp"},{service:"xmpp-client",protocol:"tcp"}]})).map(e=>e.uri))]}(n));if(0===o.length)throw new Error("No compatible transport found.");try{await async function e(t,n){if(0===n.length)throw new Error("Couldn't connect");const r=n.shift(),o=t._findTransport(r);if(!o)return e(t,n);t._status("connecting",r);const s=o.prototype.socketParameters(r),a=new o.prototype.Socket;try{a.connect(s),await i(a,"connect")}catch(r){return e(t,n)}t._attachSocket(a),a.emit("connect"),t.Transport=o,t.Socket=o.prototype.Socket,t.Parser=o.prototype.Parser}(e,o)}catch(t){throw e._reset(),e._status("disconnect"),t}}}},function(e,t,n){"use strict";const r=n(74),i=n(75);e.exports=function(...e){return Promise.all([r.resolve?r.resolve(...e):Promise.resolve([]),i.resolve(...e)]).then(([e,t])=>e.concat(t))},r.resolve&&(e.exports.dns=r),e.exports.http=i},function(e,t){},function(e,t,n){"use strict";(function(t){const r=t.fetch||n(25),i=n(76),o=n(77).compare;e.exports.resolve=function(e){return r(`https://${e}/.well-known/host-meta`).then(e=>e.text()).then(e=>i(e).getChildren("Link").filter(e=>["urn:xmpp:alt-connections:websocket","urn:xmpp:alt-connections:httppoll","urn:xmpp:alt-connections:xbosh"].includes(e.attrs.rel)).map(({attrs:e})=>({rel:e.rel,href:e.href,method:e.rel.split(":").pop(),uri:e.href})).sort(o)).catch(()=>[])}}).call(this,n(7))},function(e,t,n){"use strict";const r=n(22);e.exports=function(e){const t=new r;let n=null,i=null;if(t.on("start",e=>{n=e}),t.on("element",e=>{n.append(e)}),t.on("error",e=>{i=e}),t.write(e),t.end(),i)throw i;return n}},function(e,t,n){"use strict";function r(e){return e.startsWith("https")||e.startsWith("wss")}e.exports.compare=function(e,t){let n,i;return n=r(e.uri)&&!r(t.uri)?-1:!r(e.uri)&&r(t.uri)?1:0,0!==n?n:(i=e.method===t.method?0:"websocket"===e.method?-1:"websocket"===t.method?1:"xbosh"===e.method?-1:"xbosh"===t.method?1:"httppoll"===e.method?-1:"httppoll"===t.method?1:0,0!==i?i:0)}},function(e,t,n){"use strict";const{encode:r,decode:i}=n(79),o=n(80),s=n(3),a=n(81),c="urn:ietf:params:xml:ns:xmpp-sasl";async function u(e,t,n,a){const u=e.create([n]);if(!u)throw new Error("No compatible mechanism");const{domain:l}=t.options,d={username:null,password:null,server:l,host:l,realm:l,serviceType:"xmpp",serviceName:l,...a};return new Promise((e,n)=>{const a=l=>{if(l.attrs.xmlns===c)if("challenge"!==l.name)"failure"===l.name?n(o.fromElement(l)):"success"===l.name&&e(),t.removeListener("nonza",a);else{u.challenge(i(l.text()));const e=u.response(d);t.send(s("response",{xmlns:c,mechanism:u.name},"string"==typeof e?r(e):""))}};t.on("nonza",a),u.clientFirst&&t.send(s("auth",{xmlns:c,mechanism:u.name},r(u.response(d))))})}e.exports=function({streamFeatures:e},t){const n=new a;return e.use("mechanisms",c,async({stanza:e,entity:r})=>{const i=e.getChild("mechanisms",c).children.map(e=>e.text());let o=n._mechs.map(({name:e})=>e).filter(e=>i.includes(e))[0];"function"==typeof t?await t(e=>u(n,r,o,e),o):(t.username||t.password||(o="ANONYMOUS"),await u(n,r,o,t)),await r.restart()}),{use:(...e)=>n.use(...e)}}},function(e,t,n){"use strict";(function(t){e.exports.encode=function(e){return t.btoa(e)},e.exports.decode=function(e){return t.atob(e)}}).call(this,n(7))},function(e,t,n){"use strict";const r=n(16);e.exports=class extends r{constructor(...e){super(...e),this.name="SASLError"}}},function(e,t,n){(function(e){!function(e,t,n){(t.exports=n).Factory=n}(0,e,n(82))}).call(this,n(6)(e))},function(e,t,n){(function(e){!function(e,t){function n(){this._mechs=[]}n.prototype.use=function(e,t){return t||(e=(t=e).prototype.name),this._mechs.push({name:e,mech:t}),this},n.prototype.create=function(e){for(var t=0,n=this._mechs.length;t<n;t++)for(var r=0,i=e.length;r<i;r++){var o=this._mechs[t];if(o.name==e[r])return new o.mech}return null},t.exports=n}(0,e)}).call(this,n(6)(e))},function(e,t,n){"use strict";const r=n(3),i="urn:ietf:params:xml:ns:xmpp-bind";async function o(e,t,n){const o=(await t.set(function(e){return r("bind",{xmlns:i},e&&r("resource",{},e))}(n))).getChildText("jid");return e._jid(o),o}e.exports=function({streamFeatures:e,iqCaller:t},n){e.use("bind",i,function({iqCaller:e},t){return async function({entity:n},r){"function"==typeof t?await t(t=>o(n,e,t)):await o(n,e,t),r()}}({iqCaller:t},n))}},function(e,t,n){"use strict";const r=n(3),i="urn:ietf:params:xml:ns:xmpp-session";e.exports=function({iqCaller:e,streamFeatures:t}){t.use("session",i,async(t,n,o)=>o.getChild("optional")?n():(await e.set(r("session",i)),n()))}},function(e,t,n){"use strict";const r=n(86);e.exports=function(e){e.use(r)}},function(e,t,n){(function(e){!function(e,t,n){(t.exports=n).Mechanism=n}(0,e,n(87))}).call(this,n(6)(e))},function(e,t,n){(function(e){!function(e,t){function n(){}n.prototype.name="ANONYMOUS",n.prototype.clientFirst=!0,n.prototype.response=function(e){return e.trace||""},n.prototype.challenge=function(e){},t.exports=n}(0,e)}).call(this,n(6)(e))},function(e,t,n){"use strict";const r=n(89);e.exports=function(e){e.use(r)}},function(e,t,n){(function(e){!function(e,t,n){(t.exports=n).Mechanism=n}(0,e,n(90))}).call(this,n(6)(e))},function(e,t,n){(function(e){!function(e,t){function n(){}n.prototype.name="PLAIN",n.prototype.clientFirst=!0,n.prototype.response=function(e){var t="";return t+=e.authzid||"",t+="\0",t+=e.username,t+="\0",t+=e.password},n.prototype.challenge=function(e){return this},t.exports=n}(0,e)}).call(this,n(6)(e))},function(e,n){e.exports=t},function(e,t,n){function r(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var i=n(1),o=n(0),s=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.proxy=t,this.webSessionCheckInterval=null}var t,n,s;return t=e,(n=[{key:"getSession",value:function(){var e=this,t={type:"GET",url:o.getUrl(i.urls.session)};return new Promise((function(n,r){e.proxy.ajax(t).then((function(e){n(e.session)})).catch((function(e){r(e)}))}))}},{key:"createSession",value:function(e){var t=this;if(""===i.creds.appId||""===i.creds.authKey||""===i.creds.authSecret)throw new Error("Cannot create a new session without app credentials (app ID, auth key and auth secret)");var n=e&&e.hasOwnProperty("long")?i.urls.webSession:i.urls.session,r=o.generateCreateSessionParams(e);r.signature=o.signParams(r,i.creds.authSecret);var s={type:"POST",url:o.getUrl(n),data:r};return new Promise((function(e,n){t.proxy.ajax(s).then((function(n){var r=n.qr_code?n.qr_code:n.session;t.proxy.setSession(n.session),t.proxy.setCurrentUserId(n.session.user_id),e(r)})).catch((function(e){console.log("error",e),n(e)}))}))}},{key:"destroySession",value:function(){var e=this,t={type:"DELETE",url:o.getUrl(i.urls.session),dataType:"text"};return new Promise((function(n,r){e.proxy.ajax(t).then((function(t){e.proxy.setSession(null),e.proxy.setCurrentUserId(null),n()})).catch((function(e){r(e)}))}))}},{key:"createWebSession",value:function(e){return e||(e={long:0}),this.createSession(e)}},{key:"checkWebSessionUntilUpgrade",value:function(e){var t=this,n=i.webSession.getSessionTimeInterval,r=new Error("The web session check interval was stopped (timeout)"),o=i.webSession.getSessionTimeout,s=function(){t.webSessionCheckInterval&&clearInterval(t.webSessionCheckInterval)};return s(),this.webSessionCheckInterval=setInterval((function(){t.getSession().then((function(i){0!==i.user_id?(s(),t.proxy.setCurrentUserId(i.user_id),t.proxy.setSession(i),e(null,i)):o>n?o-=n:(s(),e(r,null))})).catch((function(t){s(),e(t,null)}))}),1e3*n),this.webSessionCheckInterval}},{key:"upgradeWebSession",value:function(e){var t={type:"PATCH",url:o.getUrl(i.urls.webSession),dataType:"text",data:{web_token:e}};return this.proxy.ajax(t)}},{key:"login",value:function(e){var t=this,n={type:"POST",url:o.getUrl(i.urls.login),data:e};return new Promise((function(e,r){t.proxy.ajax(n).then((function(n){t.proxy.setCurrentUserId(n.user.id),e(n.user)})).catch((function(e){r(e)}))}))}},{key:"logout",value:function(){var e={type:"DELETE",url:o.getUrl(i.urls.login),dataType:"text"};return this.proxy.setCurrentUserId(null),this.proxy.ajax(e)}}])&&r(t.prototype,n),s&&r(t,s),e}();e.exports=s},function(e,t,n){function r(e){return(r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function i(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var o=n(1),s=n(0),a=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.proxy=t}var t,n,r;return t=e,(n=[{key:"get",value:function(e){var t,n,r,i,a=[];e.order&&(e.order=(r=e.order,i=r.field in c?"date":r.field in u?"number":"string",[r.sort,i,r.field].join(" "))),e&&e.filter&&(s.isArray(e.filter)?e.filter.forEach((function(e){n=l(e),a.push(n)})):(n=l(e.filter),a.push(n)),e.filter=a),"number"==typeof e?(t=e,e={}):e.login?t="by_login":e.full_name?t="by_full_name":e.facebook_id?t="by_facebook_id":e.twitter_id?t="by_twitter_id":e.phone?t="phone":e.email?t="by_email":e.tags?t="by_tags":e.external&&(t="external/"+e.external,e={});var d={type:"GET",url:s.getUrl(o.urls.users,t),data:e};return this.proxy.ajax(d)}},{key:"signup",value:function(e){var t={type:"POST",url:s.getUrl(o.urls.users),data:{user:e}};return this.proxy.ajax(t)}},{key:"update",value:function(e){var t={type:"PUT",url:s.getUrl(o.urls.users,this.proxy.getCurrentUserId()),data:{user:e}};return this.proxy.ajax(t)}},{key:"delete",value:function(){var e={type:"DELETE",url:s.getUrl(o.urls.users,this.proxy.getCurrentUserId()),dataType:"text"};return this.proxy.ajax(e)}},{key:"resetPassword",value:function(e){var t={type:"GET",url:s.getUrl(o.urls.users+"/password/reset"),data:{email:e},dataType:"text"};return this.proxy.ajax(t)}}])&&i(t.prototype,n),r&&i(t,r),e}();e.exports=a;var c=["created_at","updated_at","last_request_at"],u=["id","external_user_id"];function l(e){var t=e.field in c?"date":r(e.value);return s.isArray(e.value)&&("object"===t&&(t=r(e.value[0])),e.value=e.value.toString()),[t,e.field,e.param,e.value].join(" ")}},function(e,t,n){function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var s=n(1),a=n(0),c=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.proxy=t}var t,n,c;return t=e,(n=[{key:"list",value:function(e){var t={type:"GET",url:a.getUrl(s.urls.blobs),data:e};return this.proxy.ajax(t)}},{key:"create",value:function(e){var t={type:"POST",url:a.getUrl(s.urls.blobs),data:{blob:e}};return this.proxy.ajax(t)}},{key:"delete",value:function(e){var t={type:"DELETE",url:a.getUrl(s.urls.blobs,e),dataType:"text"};return this.proxy.ajax(t)}},{key:"createAndUpload",value:function(e){var t,n,o,s,a,c,l=this,d={};return JSON.parse(JSON.stringify(e)).file.data="...",t=e.file,n=e.name||t.name,o=e.type||t.type,s=e.size||t.size,d.name=n,d.content_type=o,e.public&&(d.public=e.public),this.create(d).then((function(e){var n=e.blob,o=u(n.blob_object_access.params),d={url:o.protocol+"://"+o.authority+o.path},f={};return a=n.id,c=function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}({},n,{size:s}),Object.keys(o.queryKey).forEach((function(e){f[e]=decodeURIComponent(o.queryKey[e])})),f.file=t,d.data=f,l.upload(d)})).then((function(e){var t={id:a,size:s};return l.markUploaded(t)})).then((function(){return c}))}},{key:"upload",value:function(e){var t={type:"POST",url:e.url,dataType:"text",contentType:!1,data:e.data};return this.proxy.ajax(t)}},{key:"markUploaded",value:function(e){var t={type:"PUT",url:a.getUrl(s.urls.blobs,e.id+"/complete"),data:{size:e.size},dataType:"text"};return this.proxy.ajax(t)}},{key:"getInfo",value:function(e){var t={url:a.getUrl(s.urls.blobs,e)};return this.proxy.ajax(t)}},{key:"getFile",value:function(e){var t={url:a.getUrl(s.urls.blobs,e)};return this.proxy.ajax(t)}},{key:"update",value:function(e){var t={blob:{}};void 0!==e.name&&(t.blob.name=e.name);var n={url:a.getUrl(s.urls.blobs,e.id),data:t};return this.proxy.ajax(n)}},{key:"privateUrl",value:function(e){return"https://"+s.endpoints.api+"/blobs/"+e+"?token="+this.proxy.getSession().token}},{key:"publicUrl",value:function(e){return"https://"+s.endpoints.api+"/blobs/"+e}}])&&o(t.prototype,n),c&&o(t,c),e}();function u(e){for(var t=u.options,n=t.parser[t.strictMode?"strict":"loose"].exec(e),r={},i=14;i--;)r[t.key[i]]=n[i]||"";return r[t.q.name]={},r[t.key[12]].replace(t.q.parser,(function(e,n,i){n&&(r[t.q.name][n]=i)})),r}e.exports=c,u.options={strictMode:!1,key:["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"],q:{name:"queryKey",parser:/(?:^|&)([^&=]*)=?([^&]*)/g},parser:{strict:/^(?:([^:\/?#]+):)?(?:\/\/((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?))?((((?:[^?#\/]*\/)*)([^?#]*))(?:\?([^#]*))?(?:#(.*))?)/,loose:/^(?:(?![^:@]+:[^:@\/]*@)([^:\/?#.]+):)?(?:\/\/)?((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/}}},function(e,t,n){function r(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function i(e,t,n){return t&&r(e.prototype,t),n&&r(e,n),e}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var s=n(1),a=n(0),c=function(){function e(t){o(this,e),this.proxy=t}return i(e,[{key:"create",value:function(e){var t={type:"POST",url:a.getUrl(s.urls.subscriptions),data:e};return this.proxy.ajax(t)}},{key:"list",value:function(){var e={type:"GET",url:a.getUrl(s.urls.subscriptions)};return this.proxy.ajax(e)}},{key:"delete",value:function(e){var t={type:"DELETE",dataType:"text",url:a.getUrl(s.urls.subscriptions,e)};return this.proxy.ajax(t)}}]),e}(),u=function(){function e(t){o(this,e),this.proxy=t}return i(e,[{key:"create",value:function(e){var t={type:"POST",url:a.getUrl(s.urls.events),data:{event:e}};return this.proxy.ajax(t)}}]),e}();e.exports=function e(t){o(this,e),this.proxy=t,this.subscriptions=new c(t),this.events=new u(t),this.base64Encode=function(e){return a.toBase64(e)}}},function(e,t,n){function r(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var i=n(1),o=n(0),s=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.proxy=t}var t,n,s;return t=e,(n=[{key:"create",value:function(e,t){var n={type:"POST",data:t,url:o.getUrl(i.urls.data,e)};return this.proxy.ajax(n)}},{key:"list",value:function(e,t){var n={url:o.getUrl(i.urls.data,e),data:t};return this.proxy.ajax(n)}},{key:"update",value:function(e,t){var n={type:"PUT",url:o.getUrl(i.urls.data,e+"/"+t._id),data:t};return this.proxy.ajax(n)}},{key:"delete",value:function(e,t){var n,r=1,s=2,a=3,c={type:"DELETE"};return"string"==typeof t?n=r:o.isArray(t)?n=s:o.isObject(t)&&(n=a),n===r?(c.url=o.getUrl(i.urls.data,e+"/"+t),c.dataType="text"):n===s?c.url=o.getUrl(i.urls.data,e+"/"+t.toString()):n===a&&(c.url=o.getUrl(i.urls.data,e+"/by_criteria"),c.data=t),this.proxy.ajax(c)}}])&&r(t.prototype,n),s&&r(t,s),e}();e.exports=s},function(e,t,n){function r(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var i=n(0),o=n(1),s=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.proxy=t}var t,n,s;return t=e,(n=[{key:"uploadAddressBook",value:function(e,t){if(i.isArray(e)){var n={contacts:e};t&&(t.force&&(n.force=t.force),t.udid&&(n.udid=t.udid));var r={type:"POST",url:i.getUrl(o.urls.addressbook),data:n};return this.proxy.ajax(r)}new Error("First parameter must be an Array.")}},{key:"get",value:function(e){var t={type:"GET",url:i.getUrl(o.urls.addressbook)};return e&&(t.data={udid:e}),this.proxy.ajax(t)}},{key:"getRegisteredUsers",value:function(e){var t={type:"GET",url:i.getUrl(o.urls.addressbookRegistered)};return e&&(t.data={compact:1}),this.proxy.ajax(t)}}])&&r(t.prototype,n),s&&r(t,s),e}();e.exports=s},function(e,t,n){function r(e){throw new Error('"'+e+'" is read-only')}function i(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var o=n(1),s=n(0),a=n(5),c=n(99),u=n(100),l=n(101),d=n(102),f=n(103),h=n(2).XMPPClient,p=function(){function e(t){var n=this;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.proxy=t,this.xmppClient=h.client({service:o.chatProtocol.websocket,credentials:function(e,t){return e({username:n.xmppClient.options.username,password:n.xmppClient.options.password})}}),this.webrtcSignalingProcessor=null,this.stanzasCallbacks={},this.isConnected=!1,this._isConnecting=!1,this._isLogout=!1,this._checkConnectionTimer=void 0,this.helpers=new c,this.xmppClientListeners=[];var r={xmppClient:this.xmppClient,helpers:this.helpers,stanzasCallbacks:this.stanzasCallbacks};this.contactList=new l(r),this.privacylist=new d(r),this.muc=new f(r),o.chat.streamManagement.enable&&2===o.chatProtocol.active&&(this.streamManagement=new u,this._sentMessageCallback=function(e,t){"function"==typeof n.onSentMessageCallback&&(t?n.onSentMessageCallback(null,t):n.onSentMessageCallback(e))})}var t,n,p;return t=e,(n=[{key:"connect",value:function(e){var t=this;return new Promise((function(n,r){s.DLog("[Chat]","Connect with parameters ",e),a.buildUserJid(e);var i="function"==typeof callback;if(t._isConnecting)i&&r({code:422,info:"Already in CONNECTING state"});else{if(t.isConnected)return s.DLog("[Chat]","CONNECTED - You are already connected"),void(i&&n());t._isConnecting=!0,t._isLogout=!1,t.xmppClientListeners.forEach((function(e){t.xmppClient.removeListener(e.name,e.callback)}));var o=function(){s.DLog("[Chat]","CONNECTING")};t.xmppClient.on("connect",o),t.xmppClientListeners.push({name:"connect",callback:o});var c=function(e){s.DLog("[Chat]","ONLINE"),t._postConnectActions(i),n()};t.xmppClient.on("online",c),t.xmppClientListeners.push({name:"online",callback:c});var u=function(){s.DLog("[Chat]","OFFLINE")};t.xmppClient.on("offline",u),t.xmppClientListeners.push({name:"offline",callback:u});var l=function(){s.DLog("[Chat]","DISCONNECTED"),"function"==typeof t.onDisconnectedListener&&s.safeCallbackCall(t.onDisconnectedListener),t.isConnected=!1,t._isConnecting=!1,t._establishConnection(e)};t.xmppClient.on("disconnect",l),t.xmppClientListeners.push({name:"disconnect",callback:l});var d=function(e,t){s.DLog("[Chat]","status",e,t?t.toString():"")};t.xmppClient.on("status",d),t.xmppClientListeners.push({name:"status",callback:d});var f=function(e){e.is("presence")?t._onPresence(e):e.is("iq")?t._onIQ(e):e.is("message")&&("headline"===e.attrs.type?t._onSystemMessageListener(e):"error"===e.attrs.type?t._onMessageErrorListener(e):t._onMessage(e))};t.xmppClient.on("stanza",f),t.xmppClientListeners.push({name:"stanza",callback:f});var h=function(e){s.DLog("[Chat]","ERROR:",e),i&&("SASLError"==e.name&&(e=e.condition),r(e)),t.isConnected=!1,t._isConnecting=!1};t.xmppClient.on("error",h),t.xmppClientListeners.push({name:"error",callback:h});var p=function(e){s.callTrafficUsageCallback("xmppDataWrite",{body:e}),s.DLog("[Chat]","SENT:",e)};t.xmppClient.on("output",p),t.xmppClientListeners.push({name:"output",callback:p});var m=function(e){s.callTrafficUsageCallback("xmppDataRead",{body:e}),s.DLog("[Chat]","RECV:",e)};t.xmppClient.on("input",m),t.xmppClientListeners.push({name:"input",callback:m}),t.xmppClient.options.username=a.buildUserJidLocalPart(e.userId),t.xmppClient.options.password=e.password,t.xmppClient.start()}}))}},{key:"getContacts",value:function(){var e=this;return new Promise((function(t,n){e.contactList.get().then((function(n){e.contactList.contacts=n,t(n)})).catch((function(e){n(n)}))}))}},{key:"send",value:function(e,t){var n={from:this.helpers.getUserCurrentJid(),to:this.helpers.jidOrUserId(e),type:t.type?t.type:"chat",id:t.id?t.id:s.getBsonObjectId()},r=a.createMessageStanza(n);return t.body&&r.c("body",{xmlns:"jabber:client"}).t(t.body).up(),t.markable&&r.c("markable",{xmlns:"urn:xmpp:chat-markers:0"}).up(),t.extension&&(r.c("extraParams",{xmlns:"jabber:client"}),r=a.filledExtraParams(r,t.extension)),o.chat.streamManagement.enable?(t.id=n.id,this.xmppClient.send(r,t)):this.xmppClient.send(r),n.id}},{key:"sendSystemMessage",value:function(e,t){var n={type:"headline",id:t.id?t.id:s.getBsonObjectId(),to:this.helpers.jidOrUserId(e)},r=a.createMessageStanza(n);return t.body&&r.c("body",{xmlns:"jabber:client"}).t(t.body).up(),t.extension&&(r.c("extraParams",{xmlns:"jabber:client"}).c("moduleIdentifier").t("SystemNotifications").up(),r=a.filledExtraParams(r,t.extension)),this.xmppClient.send(r),n.id}},{key:"sendIsTypingStatus",value:function(e){var t={from:this.helpers.getUserCurrentJid(),to:this.helpers.jidOrUserId(e),type:this.helpers.typeChat(e)},n=a.createMessageStanza(t);n.c("composing",{xmlns:"http://jabber.org/protocol/chatstates"}),this.xmppClient.send(n)}},{key:"sendIsStopTypingStatus",value:function(e){var t={from:this.helpers.getUserCurrentJid(),to:this.helpers.jidOrUserId(e),type:this.helpers.typeChat(e)},n=a.createMessageStanza(t);n.c("paused",{xmlns:"http://jabber.org/protocol/chatstates"}),this.xmppClient.send(n)}},{key:"sendDeliveredStatus",value:function(e){var t={type:"chat",from:this.helpers.getUserCurrentJid(),id:s.getBsonObjectId(),to:this.helpers.jidOrUserId(e.userId)},n=a.createMessageStanza(t);n.c("received",{xmlns:"urn:xmpp:chat-markers:0",id:e.messageId}).up(),n.c("extraParams",{xmlns:"jabber:client"}).c("dialog_id").t(e.dialogId),this.xmppClient.send(n)}},{key:"sendReadStatus",value:function(e){var t={type:"chat",from:this.helpers.getUserCurrentJid(),to:this.helpers.jidOrUserId(e.userId),id:s.getBsonObjectId()},n=a.createMessageStanza(t);n.c("displayed",{xmlns:"urn:xmpp:chat-markers:0",id:e.messageId}).up(),n.c("extraParams",{xmlns:"jabber:client"}).c("dialog_id").t(e.dialogId),this.xmppClient.send(n)}},{key:"getLastUserActivity",value:function(e){var t=this;return new Promise((function(n,r){var i={from:t.helpers.getUserCurrentJid(),id:a.getUniqueId("lastActivity"),to:t.helpers.jidOrUserId(e),type:"get"},o=a.createIqStanza(i);o.c("query",{xmlns:"jabber:iq:last"}),t.stanzasCallbacks[i.id]=function(e){var i=a.getElement(e,"error"),o=a.getAttr(e,"from"),c=t.helpers.getUserIdFromJID(o),u=a.getElement(e,"query"),l=+a.getAttr(u,"seconds");s.safeCallbackCall(t.onLastUserActivityListener,c,l),i?r(a.buildErrorFromXMPPErrorStanza(e)):n({userId:c,seconds:l})},t.xmppClient.send(o)}))}},{key:"markActive",value:function(){var e={id:this.helpers.getUniqueId("markActive"),type:"set"},t=a.createIqStanza(e);t.c("mobile",{xmlns:"http://tigase.org/protocol/mobile#v2",enable:"false"}),this.xmppClient.send(t)}},{key:"markInactive",value:function(){var e={id:this.helpers.getUniqueId("markActive"),type:"set"},t=a.createIqStanza(e);t.c("mobile",{xmlns:"http://tigase.org/protocol/mobile#v2",enable:"true"}),this.xmppClient.send(t)}},{key:"disconnect",value:function(){s.DLog("[Chat]","disconnect"),clearInterval(this._checkConnectionTimer),this._checkConnectionTimer=void 0,this.muc.joinedRooms={},this._isLogout=!0,this.helpers.setUserCurrentJid(""),this.xmppClient.stop()}},{key:"search",value:function(e){var t=Object.assign({},e);t.start_date&&(t.start_date=new Date(t.start_date).toISOString()),t.end_date&&(t.end_date=new Date(t.end_date).toISOString()),s.isArray(t.chat_dialog_ids)&&(t.chat_dialog_ids=t.chat_dialog_ids.join(","));var n={type:"GET",url:s.getUrl("".concat(o.urls.chat,"/search")),data:t};return this.proxy.ajax(n)}},{key:"_onMessage",value:function(e){var t,n,r,i=a.getElementTreePath(e,["sent","forwarded","message"])||e,o=a.getAttr(i,"from"),c=a.getAttr(i,"type"),u=a.getAttr(i,"id"),l=a.getElement(i,"markable"),d=a.getElement(i,"received"),f=a.getElement(i,"displayed"),h=a.getElement(i,"composing"),p=a.getElement(i,"paused"),m=a.getElement(i,"invite"),g=a.getElement(i,"delay"),v=a.getElement(i,"extraParams"),y=a.getElementText(i,"body"),b=a.getElement(i,"forwarded"),w=b?a.getElement(b,"message"):null;n=(r=w?a.getAttr(w,"to"):null)?this.helpers.getUserIdFromJID(r):null;var S="groupchat"===c?this.helpers.getDialogIdFromJID(o):null,C="groupchat"===c?this.helpers.getIdFromResource(o):this.helpers.getUserIdFromJID(o),k=d||f||null;if(m)return!0;if(v&&(t=a.parseExtraParams(v)).dialogId&&(S=t.dialogId),h||p)return"function"!=typeof this.onMessageTypingListener||"chat"!==c&&"groupchat"!==c&&g||s.safeCallbackCall(this.onMessageTypingListener,!!h,C,S),!0;if(k)d?"function"==typeof this.onDeliveredStatusListener&&"chat"===c&&s.safeCallbackCall(this.onDeliveredStatusListener,a.getAttr(d,"id"),S,C):"function"==typeof this.onReadStatusListener&&"chat"===c&&s.safeCallbackCall(this.onReadStatusListener,a.getAttr(f,"id"),S,C);else{if(l&&C!=this.helpers.getUserIdFromJID(this.helpers.userCurrentJid(this.xmppClient))){var x={messageId:u,userId:C,dialogId:S};this.sendDeliveredStatus(x)}var T={id:u,dialog_id:S,recipient_id:n,type:c,body:y,extension:t?t.extension:null,delay:g};l&&(T.markable=1),"function"!=typeof this.onMessageListener||"chat"!==c&&"groupchat"!==c||s.safeCallbackCall(this.onMessageListener,C,T)}}},{key:"_onPresence",value:function(e){var t,n,i,o=a.getAttr(e,"from"),c=a.getAttr(e,"id"),u=a.getAttr(e,"type"),l=this.helpers.getUserIdFromJID(this.helpers.userCurrentJid(this.xmppClient)),d=a.getElement(e,"x");if(d&&(t=a.getAttr(d,"xmlns"),(n=a.getElement(d,"status"))&&(i=a.getAttr(n,"code"))),t&&t.startsWith("http://jabber.org/protocol/muc")){if("error"===u)return void(c.endsWith(":join")&&"function"==typeof this.stanzasCallbacks[c]&&this.stanzasCallbacks[c](e));var f=this.helpers.getDialogIdFromJID(o),h=this.helpers.getUserIdFromRoomJid(o);if(n){if("301"==i){if("function"==typeof this.onKickOccupant){var p=a.getElement(a.getElement(d,"item"),"actor"),m=a.getAttr(p,"jid");s.safeCallbackCall(this.onKickOccupant,f,this.helpers.getUserIdFromJID(m))}return void delete this.muc.joinedRooms[this.helpers.getRoomJidFromRoomFullJid(o)]}if("unavailable"===u)return void(n&&"110"==i&&"function"==typeof this.stanzasCallbacks["muc:leave"]&&s.safeCallbackCall(this.stanzasCallbacks["muc:leave"],null));if(c.endsWith(":join")&&n&&"110"==i)return void("function"==typeof this.stanzasCallbacks[c]&&this.stanzasCallbacks[c](e))}else if(h!=l)return"unavailable"===u?void("function"==typeof this.onLeaveOccupant&&s.safeCallbackCall(this.onLeaveOccupant,f,parseInt(h))):void("function"==typeof this.onJoinOccupant&&s.safeCallbackCall(this.onJoinOccupant,f,parseInt(h)))}var g=this.helpers.getUserIdFromJID(o),v=this.contactList.contacts[g];if(u)switch(u){case"subscribe":v&&"to"===v.subscription?(v?v.ask=null:(r("contact"),v={ask:null}),v.subscription="both",this.contactList._sendSubscriptionPresence({jid:o,type:"subscribed"})):"function"==typeof this.onSubscribeListener&&s.safeCallbackCall(this.onSubscribeListener,g);break;case"subscribed":v&&"from"===v.subscription?(v?v.ask=null:(r("contact"),v={ask:null}),v.subscription="both"):(v?v.ask=null:(r("contact"),v={ask:null}),v.subscription="to","function"==typeof this.onConfirmSubscribeListener&&s.safeCallbackCall(this.onConfirmSubscribeListener,g));break;case"unsubscribed":v?v.ask=null:(r("contact"),v={ask:null}),v.subscription="none","function"==typeof this.onRejectSubscribeListener&&s.safeCallbackCall(this.onRejectSubscribeListener,g);break;case"unsubscribe":v?v.ask=null:(r("contact"),v={ask:null}),v.subscription="to";break;case"unavailable":"function"==typeof this.onContactListListener&&v&&"none"!==v.subscription&&s.safeCallbackCall(this.onContactListListener,g,u),g===l&&this.xmppClient.send(a.createPresenceStanza())}else"function"==typeof this.onContactListListener&&v&&"none"!==v.subscription&&s.safeCallbackCall(this.onContactListListener,g)}},{key:"_onIQ",value:function(e){var t=a.getAttr(e,"id");this.stanzasCallbacks[t]&&(s.safeCallbackCall(this.stanzasCallbacks[t],e),delete this.stanzasCallbacks[t])}},{key:"_onSystemMessageListener",value:function(e){var t=a.getElementTreePath(e,["sent","forwarded","message"])||e,n=a.getAttr(t,"from"),r=a.getAttr(t,"id"),i=a.getElement(t,"extraParams"),o=this.helpers.getUserIdFromJID(n),c=a.getElement(t,"delay"),u=a.getElementText(i,"moduleIdentifier"),l=a.getElementText(t,"body"),d=a.parseExtraParams(i);if("SystemNotifications"===u&&"function"==typeof this.onSystemMessageListener){var f={id:r,userId:o,body:l,extension:d.extension};s.safeCallbackCall(this.onSystemMessageListener,f)}else this.webrtcSignalingProcessor&&!c&&"WebRTCVideoChat"===u&&this.webrtcSignalingProcessor._onMessage(o,i)}},{key:"_onMessageErrorListener",value:function(e){var t=a.getAttr(e,"id"),n=a.buildErrorFromXMPPErrorStanza(e);"function"==typeof this.onMessageErrorListener&&s.safeCallbackCall(this.onMessageErrorListener,t,n)}},{key:"_postConnectActions",value:function(e){s.DLog("[Chat]","CONNECTED");var t=a.createPresenceStanza();o.chat.streamManagement.enable&&2===o.chatProtocol.active&&(this.streamManagement.enable(this.xmppClient),this.streamManagement.sentMessageCallback=this._sentMessageCallback),this.helpers.setUserCurrentJid(this.helpers.userCurrentJid(this.xmppClient)),this.isConnected=!0,this._isConnecting=!1,this._enableCarbons(),this.xmppClient.send(t),e||"function"==typeof this.onReconnectListener&&s.safeCallbackCall(this.onReconnectListener)}},{key:"_establishConnection",value:function(e){var t=this;if(!this._isLogout&&!this._checkConnectionTimer){var n=function(){t.isConnected||t._isConnecting?(clearInterval(t._checkConnectionTimer),t._checkConnectionTimer=void 0):t.connect(e)};n(),this._checkConnectionTimer=setInterval((function(){n()}),1e3*o.chat.reconnectionTimeInterval)}}},{key:"_enableCarbons",value:function(){var e={type:"set",from:this.helpers.getUserCurrentJid(),id:a.getUniqueId("enableCarbons")},t=a.createIqStanza(e);t.c("enable",{xmlns:"urn:xmpp:carbons:2"}),this.xmppClient.send(t)}},{key:"_setSubscriptionToUserLastActivity",value:function(e,t){var n={id:this.helpers.getUniqueId("statusStreaming"),type:"set"},r=a.createIqStanza(n);r.c("subscribe",{xmlns:"https://connectycube.com/protocol/status_streaming",user_jid:this.helpers.jidOrUserId(e),enable:t}),this.xmppClient.send(r)}},{key:"subscribeToUserLastActivityStatus",value:function(e){this._setSubscriptionToUserLastActivity(e,!0)}},{key:"unsubscribeFromUserLastActivityStatus",value:function(e){this._setSubscriptionToUserLastActivity(e,!1)}}])&&i(t.prototype,n),p&&i(t,p),e}();e.exports=p},function(e,t,n){function r(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var i=n(0),o=n(1),s=n(5),a=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this._userCurrentJid=null}var t,n,a;return t=e,(n=[{key:"getUniqueId",value:function(e){return s.getUniqueId(e)}},{key:"jidOrUserId",value:function(e){return"string"==typeof e&&e.includes("@")?e:e+"-"+o.creds.appId+"@"+o.endpoints.chat}},{key:"typeChat",value:function(e){var t;if("string"==typeof e)t=e.indexOf("muc")>-1?"groupchat":"chat";else{if("number"!=typeof e)throw new Error("Unsupported chat type");t="chat"}return t}},{key:"getUserJid",value:function(e,t){return t?e+"-"+t+"@"+o.endpoints.chat:e+"-"+o.creds.appId+"@"+o.endpoints.chat}},{key:"getUserNickWithMucDomain",value:function(e){return o.endpoints.muc+"/"+e}},{key:"getUserIdFromJID",value:function(e){return e.indexOf("@")<0?null:parseInt(e.split("@")[0].split("-")[0])}},{key:"getDialogIdFromJID",value:function(e){return e.indexOf("@")<0?null:e.split("@")[0].split("_")[1]}},{key:"getRoomJidFromDialogId",value:function(e){return o.creds.appId+"_"+e+"@"+o.endpoints.muc}},{key:"getRoomJid",value:function(e){return e+"/"+this.getUserIdFromJID(this._userCurrentJid)}},{key:"getIdFromResource",value:function(e){var t=e.split("/");return t.length<2?null:(t.splice(0,1),parseInt(t.join("/")))}},{key:"getRoomJidFromRoomFullJid",value:function(e){var t=e.split("/");return t.length<2?null:t[0]}},{key:"getBsonObjectId",value:function(){return i.getBsonObjectId()}},{key:"getUserIdFromRoomJid",value:function(e){var t=e.toString().split("/");return 0===t.length?null:t[t.length-1]}},{key:"userCurrentJid",value:function(e){return e.jid._local+"@"+e.jid._domain+"/"+e.jid._resource}},{key:"getUserCurrentJid",value:function(){return this._userCurrentJid}},{key:"setUserCurrentJid",value:function(e){this._userCurrentJid=e}},{key:"getDialogJid",value:function(e){return e.indexOf("@")>0?e:this.getRoomJidFromDialogId(e)}}])&&r(t.prototype,n),a&&r(t,a),e}();e.exports=a},function(e,t,n){function r(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var i=n(0),o=n(5),s=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this._NS="urn:xmpp:sm:3",this._isStreamManagementEnabled=!1,this._clientProcessedStanzasCounter=0,this._clientSentStanzasCounter=0,this.sentMessageCallback=null,this._lastAck=0,this._xmppClient=null,this._originalSend=null,this._unackedQueue=[]}var t,n,s;return t=e,(n=[{key:"enable",value:function(e){var t={xmlns:this._NS};this._isStreamManagementEnabled||(this._xmppClient=e,this._originalSend=this._xmppClient.send,this._xmppClient.send=this.send.bind(this)),this._clientProcessedStanzasCounter=0,this._clientSentStanzasCounter=0,this._lastAck=0,this._addEnableHandlers();var n=o.createNonza("enable",t);this._xmppClient.send(n)}},{key:"_addEnableHandlers",value:function(){this._xmppClient.on("element",function(e){var t=e.name||e.tagName||e.nodeTree.tagName;if("enabled"!==t)if(o.getAttr(e,"xmlns")!==this._NS&&this._increaseReceivedStanzasCounter(),"r"!==t){if("a"===t){var n=parseInt(o.getAttr(e,"h"));this._checkCounterOnIncomeStanza(n)}}else{var r={xmlns:this._NS,h:this._clientProcessedStanzasCounter},i=o.createNonza("a",r);this._originalSend.call(this._xmppClient,i)}else this._isStreamManagementEnabled=!0}.bind(this))}},{key:"send",value:function(e,t){var n=e.name||e.tagName||e.nodeTree.tagName,r=o.getAttr(e,"type"),i=o.getElementText(e,"body")||"",s=o.getAllElements(e,"attachment")||"";this._originalSend.call(this._xmppClient,e),"message"!==n||"chat"!==r&&"groupchat"!==r||!i&&!s.length||this._sendStanzasRequest({message:t,expect:this._clientSentStanzasCounter}),++this._clientSentStanzasCounter}},{key:"_sendStanzasRequest",value:function(e){if(this._isStreamManagementEnabled){this._unackedQueue.push(e);var t=o.createNonza("r",{xmlns:this._NS});this._originalSend.call(this._xmppClient,t)}}},{key:"getClientSentStanzasCounter",value:function(){return this._clientSentStanzasCounter}},{key:"_checkCounterOnIncomeStanza",value:function(e){var t=e-this._lastAck;i.DLog("[Chat][SM][_checkCounterOnIncomeStanza]",t,e,this._lastAck);for(var n=0;n<t&&this._unackedQueue.length>0;n++)this.sentMessageCallback(null,this._unackedQueue.shift().message);this._lastAck=e}},{key:"_increaseReceivedStanzasCounter",value:function(){++this._clientProcessedStanzasCounter}}])&&r(t.prototype,n),s&&r(t,s),e}();e.exports=s},function(e,t,n){function r(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var i=n(5),o=n(0),s=n(1),a=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.helpers=t.helpers,this.xmppClient=t.xmppClient,this.stanzasCallbacks=t.stanzasCallbacks,this.contacts={},this.xmlns="jabber:iq:roster"}var t,n,a;return t=e,(n=[{key:"get",value:function(){var e=this;return new Promise((function(t,n){var r=i.getUniqueId("getRoster"),o={},a=i.createIqStanza({type:"get",from:e.helpers.getUserCurrentJid(),id:r});a.c("query",{xmlns:e.xmlns}),e.stanzasCallbacks[r]=function(n){for(var r=n.getChild("query").children,a=0,c=r.length;a<c;a++){var u=e.helpers.getUserIdFromJID(i.getAttr(r[a],"jid")),l=i.getAttr(r[a],"ask"),d=i.getAttr(r[a],"subscription"),f=i.getAttr(r[a],"name"),h=u+"-"+s.creds.appId!==f;o[u]={subscription:d,ask:l||null,name:h?f:null}}t(o)},e.xmppClient.send(a)}))}},{key:"add",value:function(e){var t=this;return new Promise((function(n,r){var o=e.userId||e,s=t.helpers.jidOrUserId(o),a=i.getUniqueId("addContactInRoster"),c=i.createIqStanza({type:"set",from:t.helpers.getUserCurrentJid(),id:a});t.contacts[o]={subscription:"none",ask:"subscribe",name:e.name||null},c.c("query",{xmlns:t.xmlns}).c("item",{jid:s,name:e.name||null}),t.stanzasCallbacks[a]=function(){t._sendSubscriptionPresence({jid:s,type:"subscribe"}),n()},t.xmppClient.send(c)}))}},{key:"confirm",value:function(e){var t=this;return new Promise((function(n,r){var i=e.userId||e,o=t.helpers.jidOrUserId(i);t._sendSubscriptionPresence({jid:o,type:"subscribed"}),s.chat.contactList.subscriptionMode.mutual?t.add(e,(function(){n()})):n()}))}},{key:"reject",value:function(e){var t=this;return new Promise((function(n,r){var i=t.helpers.jidOrUserId(e);t.contacts[e]={subscription:"none",ask:null},t._sendSubscriptionPresence({jid:i,type:"unsubscribed"}),n()}))}},{key:"updateName",value:function(e){var t=this;return new Promise((function(n,r){var s=t.helpers.jidOrUserId(e.userId),a=i.getUniqueId("updateContactInRoster"),c=t.contacts[e.userId];if(o.isObject(c)){c.name=e.name||null;var u=i.createIqStanza({type:"set",from:t.helpers.getUserCurrentJid(),id:a});u.c("query",{xmlns:t.xmlns}).c("item",{jid:s,name:e.name||null}),t.stanzasCallbacks[a]=function(e){"result"===e.attrs.type?n():r(e)},t.xmppClient.send(u)}else r("No contact exists with provided user id")}))}},{key:"remove",value:function(e){var t=this;return new Promise((function(n,r){var o=t.helpers.jidOrUserId(e),s=i.getUniqueId("removeConactInRoster"),a=i.createIqStanza({type:"set",from:t.helpers.getUserCurrentJid(),id:s});a.c("query",{xmlns:t.xmlns}).c("item",{jid:o,subscription:"remove"}),t.stanzasCallbacks[s]=function(){delete t.contacts[e],n()},t.xmppClient.send(a)}))}},{key:"_sendSubscriptionPresence",value:function(e){var t={to:e.jid,type:e.type},n=i.createPresenceStanza(t);this.xmppClient.send(n)}}])&&r(t.prototype,n),a&&r(t,a),e}();e.exports=a},function(e,t,n){function r(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var i=n(5),o=n(0),s=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.helpers=t.helpers,this.xmppClient=t.xmppClient,this.stanzasCallbacks=t.stanzasCallbacks,this.xmlns="jabber:iq:privacy"}var t,n,s;return t=e,(n=[{key:"create",value:function(e){var t=this;return new Promise((function(n,r){for(var o,s,a,c,u,l,d={},f=e.items.length-1;f>=0;f--){var h=e.items[f];d[h.user_id]={action:h.action,mutualBlock:!0===h.mutualBlock}}l=Object.keys(d);var p={type:"set",from:t.helpers.getUserCurrentJid(),id:i.getUniqueId("edit")},m=i.createIqStanza(p);function g(e,t){return e.getChild("query").getChild("list").c("item",{type:"jid",value:t.jidOrMuc,action:t.userAction,order:t.order}).c("message",{}).up().c("presence-in",{}).up().c("presence-out",{}).up().c("iq",{}).up().up(),e}function v(e,t){return e.getChild("query").getChild("list").c("item",{type:"jid",value:t.jidOrMuc,action:t.userAction,order:t.order}).up(),e}m.c("query",{xmlns:t.xmlns}).c("list",{name:e.name});for(var y=0,b=0,w=l.length;y<w;y++,b+=2)u=d[o=l[y]].mutualBlock,c=d[o].action,s=t.helpers.jidOrUserId(parseInt(o,10)),a=t.helpers.getUserNickWithMucDomain(o),u&&"deny"===c?(m=v(m,{order:b+1,jidOrMuc:s,userAction:c}),m=v(m,{order:b+2,jidOrMuc:a,userAction:c}).up().up()):(m=g(m,{order:b+1,jidOrMuc:s,userAction:c}),m=g(m,{order:b+2,jidOrMuc:a,userAction:c}));t.stanzasCallbacks[p.id]=function(e){i.isErrorStanza(e)?r(i.buildErrorFromXMPPErrorStanza(e)):n()},t.xmppClient.send(m)}))}},{key:"getList",value:function(e){var t=this;return new Promise((function(n,r){var o,s,a,c=[],u={},l={type:"get",from:t.helpers.getUserCurrentJid(),id:i.getUniqueId("getlist")},d=i.createIqStanza(l);d.c("query",{xmlns:t.xmlns}).c("list",{name:e}),t.stanzasCallbacks[l.id]=function(e){var r=e.getChild("query");u=r?r.getChild("list"):null;for(var i=0,d=(o=u?u.getChildElements("item"):null).length;i<d;i+=2)s=o[i].attrs.value,a=t.helpers.getUserIdFromJID(s),c.push({user_id:a,action:o[i].attrs.action});u={name:u.attrs.name,items:c},n(u),delete t.stanzasCallbacks[l.id]},t.xmppClient.send(d)}))}},{key:"update",value:function(e){var t=this;return new Promise((function(n,r){t.getList(e.name).then((function(i){var s={items:o.mergeArrays(i.items,e.items),name:e.name};t.create(s).then((function(){n()})).catch((function(e){r(e)}))})).catch((function(e){r(e)}))}))}},{key:"getNames",value:function(){var e=this;return new Promise((function(t,n){var r={type:"get",from:e.helpers.getUserCurrentJid(),id:i.getUniqueId("getNames")},o=i.createIqStanza(r);o.c("query",{xmlns:e.xmlns}),e.stanzasCallbacks[o.attrs.id]=function(e){if(i.isErrorStanza(e))n(i.buildErrorFromXMPPErrorStanza(e));else{for(var r=e.getChild("query"),o=r.getChild("default"),s=r.getChild("active"),a=r.getChildElements("list"),c=o?o.attrs.name:null,u=s?s.attrs.name:null,l=[],d=0,f=a.length;d<f;d++)l.push(a[d].attrs.name);t({default:c,active:u,names:l})}},e.xmppClient.send(o)}))}},{key:"delete",value:function(e){var t=this;return new Promise((function(n,r){var o={from:t.xmppClient.jid||t.xmppClient.jid.user,type:"set",id:i.getUniqueId("remove")},s=i.createIqStanza(o);s.c("query",{xmlns:t.xmlns}).c("list",{name:e||""}),t.stanzasCallbacks[s.attrs.id]=function(e){i.isErrorStanza(e)?r(i.buildErrorFromXMPPErrorStanza(e)):n()},t.xmppClient.send(s)}))}},{key:"setAsDefault",value:function(e){var t=this;return new Promise((function(n,r){var o={from:t.xmppClient.jid||t.xmppClient.jid.user,type:"set",id:i.getUniqueId("default")},s=i.createIqStanza(o);s.c("query",{xmlns:t.xmlns}).c("default",e&&e.length>0?{name:e}:{}),t.stanzasCallbacks[s.attrs.id]=function(e){i.isErrorStanza(e)?r(i.buildErrorFromXMPPErrorStanza(e)):n()},t.xmppClient.send(s)}))}}])&&r(t.prototype,n),s&&r(t,s),e}();e.exports=s},function(e,t,n){function r(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var i=n(5),o=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.helpers=t.helpers,this.xmppClient=t.xmppClient,this.stanzasCallbacks=t.stanzasCallbacks,this.joinedRooms={},this.xmlns="http://jabber.org/protocol/muc"}var t,n,o;return t=e,(n=[{key:"join",value:function(e){var t=this;return new Promise((function(n,r){var o=i.getUniqueId("join"),s=t.helpers.getDialogJid(e),a={id:o,from:t.helpers.getUserCurrentJid(),to:t.helpers.getRoomJid(s)},c=i.createPresenceStanza(a);c.c("x",{xmlns:t.xmlns}).c("history",{maxstanzas:0}),t.stanzasCallbacks[o]=function(e){var a=i.getAttr(e,"from"),c=(t.helpers.getDialogIdFromJID(a),i.getElement(e,"x")),u=i.getAttr(c,"xmlns"),l=i.getElement(c,"status"),d=i.getAttr(l,"code");if(l&&"110"==d)t.joinedRooms[s]=!0,n();else{var f=i.getAttr(e,"type");if(f&&"error"===f&&u===t.xmlns&&o.endsWith(":join")){var h=i.getElement(e,"error"),p=i.getAttr(h,"code"),m=i.getElementText(h,"text");r({code:p||500,message:m||"Unknown issue"})}}},t.xmppClient.send(c)}))}},{key:"leave",value:function(e){var t=this;return new Promise((function(n,r){var o=t.helpers.getDialogJid(e),s={type:"unavailable",from:t.helpers.getUserCurrentJid(),to:t.helpers.getRoomJid(o)},a=i.createPresenceStanza(s);delete t.joinedRooms[o],t.stanzasCallbacks["muc:leave"]=function(e){n()},t.xmppClient.send(a)}))}},{key:"listOnlineUsers",value:function(e){var t=this;return new Promise((function(n,r){var o={type:"get",to:t.helpers.getDialogJid(e),from:t.helpers.getUserCurrentJid(),id:i.getUniqueId("muc_disco_items")},s=i.createIqStanza(o);s.c("query",{xmlns:"http://jabber.org/protocol/disco#items"}),t.stanzasCallbacks[o.id]=function(e){var r=e.attrs.id;if(t.stanzasCallbacks[r]){for(var i=e.getChild("query").getChildElements("item"),o=[],s=0,a=i.length;s<a;s++){var c=t.helpers.getUserIdFromRoomJid(i[s].attrs.jid);o.push(parseInt(c))}n(o)}},t.xmppClient.send(s)}))}}])&&r(t.prototype,n),o&&r(t,o),e}();e.exports=o},function(e,t,n){function r(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var i=n(1),o=n(0),s=i.urls.chat+"/Dialog",a=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.proxy=t}var t,n,i;return t=e,(n=[{key:"list",value:function(e){var t={type:"GET",url:o.getUrl(s),data:e};return this.proxy.ajax(t)}},{key:"create",value:function(e){e&&e.occupants_ids&&o.isArray(e.occupants_ids)&&(e.occupants_ids=e.occupants_ids.join(", "));var t={type:"POST",url:o.getUrl(s),data:e};return this.proxy.ajax(t)}},{key:"update",value:function(e,t){var n={type:"PUT",url:o.getUrl(s,e),data:t};return this.proxy.ajax(n)}},{key:"delete",value:function(e,t){var n={type:"DELETE",url:o.getUrl(s,e)};return("string"==typeof e||o.isArray(e)&&1===e.length)&&(n.dataType="text"),t&&(n.data=t),this.proxy.ajax(n)}},{key:"addAdmins",value:function(e,t){var n={push_all:{admins_ids:t}},r={type:"PUT",url:o.getUrl(s,e,"admins"),data:n};return this.proxy.ajax(r)}},{key:"removeAdmins",value:function(e,t){var n={pull_all:{admins_ids:t}},r={type:"PUT",url:o.getUrl(s,e,"admins"),data:n};return this.proxy.ajax(r)}},{key:"subscribeToPublic",value:function(e){var t={type:"POST",url:o.getUrl(s,e,"subscribe")};return this.proxy.ajax(t)}},{key:"unsubscribeFromPublic",value:function(e){var t={type:"DELETE",url:o.getUrl(s,e,"subscribe"),dataType:"text"};return this.proxy.ajax(t)}},{key:"updateNotificationsSettings",value:function(e,t){var n={enabled:t?1:0},r={type:"PUT",url:o.getUrl(s,e,"notifications"),data:n};return this.proxy.ajax(r)}},{key:"getNotificationsSettings",value:function(e){var t={type:"GET",url:o.getUrl(s,e,"notifications")};return this.proxy.ajax(t)}},{key:"getPublicOccupants",value:function(e,t){var n={type:"GET",url:o.getUrl(s,e,"occupants"),data:t};return this.proxy.ajax(n)}}])&&r(t.prototype,n),i&&r(t,i),e}();e.exports=a},function(e,t,n){function r(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var i=n(1),o=n(0),s=i.urls.chat+"/Message",a=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.proxy=t}var t,n,i;return t=e,(n=[{key:"list",value:function(e){var t={url:o.getUrl(s),data:e};return this.proxy.ajax(t)}},{key:"create",value:function(e){var t={url:o.getUrl(s),type:"POST",data:e};return this.proxy.ajax(t)}},{key:"update",value:function(e,t){var n={type:"PUT",dataType:"text",url:o.getUrl(s,e),data:t};return this.proxy.ajax(n)}},{key:"delete",value:function(e,t){var n={url:o.getUrl(s,e),type:"DELETE",dataType:"text"};return t&&(n.data=t),this.proxy.ajax(n)}},{key:"unreadCount",value:function(e){e&&e.chat_dialog_ids&&o.isArray(e.chat_dialog_ids)&&(e.chat_dialog_ids=e.chat_dialog_ids.join(", "));var t={url:o.getUrl(s+"/unread"),data:e};return this.proxy.ajax(t)}}])&&r(t.prototype,n),i&&r(t,i),e}();e.exports=a},function(e,t,n){function r(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var i=n(107),o=n(108),s=n(109),a=n(12),c=(n(26),n(4)),u=(c.SignalingConstants,n(4).SessionState),l=n(0),d=n(2).mediaDevices,f=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.connection=t,this.signalingProcessor=new o(this),this.signalingProvider=new s(t),this.SessionConnectionState=c.SessionConnectionState,this.PeerConnectionState=c.PeerConnectionState,this.CallType=c.CallType,this.sessions={},d&&(d.ondevicechange=this._onDevicesChangeListener.bind(this))}var t,n,f;return t=e,(n=[{key:"getMediaDevices",value:function(e){var t=[];return new Promise((function(n,r){d&&d.enumerateDevices?d.enumerateDevices().then((function(r){e?(r.forEach((function(n,r){n.kind===e&&t.push(n)})),n(t)):n(r)})):r("No 'enumerateDevices' API supported")}))}},{key:"createNewSession",value:function(e,t,n){var r=a.getUserIdFromJID(a.userCurrentJid(this.connection)),i=n&&n.bandwidth&&!isNaN(n.bandwidth)?+n.bandwidth:0;if(!e)throw new Error("Can't create a session without opponentsIDs.");return this._createAndStoreSession(null,r,e,t,i)}},{key:"_createAndStoreSession",value:function(e,t,n,r,o){var s=new i({sessionID:e,initiatorID:t,opIDs:n,callType:r,signalingProvider:this.signalingProvider,currentUserID:a.getUserIdFromJID(a.userCurrentJid(this.connection)),bandwidth:o});return s.onUserNotAnswerListener=this.onUserNotAnswerListener,s.onRemoteStreamListener=this.onRemoteStreamListener,s.onSessionConnectionStateChangedListener=this.onSessionConnectionStateChangedListener,s.onSessionCloseListener=this.onSessionCloseListener,s.onCallStatsReport=this.onCallStatsReport,this.sessions[s.ID]=s,s}},{key:"clearSession",value:function(e){delete this.sessions[e]}},{key:"_onCallListener",value:function(e,t,n){var r=n.userInfo||{};a.trace("onCall. UserID:"+e+". SessionID: "+t+". extension: ",r);var i=this.sessions[t],o=+r.bandwidth||0;i?i._processOnCall(e,n):((i=this._createAndStoreSession(t,n.callerID,n.opponentsIDs,n.callType,o))._processOnCall(e,n),l.safeCallbackCall(this.onCallListener,i,r))}},{key:"_onAcceptListener",value:function(e,t,n){var r=this.sessions[t],i=n.userInfo||{};a.trace("onAccept. UserID:"+e+". SessionID: "+t),!r||r.state!==u.ACTIVE&&r.state!==u.NEW?a.traceWarning("Ignore 'onAccept', there is no information about session "+t):(l.safeCallbackCall(this.onAcceptCallListener,r,e,i),r._processOnAccept(e,n))}},{key:"_onRejectListener",value:function(e,t,n){var r=this.sessions[t];if(a.trace("onReject. UserID:"+e+". SessionID: "+t),r){var i=n.userInfo||{};l.safeCallbackCall(this.onRejectCallListener,r,e,i),r._processOnReject(e,n)}else a.traceWarning("Ignore 'onReject', there is no information about session "+t)}},{key:"_onStopListener",value:function(e,t,n){a.trace("onStop. UserID:"+e+". SessionID: "+t);var r=this.sessions[t],i=n.userInfo||{};!r||r.state!==u.ACTIVE&&r.state!==u.NEW?(l.safeCallbackCall(this.onInvalidEventsListener,"onStop",r,e,i),a.traceWarning("Ignore 'onStop', there is no information about session "+t+" by some reason.")):(r._processOnStop(e,n),l.safeCallbackCall(this.onStopCallListener,r,e,i))}},{key:"_onIceCandidatesListener",value:function(e,t,n){var r=this.sessions[t];a.trace("onIceCandidates. UserID:"+e+". SessionID: "+t+". ICE candidates count: "+n.iceCandidates.length),r?r.state===u.ACTIVE?r._processOnIceCandidates(e,n):a.traceWarning("Ignore 'OnIceCandidates', the session ( "+t+" ) has invalid state."):a.traceWarning("Ignore 'OnIceCandidates', there is no information about session "+t)}},{key:"_onDevicesChangeListener",value:function(){l.safeCallbackCall(this.onDevicesChangeListener)}}])&&r(t.prototype,n),f&&r(t,f),e}();e.exports=f},function(e,t,n){function r(e){return(r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function i(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var o=n(1),s=n(26),a=n(0),c=n(12),u=n(4).SignalingConstants,l=n(4).SessionState,d=n(4).PeerConnectionState,f=n(2).mediaDevices,h=function(){function e(t){var n;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.ID=t.sessionID?t.sessionID:(n=(new Date).getTime(),"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){var t=(n+16*Math.random())%16|0;return n=Math.floor(n/16),("x"==e?t:3&t|8).toString(16)}))),this.state=l.NEW,this.initiatorID=parseInt(t.initiatorID),this.opponentsIDs=t.opIDs,this.callType=parseInt(t.callType),this.peerConnections={},this.localStream=null,this.mediaParams=null,this.signalingProvider=t.signalingProvider,this.currentUserID=t.currentUserID,this.bandwidth=t.bandwidth,this.answerTimer=null,this.startCallTime=0,this.acceptCallTime=0}var t,n,h;return t=e,(n=[{key:"getUserMedia",value:function(e){var t=this;return new Promise((function(n,r){f.getUserMedia({audio:e.audio||!1,video:e.video||!1}).then((function(r){t.localStream=r,t.mediaParams=e,e.elementId&&t.attachMediaStream(e.elementId,r,e.options),n(r)})).catch(r)}))}},{key:"connectionStateForUser",value:function(e){var t=this.peerConnections[e];return t?t.state:null}},{key:"attachMediaStream",value:function(e,t,n){var i=document.getElementById(e);if(!i)throw new Error("Unable to attach media stream, element "+e+" is undefined");"object"===r(i.srcObject)?i.srcObject=t:i.src=window.URL.createObjectURL(t),n&&n.muted&&(i.muted=!0),n&&n.mirror&&(i.style.webkitTransform="scaleX(-1)",i.style.transform="scaleX(-1)"),i.onloadedmetadata=function(e){i.play()}}},{key:"detachMediaStream",value:function(e){var t=document.getElementById(e);t&&(t.pause(),"object"===r(t.srcObject)?t.srcObject=null:t.src="")}},{key:"switchMediaTracks",value:function(e){var t=this;return new Promise((function(n,r){e&&e.audio&&("boolean"==typeof t.mediaParams.audio&&(t.mediaParams.audio={}),t.mediaParams.audio.deviceId=e.audio),e&&e.video&&("boolean"==typeof t.mediaParams.video&&(t.mediaParams.video={}),t.mediaParams.video.deviceId=e.video),t.localStream.getTracks().forEach((function(e){e.stop()})),f.getUserMedia({audio:t.mediaParams.audio||!1,video:t.mediaParams.video||!1}).then((function(e){t._replaceTracks(e),n(e)})).catch((function(e){r(e)}))}))}},{key:"_replaceTracks",value:function(e){var t=this,n=this.peerConnections,r=this.mediaParams.elementId,i=this.mediaParams.options,o=e.getTracks();if(a.getEnv().reactnative||this.detachMediaStream(r),o.forEach((function(e){t.localStream.addTrack(e)})),a.getEnv().reactnative||this.attachMediaStream(r,e,i),!a.getEnv().reactnative)for(var s in n)n[s].getSenders().map((function(e){e.replaceTrack(o.find((function(t){return t.kind===e.track.kind})))}))}},{key:"call",value:function(e){var t=this,n=p(e);c.trace("Call, extension: "+JSON.stringify(n.userInfo)),this.state=l.ACTIVE,this.opponentsIDs.forEach((function(e,r,i){t._callInternal(e,n,!0)}))}},{key:"_callInternal",value:function(e,t,n){var r=this,i=this._createPeer(e,"offer"),o=c.getVersionSafari();o&&o>=11?this.localStream.getTracks().forEach((function(e){i.addTrack(e,r.localStream)})):i.addLocalStream(this.localStream),this.peerConnections[e]=i,i.getAndSetLocalSessionDescription(this.callType).then((function(){c.trace("getAndSessionDescription success"),i._startDialingTimer(t,n)})).catch((function(e){c.trace("getAndSessionDescription error: "+e)}))}},{key:"accept",value:function(e){var t=this,n=p(e);if(c.trace("Accept, extension: "+JSON.stringify(n.userInfo)),this.state!==l.ACTIVE){if(this.state===l.CLOSED)return c.traceError("Can't accept, the session is already closed, return."),void this.stop({});this.state=l.ACTIVE,this.acceptCallTime=new Date,this._clearAnswerTimer(),this._acceptInternal(this.initiatorID,n);var r=this._uniqueOpponentsIDsWithoutInitiator();if(r.length>0){var i=(this.acceptCallTime-this.startCallTime)/1e3;this._startWaitingOfferOrAnswerTimer(i),r.forEach((function(e){t.currentUserID>e&&t._callInternal(e,{},!0)}))}}else c.traceError("Can't accept, the session is already active, return.")}},{key:"_acceptInternal",value:function(e,t){var n=this,r=this.peerConnections[e];if(r){var i=c.getVersionSafari();i&&i>=11?this.localStream.getTracks().forEach((function(e){r.addTrack(e,n.localStream)})):r.addLocalStream(this.localStream),r.setRemoteSessionDescription("offer",r.getRemoteSDP()).then((function(){c.trace("'setRemoteSessionDescription' success"),r.getAndSetLocalSessionDescription(n.callType).then((function(){t.sessionID=n.ID,t.callType=n.callType,t.callerID=n.initiatorID,t.opponentsIDs=n.opponentsIDs,t.sdp=r.localDescription.sdp,n.signalingProvider.sendMessage(e,t,u.SignalingType.ACCEPT)})).catch((function(e){c.trace("getAndSetLocalSessionDescription error: "+e)}))})).catch((function(e){c.traceError("'setRemoteSessionDescription' error: "+e)}))}else c.traceError("Can't accept the call, there is no information about peer connection by some reason.")}},{key:"reject",value:function(e){var t=this,n=p(e);c.trace("Reject, extension: "+JSON.stringify(n.userInfo)),this.state=l.REJECTED,this._clearAnswerTimer(),n.sessionID=this.ID,n.callType=this.callType,n.callerID=this.initiatorID,n.opponentsIDs=this.opponentsIDs,Object.keys(this.peerConnections).forEach((function(e){var r=t.peerConnections[e];t.signalingProvider.sendMessage(r.userID,n,u.SignalingType.REJECT)})),this._close()}},{key:"stop",value:function(e){var t=this,n=p(e);c.trace("Stop, extension: "+JSON.stringify(n.userInfo)),this.state=l.HUNGUP,this.answerTimer&&this._clearAnswerTimer(),n.sessionID=this.ID,n.callType=this.callType,n.callerID=this.initiatorID,n.opponentsIDs=this.opponentsIDs,Object.keys(this.peerConnections).forEach((function(e){var r=t.peerConnections[e];t.signalingProvider.sendMessage(r.userID,n,u.SignalingType.STOP)})),this._close()}},{key:"mute",value:function(e){this._muteStream(0,e)}},{key:"unmute",value:function(e){this._muteStream(1,e)}},{key:"_processOnCall",value:function(e,t){var n=this;this._uniqueOpponentsIDs().forEach((function(r){var i,o=n.peerConnections[r];o?r==e&&(o.updateRemoteSDP(t.sdp),e!=n.initiatorID&&n.state===l.ACTIVE&&n._acceptInternal(e,{})):(i=r!=e&&n.currentUserID>r?n._createPeer(r,"offer"):n._createPeer(r,"answer"),n.peerConnections[r]=i,r==e&&(i.updateRemoteSDP(t.sdp),n._startAnswerTimer()))}))}},{key:"_processOnAccept",value:function(e,t){var n=this.peerConnections[e];n?(n._clearDialingTimer(),n.setRemoteSessionDescription("answer",t.sdp).then((function(){c.trace("'setRemoteSessionDescription' success")})).catch((function(e){c.traceError("'setRemoteSessionDescription' error: "+e)}))):c.traceWarning("Ignore 'OnAccept', there is no information about peer connection by some reason.")}},{key:"_processOnReject",value:function(e,t){var n=this.peerConnections[e];this._clearWaitingOfferOrAnswerTimer(),n?n.release():c.traceWarning("Ignore 'OnReject', there is no information about peer connection by some reason."),this._closeSessionIfAllConnectionsClosed()}},{key:"_processOnStop",value:function(e,t){var n=this;if(this._clearAnswerTimer(),e===this.initiatorID){var r=Object.keys(this.peerConnections);r.length>0?r.forEach((function(e){n.peerConnections[e].release()})):c.traceWarning("Ignore 'OnStop', there is no information about peer connections by some reason.")}else{var i=this.peerConnections[e];i?i.release():c.traceWarning("Ignore 'OnStop', there is no information about peer connection by some reason.")}this._closeSessionIfAllConnectionsClosed()}},{key:"_processOnIceCandidates",value:function(e,t){var n=this.peerConnections[e];n?n.addCandidates(t.iceCandidates):c.traceWarning("Ignore 'OnIceCandidates', there is no information about peer connection by some reason.")}},{key:"_processCall",value:function(e,t){var n=t||{};n.sessionID=this.ID,n.callType=this.callType,n.callerID=this.initiatorID,n.opponentsIDs=this.opponentsIDs,n.sdp=e.localDescription.sdp,n.userInfo=t.userInfo||{},n.userInfo.bandwidth=this.bandwidth,this.signalingProvider.sendMessage(e.userID,n,u.SignalingType.CALL)}},{key:"_processIceCandidates",value:function(e,t){var n={};n.sessionID=this.ID,n.callType=this.callType,n.callerID=this.initiatorID,n.opponentsIDs=this.opponentsIDs,this.signalingProvider.sendCandidate(e.userID,t,n)}},{key:"_processOnNotAnswer",value:function(e){c.trace("Answer timeout callback for session "+this.ID+" for user "+e.userID),this._clearWaitingOfferOrAnswerTimer(),e.release(),a.safeCallbackCall(this.onUserNotAnswerListener,this,e.userID),this._closeSessionIfAllConnectionsClosed()}},{key:"_onRemoteStreamListener",value:function(e,t){a.safeCallbackCall(this.onRemoteStreamListener,this,e,t)}},{key:"_onCallStatsReport",value:function(e,t,n){a.safeCallbackCall(this.onCallStatsReport,this,e,t,n)}},{key:"_onSessionConnectionStateChangedListener",value:function(e,t){a.safeCallbackCall(this.onSessionConnectionStateChangedListener,this,e,t)}},{key:"_createPeer",value:function(e,t){this.startCallTime=new Date;var n={iceServers:m(o.videochat.iceServers)};c.trace("_createPeer, iceServers: "+JSON.stringify(n));var r=new s(n);return r._init(this,e,this.ID,t),r}},{key:"_close",value:function(){var e=this;c.trace("_close"),Object.keys(this.peerConnections).forEach((function(t){var n=e.peerConnections[t];try{n.release()}catch(e){console.warn("Peer close error:",e)}})),this._closeLocalMediaStream(),this.state=l.CLOSED,a.safeCallbackCall(this.onSessionCloseListener,this)}},{key:"_closeSessionIfAllConnectionsClosed",value:function(){var e=this,t=!0;Object.keys(this.peerConnections).forEach((function(n){var r,i=e.peerConnections[n];try{r="closed"===i.iceConnectionState?"closed":"closed"===i.signalingState?"closed":i.released?"closed":null}catch(e){c.traceError(e),r="closed"}"closed"!==r&&(t=!1)})),c.trace("All peer connections closed: "+t),t&&(this._closeLocalMediaStream(),a.safeCallbackCall(this.onSessionCloseListener,this),this.state=l.CLOSED)}},{key:"_closeLocalMediaStream",value:function(){this.localStream&&(this.localStream.getAudioTracks().forEach((function(e){e.stop()})),this.localStream.getVideoTracks().forEach((function(e){e.stop()})),this.localStream=null)}},{key:"_muteStream",value:function(e,t){"audio"===t&&this.localStream.getAudioTracks().length>0?this.localStream.getAudioTracks().forEach((function(t){t.enabled=!!e})):"video"===t&&this.localStream.getVideoTracks().length>0&&this.localStream.getVideoTracks().forEach((function(t){t.enabled=!!e}))}},{key:"_clearAnswerTimer",value:function(){this.answerTimer&&(c.trace("_clearAnswerTimer"),clearTimeout(this.answerTimer),this.answerTimer=null)}},{key:"_startAnswerTimer",value:function(){var e=this;c.trace("_startAnswerTimer");var t=1e3*o.videochat.answerTimeInterval;this.answerTimer=setTimeout((function(){c.trace("_answerTimeoutCallback"),"function"==typeof e.onSessionCloseListener&&e._close(),e.answerTimer=null}),t)}},{key:"_clearWaitingOfferOrAnswerTimer",value:function(){this.waitingOfferOrAnswerTimer&&(c.trace("_clearWaitingOfferOrAnswerTimer"),clearTimeout(this.waitingOfferOrAnswerTimer),this.waitingOfferOrAnswerTimer=null)}},{key:"_startWaitingOfferOrAnswerTimer",value:function(e){var t=this,n=o.videochat.answerTimeInterval-e<0?1:o.videochat.answerTimeInterval-e;c.trace("_startWaitingOfferOrAnswerTimer, timeout: "+n),this.waitingOfferOrAnswerTimer=setTimeout((function(){c.trace("waitingOfferOrAnswerTimeoutCallback"),Object.keys(t.peerConnections).forEach((function(e){var n=t.peerConnections[e];n.state!==d.CONNECTING&&n.state!==d.NEW||t._processOnNotAnswer(n)})),t.waitingOfferOrAnswerTimer=null}),1e3*n)}},{key:"_uniqueOpponentsIDs",value:function(){var e=this,t=[];return this.initiatorID!==this.currentUserID&&t.push(this.initiatorID),this.opponentsIDs.forEach((function(n){n!=e.currentUserID&&t.push(parseInt(n))})),t}},{key:"_uniqueOpponentsIDsWithoutInitiator",value:function(){var e=this,t=[];return this.opponentsIDs.forEach((function(n){n!=e.currentUserID&&t.push(parseInt(n))})),t}},{key:"toString",value:function(){return"ID: "+this.ID+", initiatorID:  "+this.initiatorID+", opponentsIDs: "+this.opponentsIDs+", state: "+this.state+", callType: "+this.callType}}])&&i(t.prototype,n),h&&i(t,h),e}();function p(e){var t={};try{if("[object Object]"!=={}.toString.call(e))throw new Error('Invalid type of "extension" object.');t.userInfo=e,t=JSON.parse(JSON.stringify(t).replace(/null/g,'""'))}catch(e){c.traceWarning(e.message)}return t}function m(e){var t=JSON.parse(JSON.stringify(e));return Object.keys(t).forEach((function(e,n,r){t[n].hasOwnProperty("url")?t[n].urls=t[n].url:t[n].url=t[n].urls})),t}e.exports=h},function(e,t,n){function r(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var i=n(4).SignalingConstants,o=n(5),s=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.delegate=t}var t,n,s;return t=e,(n=[{key:"_onMessage",value:function(e,t){var n=this._getExtension(t),r=n.sessionID,o=n.signalType;switch(delete n.moduleIdentifier,delete n.sessionID,delete n.signalType,o){case i.SignalingType.CALL:this.delegate._onCallListener(e,r,n);break;case i.SignalingType.ACCEPT:this.delegate._onAcceptListener(e,r,n);break;case i.SignalingType.REJECT:this.delegate._onRejectListener(e,r,n);break;case i.SignalingType.STOP:this.delegate._onStopListener(e,r,n);break;case i.SignalingType.CANDIDATE:this.delegate._onIceCandidatesListener(e,r,n)}}},{key:"_getExtension",value:function(e){if(!e)return null;for(var t,n,r,i={},s=[],a=[],c=e.childNodes||e.children,u=0,l=c.length;u<l;u++){var d=c[u].childNodes||c[u].children,f=c[u].tagName||c[u].name;if("iceCandidates"===f)for(var h=0,p=d.length;h<p;h++){t={};for(var m=0,g=(r=d[h].childNodes||d[h].children).length;m<g;m++){var v=r[m].tagName||r[m].name,y=r[m].textContent||r[m].children[0];t[v]="sdpMLineIndex"===v?parseInt(y):y}s.push(t)}else if("opponentsIDs"===f)for(var b=0,w=d.length;b<w;b++)n=d[b].textContent||d[b].children[0],a.push(parseInt(n));else if(d.length>1)if((c[u].textContent||c[u].children[0]).length>4096){for(var S="",C=0;C<d.length;++C)S+=d.textContent||d.children[0];i[f]=S}else i=o._XMLtoJS(i,f,c[u]);else"userInfo"===f?i=o._XMLtoJS(i,f,c[u]):i[f]=c[u].textContent||c[u].children[0]}return s.length>0&&(i.iceCandidates=s),a.length>0&&(i.opponentsIDs=a),i}}])&&r(t.prototype,n),s&&r(t,s),e}();e.exports=s},function(e,t,n){function r(e){return(r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function i(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var o=n(12),s=n(4).SignalingConstants,a=n(0),c=n(1),u=n(5),l=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.signalingConnection=t}var t,n,l;return t=e,(n=[{key:"sendCandidate",value:function(e,t,n){var r=n||{};r.iceCandidates=t,this.sendMessage(e,r,s.SignalingType.CANDIDATE)}},{key:"sendMessage",value:function(e,t,n){var i=t||{};i.moduleIdentifier=s.MODULE_ID,i.signalType=n,i.platform="web",i.userInfo&&!Object.keys(i.userInfo).length&&delete i.userInfo;var l={to:o.getUserJid(e,c.creds.appId),type:"headline",id:a.getBsonObjectId()},d=u.createMessageStanza(l).c("extraParams",{xmlns:"jabber:client"});Object.keys(i).forEach((function(e){"iceCandidates"===e?(d=d.c("iceCandidates"),i[e].forEach((function(e){d=d.c("iceCandidate"),Object.keys(e).forEach((function(t){d=d.c(t).t(e[t]).up()})),d=d.up()})),d=d.up()):"opponentsIDs"===e?(d=d.c("opponentsIDs"),i[e].forEach((function(e){d=d.c("opponentID").t(e).up()})),d=d.up()):"object"===r(i[e])?u._JStoXML(e,i[e],d):d=d.c(e).t(i[e]).up()})),d=d.up(),this.signalingConnection.send(d)}}])&&i(t.prototype,n),l&&i(t,l),e}();e.exports=l},function(e,t,n){var r=n(111),i=n(0),o=n(1),s=n(112).EventEmitter,a=n(2).mediaDevices;function c(e){if(!i.getEnv().reactnative&&!adapter)throw"Error: in order to use this library please connect adapter.js. More info https://github.com/webrtc/adapter";if(this.configs=e,!this.configs.server)throw"'server' parameter is mandatory.";this.configs.server.includes("http")&&(this.configs.server=this.configs.server+"/janus"),this.configs.debug||(this.configs.debug="all"),this.engine=null,this.videoRoomPlugin=null,this.isOnlyAudio=!1,this.currentDialogId=null,this.remoteFeeds=[],this.remoteJseps=[],this.remoteFeedsAttachingInProgress=[],this.currentMidiaDeviceId=null,this.bitrateTimers=[],this.emitter=new s}c.attachMediaStream=function(e,t){r.attachMediaStream(e,t)},c.listDevices=function(e){a.enumerateDevices().then((function(t){console.debug(t),e(t)})).catch((function(t){console.log("[VideoConferencingClient.listDevices][error]",t),e([])}))},c.listVideoinputDevices=function(e){c.listDevices((function(t){for(var n=[],r=0;r!==t.length;++r){var i=t[r];if("videoinput"===i.kind){var o=i.label||"camera "+(n.length+1),s=i.deviceId;n.push({label:o,deviceId:s})}}e(n)}))},c.prototype={createSession:function(e){var t=this;r.init({debug:this.configs.debug,callback:function(){r.isWebrtcSupported()?t.engine=new r({server:t.configs.server,iceServers:o.videochat.iceServers,success:function(){"function"==typeof e.success&&i.safeCallbackCall(e.success)},error:function(t){"function"==typeof e.error&&i.safeCallbackCall(e.error,t)},destroyed:function(){"function"==typeof e.destroyed&&i.safeCallbackCall(e.destroyed)},timeoutSessionCallback:function(){"function"==typeof e.timeoutSessionCallback&&i.safeCallbackCall(e.timeoutSessionCallback)}}):"function"==typeof e.error&&e.error("Your browser does not support WebRTC, so you can't use this functionality.")}})},getSessionId:function(){return this.engine?this.engine.getSessionId():null},destroySession:function(e){this.engine.destroy({}),"function"==typeof e.success&&i.safeCallbackCall(e.success)},attachVideoConferencingPlugin:function(e,t,n){var r=this,o=null;this.engine.attach({plugin:"janus.plugin.videoroom",success:function(s){if(e){(o=s).userId=t,r.remoteFeedsAttachingInProgress[t]=o;var a={request:"join",room:r.currentDialogId,ptype:"listener",feed:t};i.getEnv().reactnative||"safari"!==adapter.browserDetails.browser||(a.offer_video=!1),o.send({message:a})}else r.videoRoomPlugin=s;"function"==typeof n.success&&i.safeCallbackCall(n.success)},error:function(e){"function"==typeof n.error&&i.safeCallbackCall(n.error,e)},consentDialog:function(e){"function"==typeof n.consentDialog&&i.safeCallbackCall(n.consentDialog,e)},mediaState:function(e,t){"function"==typeof n.mediaState&&i.safeCallbackCall(n.mediaState,e,t)},webrtcState:function(e){"function"==typeof n.webrtcState&&i.safeCallbackCall(n.webrtcState,e)},slowLink:function(e,t){"function"==typeof n.slowLink&&i.safeCallbackCall(n.slowLink,e,t)},iceState:function(e){"function"==typeof n.iceState&&i.safeCallbackCall(n.iceState,e)},onmessage:function(t,o){var s=t.videoroom;if(e){if(s)if("attached"===s){var a=t.id;r.remoteFeeds[a]=r.remoteFeedsAttachingInProgress[a],r.remoteFeedsAttachingInProgress[a]=null}else t.error&&"function"==typeof n.error&&i.safeCallbackCall(n.error,t.error);if(o){a=t.id;r.remoteJseps[a]=o,r.createAnswer(r.remoteFeeds[a],o,{success:function(){},error:function(e){"function"==typeof n.error&&i.safeCallbackCall(n.error,e)}})}}else{if(s)if("joined"===s)r.createOffer({useAudio:!0,useVideo:!r.isOnlyAudio},{success:function(){if(t.publishers){var e=t.publishers;for(var n in e){var i=e[n].id,o=e[n].display;r.emitter.emit("participantjoined",i,o)}}},error:function(e){"function"==typeof n.error&&i.safeCallbackCall(n.error,e)}});else if("event"===s)if(t.publishers){var c=t.publishers;for(var u in c){var l=c[u].id,d=c[u].display;r.emitter.emit("participantjoined",l,d)}}else if(t.leaving){a=t.leaving;r.detachRemoteFeed(a)&&r.emitter.emit("participantleft",a,null)}else if(t.unpublished){if("ok"!=(a=t.unpublished))r.detachRemoteFeed(a)&&r.emitter.emit("participantleft",a,null)}else t.error&&"function"==typeof n.error&&i.safeCallbackCall(n.error,t.error);o&&r.videoRoomPlugin.handleRemoteJsep({jsep:o})}},onlocalstream:function(e){r.emitter.emit("localstream",e)},onremotestream:function(e){o.stream=e,r.emitter.emit("remotestream",e,o.userId)},oncleanup:function(){console.info("ON CLEANUP"),"function"==typeof n.oncleanup&&i.safeCallbackCall(n.oncleanup)},detached:function(){}})},getPluginId:function(){return this.videoRoomPlugin?this.videoRoomPlugin.getId():null},detachVideoConferencingPlugin:function(e){var t=this,n=function(){t.videoRoomPlugin=null,Object.keys(t.remoteFeeds).forEach((function(e){t.detachRemoteFeed(e)})),t.remoteFeeds=[],t.remoteJseps=[],t.currentMidiaDeviceId=null};this.videoRoomPlugin.detach({success:function(){n(),"function"==typeof e.success&&i.safeCallbackCall(e.success)},error:function(t){n(),"function"==typeof e.error&&i.safeCallbackCall(e.error,t)}})},join:function(e,t,n,r){var o=this;if("boolean"!=typeof n)throw"'isOnlyAudio' parameter can be of type 'boolean' only.";o.isOnlyAudio=n,i.getEnv().reactnative||"safari"!==adapter.browserDetails.browser||(o.isOnlyAudio=!0),console.info("isOnlyAudio: "+o.isOnlyAudio);var s={request:"join",room:e,ptype:"publisher",id:t};this.videoRoomPlugin.send({message:s,success:function(n){o.currentDialogId=e,o.currentUserId=t,"function"==typeof r.success&&i.safeCallbackCall(r.success)},error:function(e){"function"==typeof r.error&&i.safeCallbackCall(r.error,e)}})},leave:function(e){if(console.warn("leave"),this.engine.isConnected()){var t={request:"leave",room:this.currentDialogId,id:this.currentUserId};this.videoRoomPlugin&&this.videoRoomPlugin.send({message:t}),this.currentDialogId=null,this.currentUserId=null,console.warn("resp"),"function"==typeof e.success&&i.safeCallbackCall(e.success)}else"function"==typeof e.success&&i.safeCallbackCall(e.success)},listOnlineParticipants:function(e,t){var n={request:"listparticipants",room:e};this.videoRoomPlugin.send({message:n,success:function(e){var n=[];e&&(n=e.participants),"function"==typeof t.success&&i.safeCallbackCall(t.success,n)},error:function(e){"function"==typeof t.error&&i.safeCallbackCall(t.error,e)}})},toggleAudioMute:function(){return this.videoRoomPlugin.isAudioMuted()?this.videoRoomPlugin.unmuteAudio():this.videoRoomPlugin.muteAudio(),this.videoRoomPlugin.isAudioMuted()},isAudioMuted:function(){return this.videoRoomPlugin.isAudioMuted()},toggleRemoteAudioMute:function(e){var t=this.remoteFeeds[e];if(!t)return!1;var n=t.stream.getAudioTracks();if(n&&n.length>0){for(var r=0;r<n.length;++r)n[r].enabled=!n[r].enabled;return!n[0].enabled}return!1},isRemoteAudioMuted:function(e){var t=this.remoteFeeds[e];if(!t)return!1;var n=t.stream.getAudioTracks();return!!(n&&n.length>0)&&!n[0].enabled},toggleVideoMute:function(){return this.videoRoomPlugin.isVideoMuted()?this.videoRoomPlugin.unmuteVideo():this.videoRoomPlugin.muteVideo(),this.videoRoomPlugin.isVideoMuted()},isVideoMuted:function(){return this.videoRoomPlugin.isVideoMuted()},toggleRemoteVideoMute:function(e){var t=this.remoteFeeds[e];if(!t)return!1;var n=t.stream.getVideoTracks();if(n&&n.length>0){for(var r=0;r<n.length;++r)n[r].enabled=!n[r].enabled;return!n[0].enabled}return!1},isRemoteVideoMuted:function(e){var t=this.remoteFeeds[e];if(!t)return!1;var n=t.stream.getVideoTracks();return!!(n&&n.length>0)&&!n[0].enabled},switchVideoinput:function(e,t){if(this.videoRoomPlugin){if(this.isOnlyAudio)throw"Can't switch video input in audio only call.";this.currentMidiaDeviceId=null;var n=this;this.createOffer({video:{deviceId:e},replaceVideo:!0},{success:function(){console.info("switchVideoinput: success"),n.currentMidiaDeviceId=e,"function"==typeof t.success&&i.safeCallbackCall(t.success)},error:function(e){console.info("switchVideoinput: error",e),"function"==typeof t.error&&i.safeCallbackCall(t.error,e)}})}else"function"==typeof t.error&&i.safeCallbackCall(t.error,"No active stream")},iceRestart:function(e,t){if(t){console.info("Performing remote ICE restart for user: ",e);var n=this.remoteFeeds[e];if(!n)return void("function"==typeof t.error&&i.safeCallbackCall(t.error,"No such user feed"));n.send({message:{request:"configure",restart:!0}}),"function"==typeof t.success&&i.safeCallbackCall(t.success)}else console.info("Performing local ICE restart"),this.createOffer({iceRestart:!0},{success:function(){"function"==typeof e.success&&i.safeCallbackCall(e.success)},error:function(t){"function"==typeof e.error&&i.safeCallbackCall(e.error,t)}})},createOffer:function(e,t){console.log("createOffer, inputParams: ",e);var n,r=this,i=e.useAudio,o=e.useVideo,s=e.stream,a=e.replaceVideo,c=e.iceRestart,u=r.configs.video?r.configs.video.quality:null,l=r.configs.video?r.configs.video.frameRate:null;s?n={stream:s}:a?(n={media:e},u&&(n.media.video=u),l&&(n.media.videoFrameRate={min:l,max:l})):c?n=e:(n={media:{audioRecv:!1,videoRecv:!1,audioSend:i,videoSend:o}},u&&(n.media.video=u),l&&(n.media.videoFrameRate={min:l,ideal:l})),console.info("createOffer params: ",n),n.success=function(e){var n={request:"configure"};a||c||(n.audio=i,n.video=o),console.info("createOffer publish: ",n),r.videoRoomPlugin.send({message:n,jsep:e}),"function"==typeof t.success&&t.success()},n.error=function(e){console.log("[createOffer] Error in createOffer: ",e),i?r.createOffer({useAudio:!1,useVideo:!1},t):"function"==typeof t.error&&t.error(e)},this.videoRoomPlugin.createOffer(n)},createAnswer:function(e,t,n){var r=this;e.createAnswer({jsep:t,media:{audioSend:!1,videoSend:!1},success:function(t){var o={request:"start",room:r.currentDialogId};e.send({message:o,jsep:t}),"function"==typeof n.success&&i.safeCallbackCall(n.success)},error:function(e){console.log("[createAnswer] error: ",e),"function"==typeof n.error&&i.safeCallbackCall(n.error,e)}})},detachRemoteFeed:function(e){var t=this.remoteFeeds[e];return!!t&&(t.detach(),this.remoteFeeds[e]=null,this.remoteJseps[e]=null,!0)},showBitrate:function(e,t){var n=this.remoteFeeds[e];i.getEnv().reactnative||"chrome"!==adapter.browserDetails.browser&&"firefox"!==adapter.browserDetails.browser||(this.bitrateTimers[e]=setInterval((function(){var e=n.getBitrate();t.text(e)}),1e3))},hideBitrate:function(e,t){this.bitrateTimers[e]&&clearInterval(this.bitrateTimers[e]),this.bitrateTimers[e]=null,t.text=null},on:function(e,t){this.emitter.addListener(e,t)},removeAllListeners:function(e){e?this.emitter.removeAllListeners(e):this.emitter.removeAllListeners()}},e.exports={Client:c}},function(e,t,n){var r,i,o;function s(e){return(s="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}o=function(){function e(t){if(void 0===e.initDone)return t.error("Library not initialized"),{};if(!e.isWebrtcSupported())return t.error("WebRTC not supported by this browser"),{};if(e.log("Library initialized: "+e.initDone),(t=t||{}).success="function"==typeof t.success?t.success:e.noop,t.error="function"==typeof t.error?t.error:e.noop,t.destroyed="function"==typeof t.destroyed?t.destroyed:e.noop,null===t.server||void 0===t.server)return t.error("Invalid gateway url"),{};var n=!1,r=null,i={},o=null,a=null,c=0,u=t.server;e.isArray(u)?(e.log("Multiple servers provided ("+u.length+"), will use the first that works"),u=null,a=t.server,e.debug(a)):0===u.indexOf("ws")?(n=!0,e.log("Using WebSockets to contact Janus: "+u)):(n=!1,e.log("Using REST API to contact Janus: "+u));var l=t.iceServers;null==l&&(l=[{urls:"stun:stun.l.google.com:19302"}]);var d=t.iceTransportPolicy,f=t.bundlePolicy,h=t.ipv6;null==h&&(h=!1);var p=!1;void 0!==t.withCredentials&&null!==t.withCredentials&&(p=!0===t.withCredentials);var m=null;void 0!==t.max_poll_events&&null!==t.max_poll_events&&(m=t.max_poll_events),m<1&&(m=1);var g=null;void 0!==t.token&&null!==t.token&&(g=t.token);var v=null;void 0!==t.apisecret&&null!==t.apisecret&&(v=t.apisecret),this.destroyOnUnload=!0,void 0!==t.destroyOnUnload&&null!==t.destroyOnUnload&&(this.destroyOnUnload=!0===t.destroyOnUnload);var y=!1,b=null,w={},S=this,C=0,k={};function x(){if(null!=b)if(e.debug("Long poll..."),y){var n=u+"/"+b+"?rid="+(new Date).getTime();null!=m&&(n=n+"&maxev="+m),null!=g&&(n=n+"&token="+g),null!=v&&(n=n+"&apisecret="+v),e.httpAPICall(n,{verb:"GET",withCredentials:p,success:T,timeout:6e4,error:function(n,r){if(e.error(n+": "+r),++C>3)return y=!1,void t.error("Lost connection to the gateway (is it down?)");x()}})}else e.warn("Is the gateway down? (connected=false)")}function T(t,r){if(C=0,n||null==l||!0===r||setTimeout(x,200),n||!e.isArray(t))if("keepalive"!==t.janus)if("ack"!==t.janus)if("success"!==t.janus){if("webrtcup"===t.janus)return e.debug("Got a webrtcup event on session "+l),e.debug(t),null==(i=t.sender)?void e.warn("Missing sender..."):null==(s=w[i])?void e.debug("This handle is not attached to this session"):void s.webrtcState(!0);if("hangup"===t.janus){if(e.debug("Got a hangup event on session "+l),e.debug(t),null==(i=t.sender))return void e.warn("Missing sender...");if(null==(s=w[i]))return void e.debug("This handle is not attached to this session");s.webrtcState(!1,t.reason),s.hangup()}else if("detached"===t.janus){if(e.debug("Got a detached event on session "+l),e.debug(t),null==(i=t.sender))return void e.warn("Missing sender...");if(null==(s=w[i]))return;s.detached=!0,s.ondetached(),s.detach()}else if("media"===t.janus){if(e.debug("Got a media event on session "+l),e.debug(t),null==(i=t.sender))return void e.warn("Missing sender...");if(null==(s=w[i]))return void e.debug("This handle is not attached to this session");s.mediaState(t.type,t.receiving)}else if("slowlink"===t.janus){if(e.debug("Got a slowlink event on session "+l),e.debug(t),null==(i=t.sender))return void e.warn("Missing sender...");if(null==(s=w[i]))return void e.debug("This handle is not attached to this session");s.slowLink(t.uplink,t.nacks)}else{if("error"===t.janus)return e.error("Ooops: "+t.error.code+" "+t.error.reason),e.debug(t),void(null!=(f=t.transaction)&&(null!=(h=k[f])&&h(t),delete k[f]));if("event"===t.janus){var i;if(e.debug("Got a plugin event on session "+l),e.debug(t),null==(i=t.sender))return void e.warn("Missing sender...");var o=t.plugindata;if(null==o)return void e.warn("Missing plugindata...");e.debug("  -- Event is coming from "+i+" ("+o.plugin+")");var s,a=o.data;if(e.debug(a),null==(s=w[i]))return void e.warn("This handle is not attached to this session");var c=t.jsep;null!=c&&(e.debug("Handling SDP as well..."),e.debug(c));var u=s.onmessage;null!=u?(e.debug("Notifying application..."),u(a,c)):e.debug("No provided notification callback")}else if("timeout"===t.janus){var l=t.session_id,d=e.sessions[l];d&&d.timeoutSessionCallback()}else e.warn("Unkown message/event  '"+t.janus+"' on session "+l),e.debug(t)}}else{var f,h;e.debug("Got a success on session "+l),e.debug(t),null!=(f=t.transaction)&&(null!=(h=k[f])&&h(t),delete k[f])}else e.debug("Got an ack on session "+l),e.debug(t),null!=(f=t.transaction)&&(null!=(h=k[f])&&h(t),delete k[f]);else e.vdebug("Got a keepalive on session "+l);else for(var p=0;p<t.length;p++)T(t[p],!0)}function I(){if(null!==u&&n&&y){o=setTimeout(I,3e4);var t={janus:"keepalive",session_id:b,transaction:e.randomString(12)};null!=g&&(t.token=g),null!=v&&(t.apisecret=v),r.send(JSON.stringify(t))}}function _(t,i){if((i=i||{}).success="function"==typeof i.success?i.success:e.noop,i.error="function"==typeof i.error?i.error:e.noop,!y)return e.warn("Is the gateway down? (connected=false)"),void i.error("Is the gateway down? (connected=false)");var o=i.message,s=i.jsep,a=e.randomString(12),c={janus:"message",body:o,transaction:a};if(null!=g&&(c.token=g),null!=v&&(c.apisecret=v),null!=s&&(c.jsep=s),e.debug("Sending message to plugin (handle="+t+"):"),e.debug(c),n)return c.session_id=b,c.handle_id=t,k[a]=function(t){if(e.debug("Message sent!"),e.debug(t),"success"===t.janus){var n=t.plugindata;if(null==n)return e.warn("Request succeeded, but missing plugindata..."),void i.success();e.log("Synchronous transaction successful ("+n.plugin+")");var r=n.data;return e.debug(r),void i.success(r)}"ack"===t.janus?i.success():void 0!==t.error&&null!==t.error?(e.error("Ooops: "+t.error.code+" "+t.error.reason),i.error(t.error.code+" "+t.error.reason)):(e.error("Unknown error"),i.error("Unknown error"))},void r.send(JSON.stringify(c));e.httpAPICall(u+"/"+b+"/"+t,{verb:"POST",withCredentials:p,body:c,success:function(t){if(e.debug("Message sent!"),e.debug(t),"success"===t.janus){var n=t.plugindata;if(null==n)return e.warn("Request succeeded, but missing plugindata..."),void i.success();e.log("Synchronous transaction successful ("+n.plugin+")");var r=n.data;return e.debug(r),void i.success(r)}"ack"===t.janus?i.success():void 0!==t.error&&null!==t.error?(e.error("Ooops: "+t.error.code+" "+t.error.reason),i.error(t.error.code+" "+t.error.reason)):(e.error("Unknown error"),i.error("Unknown error"))},error:function(t,n){e.error(t+": "+n),i.error(t+": "+n)}})}function E(t,i){if(y){var o={janus:"trickle",candidate:i,transaction:e.randomString(12)};if(null!=g&&(o.token=g),null!=v&&(o.apisecret=v),e.vdebug("Sending trickle candidate (handle="+t+"):"),e.vdebug(o),n)return o.session_id=b,o.handle_id=t,void r.send(JSON.stringify(o));e.httpAPICall(u+"/"+b+"/"+t,{verb:"POST",withCredentials:p,body:o,success:function(t){e.vdebug("Candidate sent!"),e.vdebug(t),"ack"===t.janus||e.error("Ooops: "+t.error.code+" "+t.error.reason)},error:function(t,n){e.error(t+": "+n)}})}else e.warn("Is the gateway down? (connected=false)")}function A(t,n){(n=n||{}).success="function"==typeof n.success?n.success:e.noop,n.error="function"==typeof n.error?n.error:e.noop;var r=w[t];if(null==r||null===r.webrtcStuff||void 0===r.webrtcStuff)return e.warn("Invalid handle"),void n.error("Invalid handle");var i=r.webrtcStuff,o=n.text;if(null==o)return e.warn("Invalid text"),void n.error("Invalid text");e.log("Sending string on data channel: "+o),i.dataChannel.send(o),n.success()}function D(t,n){(n=n||{}).success="function"==typeof n.success?n.success:e.noop,n.error="function"==typeof n.error?n.error:e.noop;var r=w[t];if(null==r||null===r.webrtcStuff||void 0===r.webrtcStuff)return e.warn("Invalid handle"),void n.error("Invalid handle");var i=r.webrtcStuff;if(null===i.dtmfSender||void 0===i.dtmfSender){if(void 0!==i.myStream&&null!==i.myStream){var o=i.myStream.getAudioTracks();if(null!=o&&o.length>0){var s=o[0];i.dtmfSender=i.pc.createDTMFSender(s),e.log("Created DTMF Sender"),i.dtmfSender.ontonechange=function(t){e.debug("Sent DTMF tone: "+t.tone)}}}if(null===i.dtmfSender||void 0===i.dtmfSender)return e.warn("Invalid DTMF configuration"),void n.error("Invalid DTMF configuration")}var a=n.dtmf;if(null==a)return e.warn("Invalid DTMF parameters"),void n.error("Invalid DTMF parameters");var c=a.tones;if(null==c)return e.warn("Invalid DTMF string"),void n.error("Invalid DTMF string");var u=a.duration;null==u&&(u=500);var l=a.gap;null==l&&(l=50),e.debug("Sending DTMF string "+c+" (duration "+u+"ms, gap "+l+"ms)"),i.dtmfSender.insertDTMF(c,u,l)}function O(t,i){(i=i||{}).success="function"==typeof i.success?i.success:e.noop,i.error="function"==typeof i.error?i.error:e.noop;var o=!0;if(void 0!==i.asyncRequest&&null!==i.asyncRequest&&(o=!0===i.asyncRequest),e.log("Destroying handle "+t+" (async="+o+")"),z(t),w[t].detached)return delete w[t],void i.success();if(!y)return e.warn("Is the gateway down? (connected=false)"),void i.error("Is the gateway down? (connected=false)");var s={janus:"detach",transaction:e.randomString(12)};if(null!=g&&(s.token=g),null!=v&&(s.apisecret=v),n)return s.session_id=b,s.handle_id=t,r.send(JSON.stringify(s)),delete w[t],void i.success();e.httpAPICall(u+"/"+b+"/"+t,{verb:"POST",async:o,withCredentials:p,body:s,success:function(n){e.log("Destroyed handle:"),e.debug(n),"success"!==n.janus&&e.error("Ooops: "+n.error.code+" "+n.error.reason),delete w[t],i.success()},error:function(n,r){e.error(n+": "+r),delete w[t],i.success()}})}function P(t,n,r,i,o){console.warn("streamsDone",r);var a=w[t];if(null==a||null===a.webrtcStuff||void 0===a.webrtcStuff)return e.warn("Invalid handle"),void i.error("Invalid handle");var c=a.webrtcStuff;if(e.debug("streamsDone:",o),o&&(e.debug("  -- Audio tracks:",o.getAudioTracks()),e.debug("  -- Video tracks:",o.getVideoTracks())),r.update&&!c.streamExternal){if((r.removeAudio||r.replaceAudio)&&(c.myStream&&c.myStream.getAudioTracks()&&c.myStream.getAudioTracks().length&&(e.log("Removing audio track:",c.myStream.getAudioTracks()[0]),c.myStream.removeTrack(c.myStream.getAudioTracks()[0])),c.pc.getSenders()&&c.pc.getSenders().length))for(var u in c.pc.getSenders())(p=c.pc.getSenders()[u])&&p.track&&"audio"===p.track.kind&&(e.log("Removing audio sender:",p),c.pc.removeTrack(p));if((r.removeVideo||r.replaceVideo)&&(c.myStream&&c.myStream.getVideoTracks()&&c.myStream.getVideoTracks().length&&(e.log("Removing video track:",c.myStream.getVideoTracks()[0]),c.myStream.removeTrack(c.myStream.getVideoTracks()[0])),c.pc.getSenders()&&c.pc.getSenders().length))for(var u in c.pc.getSenders()){var p;(p=c.pc.getSenders()[u])&&p.track&&"video"===p.track.kind&&(e.log("Removing video sender:",p),c.pc.removeTrack(p))}}var m=!1;if(c.myStream&&r.update&&!c.streamExternal?((!r.update&&q(r)||r.update&&(r.addAudio||r.replaceAudio))&&o.getAudioTracks()&&o.getAudioTracks().length&&(e.log("Adding audio track:",o.getAudioTracks()[0]),c.myStream.addTrack(o.getAudioTracks()[0]),c.pc.addTrack(o.getAudioTracks()[0],o)),(!r.update&&B(r)||r.update&&(r.addVideo||r.replaceVideo))&&o.getVideoTracks()&&o.getVideoTracks().length&&(e.log("Adding video track:",o.getVideoTracks()[0]),c.myStream.addTrack(o.getVideoTracks()[0]),c.pc.addTrack(o.getVideoTracks()[0],o))):(c.myStream=o,m=!0),!c.pc){var g={iceServers:l,iceTransportPolicy:d,bundlePolicy:f},v={optional:[{DtlsSrtpKeyAgreement:!0}]};if(!0===h&&v.optional.push({googIPv6:!0}),i.rtcConstraints&&"object"===s(i.rtcConstraints))for(var y in e.debug("Adding custom PeerConnection constraints:",i.rtcConstraints),i.rtcConstraints)v.optional.push(i.rtcConstraints[y]);"edge"===e.webRTCAdapter.browserDetails.browser&&(g.bundlePolicy="max-bundle"),e.log("Creating PeerConnection"),e.debug(v),c.pc=new RTCPeerConnection(g,v),e.debug(c.pc),c.pc.getStats&&(c.volume.value=0,c.bitrate.value="0 kbits/sec"),e.log("Preparing local SDP and gathering candidates (trickle="+c.trickle+")"),c.pc.oniceconnectionstatechange=function(e){c.pc&&a.iceState(c.pc.iceConnectionState)},c.pc.onicecandidate=function(n){if(null==n.candidate||"edge"===e.webRTCAdapter.browserDetails.browser&&n.candidate.candidate.indexOf("endOfCandidates")>0)e.log("End of candidates."),c.iceDone=!0,!0===c.trickle?E(t,{completed:!0}):function(t,n){(n=n||{}).success="function"==typeof n.success?n.success:e.noop,n.error="function"==typeof n.error?n.error:e.noop;var r=w[t];if(null!=r&&null!==r.webrtcStuff&&void 0!==r.webrtcStuff){var i=r.webrtcStuff;e.log("Sending offer/answer SDP..."),null!==i.mySdp&&void 0!==i.mySdp?(i.mySdp={type:i.pc.localDescription.type,sdp:i.pc.localDescription.sdp},!1===i.trickle&&(i.mySdp.trickle=!1),e.debug(n),i.sdpSent=!0,n.success(i.mySdp)):e.warn("Local SDP instance is invalid, not sending anything...")}else e.warn("Invalid handle, not sending anything")}(t,i);else{var r={candidate:n.candidate.candidate,sdpMid:n.candidate.sdpMid,sdpMLineIndex:n.candidate.sdpMLineIndex};!0===c.trickle&&E(t,r)}},c.pc.ontrack=function(t){e.log("Handling Remote Track"),e.debug(t),t.streams&&(c.remoteStream=t.streams[0],a.onremotestream(c.remoteStream),t.track&&!t.track.onended&&(e.log("Adding onended callback to track:",t.track),t.track.onended=function(t){e.log("Remote track removed:",t),c.remoteStream&&(c.remoteStream.removeTrack(t.target),a.onremotestream(c.remoteStream))}))}}if(m&&null!=o&&(e.log("Adding local stream"),o.getTracks().forEach((function(e){c.pc.addTrack(e,o)}))),function(t){return e.debug("isDataEnabled:",t),"edge"==e.webRTCAdapter.browserDetails.browser?(e.warn("Edge doesn't support data channels yet"),!1):null!=t&&!0===t.data}(r)&&!c.dataChannel){e.log("Creating data channel");var b=function(){var t=null!==c.dataChannel?c.dataChannel.readyState:"null";e.log("State change on data channel: "+t),"open"===t&&a.ondataopen()};c.dataChannel=c.pc.createDataChannel("JanusDataChannel",{ordered:!1}),c.dataChannel.onmessage=function(t){e.log("Received message on data channel: "+t.data),a.ondata(t.data)},c.dataChannel.onopen=b,c.dataChannel.onclose=b,c.dataChannel.onerror=function(t){e.error("Got error on data channel:",t)}}c.myStream&&a.onlocalstream(c.myStream),null==n?function(t,n,r){console.warn("createOffer:",n),(r=r||{}).success="function"==typeof r.success?r.success:e.noop,r.error="function"==typeof r.error?r.error:e.noop;var i=w[t];if(null==i||null===i.webrtcStuff||void 0===i.webrtcStuff)return e.warn("Invalid handle"),void r.error("Invalid handle");var o=i.webrtcStuff,s=!0===r.simulcast;s?e.log("Creating offer (iceDone="+o.iceDone+", simulcast="+s+")"):e.log("Creating offer (iceDone="+o.iceDone+")");var a={offerToReceiveAudio:J(n),offerToReceiveVideo:V(n)};!0===r.iceRestart&&(a.iceRestart=!0),e.debug(a);var c=B(n);if(c&&s&&"firefox"===e.webRTCAdapter.browserDetails.browser){e.log("Enabling Simulcasting for Firefox (RID)");var u=o.pc.getSenders()[1];e.log(u);var l=u.getParameters();e.log(l),u.setParameters({encodings:[{rid:"high",active:!0,priority:"high",maxBitrate:1e6},{rid:"medium",active:!0,priority:"medium",maxBitrate:3e5},{rid:"low",active:!0,priority:"low",maxBitrate:1e5}]})}o.pc.createOffer((function(t){if(e.debug(t),e.log("Setting local description"),c&&s&&("chrome"===e.webRTCAdapter.browserDetails.browser?(e.log("Enabling Simulcasting for Chrome (SDP munging)"),t.sdp=function(t){for(var n=t.split("\r\n"),r=!1,i=[-1],o=-1,s=null,a=null,c=null,u=null,l=-1,d=0;d<n.length;d++)if(h=n[d].match(/m=(\w+) */)){if("video"===h[1]){if(!(i[0]<0)){l=d;break}r=!0}else if(i[0]>-1){l=d;break}}else if(r){var f=n[d].match(/a=ssrc-group:FID (\d+) (\d+)/);if(f)i[0]=f[1],o=f[2],n.splice(d,1),d--;else{if(i[0]){if((m=n[d].match("a=ssrc:"+i[0]+" cname:(.+)"))&&(s=m[1]),(m=n[d].match("a=ssrc:"+i[0]+" msid:(.+)"))&&(a=m[1]),(m=n[d].match("a=ssrc:"+i[0]+" mslabel:(.+)"))&&(c=m[1]),(m=n[d].match("a=ssrc:"+i+" label:(.+)"))&&(u=m[1]),0===n[d].indexOf("a=ssrc:"+o)){n.splice(d,1),d--;continue}if(0===n[d].indexOf("a=ssrc:"+i[0])){n.splice(d,1),d--;continue}}0!=n[d].length||(n.splice(d,1),d--)}}if(i[0]<0)for(l=-1,r=!1,d=0;d<n.length;d++){var h;if(h=n[d].match(/m=(\w+) */)){if("video"===h[1]){if(!(i[0]<0)){l=d;break}r=!0}else if(i[0]>-1){l=d;break}}else if(r){if(i[0]<0){var p=n[d].match(/a=ssrc:(\d+)/);if(p){i[0]=p[1],n.splice(d,1),d--;continue}}else{var m;if((m=n[d].match("a=ssrc:"+i[0]+" cname:(.+)"))&&(s=m[1]),(m=n[d].match("a=ssrc:"+i[0]+" msid:(.+)"))&&(a=m[1]),(m=n[d].match("a=ssrc:"+i[0]+" mslabel:(.+)"))&&(c=m[1]),(m=n[d].match("a=ssrc:"+i+" label:(.+)"))&&(u=m[1]),0===n[d].indexOf("a=ssrc:"+o)){n.splice(d,1),d--;continue}if(0===n[d].indexOf("a=ssrc:"+i[0])){n.splice(d,1),d--;continue}}0!=n[d].length||(n.splice(d,1),d--)}}if(i[0]<0)return e.warn("Couldn't find the video SSRC, simulcasting NOT enabled"),t;for(l<0&&(l=n.length),i[1]=Math.floor(4294967295*Math.random()),i[2]=Math.floor(4294967295*Math.random()),d=0;d<i.length;d++)s&&(n.splice(l,0,"a=ssrc:"+i[d]+" cname:"+s),l++),a&&(n.splice(l,0,"a=ssrc:"+i[d]+" msid:"+a),l++),c&&(n.splice(l,0,"a=ssrc:"+i[d]+" mslabel:"+a),l++),u&&(n.splice(l,0,"a=ssrc:"+i[d]+" label:"+a),l++);return n.splice(l,0,"a=ssrc-group:SIM "+i[0]+" "+i[1]+" "+i[2]),(t=n.join("\r\n")).endsWith("\r\n")||(t+="\r\n"),t}(t.sdp)):"firefox"!==e.webRTCAdapter.browserDetails.browser&&e.warn("simulcast=true, but this is not Chrome nor Firefox, ignoring")),o.mySdp=t.sdp,o.pc.setLocalDescription(t),o.mediaConstraints=a,o.iceDone||o.trickle){e.log("Offer ready"),e.debug(r);var n={type:t.type,sdp:t.sdp};r.success(n)}else e.log("Waiting for all candidates...")}),r.error,a)}(t,r,i):c.pc.setRemoteDescription(new RTCSessionDescription(n),(function(){e.log("Remote description accepted!"),function(t,n,r){(r=r||{}).success="function"==typeof r.success?r.success:e.noop,r.error="function"==typeof r.error?r.error:e.noop;var i=w[t];if(null==i||null===i.webrtcStuff||void 0===i.webrtcStuff)return e.warn("Invalid handle"),void r.error("Invalid handle");var o=i.webrtcStuff,s=!0===r.simulcast;s?e.log("Creating answer (iceDone="+o.iceDone+", simulcast="+s+")"):e.log("Creating answer (iceDone="+o.iceDone+")");var a=null;a="firefox"==e.webRTCAdapter.browserDetails.browser||"edge"==e.webRTCAdapter.browserDetails.browser?{offerToReceiveAudio:J(n),offerToReceiveVideo:V(n)}:{mandatory:{OfferToReceiveAudio:J(n),OfferToReceiveVideo:V(n)}},e.debug(a);var c=B(n);if(c&&s&&"firefox"===e.webRTCAdapter.browserDetails.browser){e.log("Enabling Simulcasting for Firefox (RID)");var u=o.pc.getSenders()[1];e.log(u);var l=u.getParameters();e.log(l),u.setParameters({encodings:[{rid:"high",active:!0,priority:"high",maxBitrate:1e6},{rid:"medium",active:!0,priority:"medium",maxBitrate:3e5},{rid:"low",active:!0,priority:"low",maxBitrate:1e5}]})}o.pc.createAnswer((function(t){if(e.debug(t),e.log("Setting local description"),c&&s&&("chrome"===e.webRTCAdapter.browserDetails.browser?e.warn("simulcast=true, but this is an answer, and video breaks in Chrome if we enable it"):"firefox"!==e.webRTCAdapter.browserDetails.browser&&e.warn("simulcast=true, but this is not Chrome nor Firefox, ignoring")),o.mySdp=t.sdp,o.pc.setLocalDescription(t),o.mediaConstraints=a,o.iceDone||o.trickle){var n={type:t.type,sdp:t.sdp};r.success(n)}else e.log("Waiting for all candidates...")}),r.error,a)}(t,r,i)}),i.error)}function j(t,n){(n=n||{}).success="function"==typeof n.success?n.success:e.noop,n.error="function"==typeof n.error?n.error:F;var r=n.jsep;n.media=n.media||{audio:!0,video:!0};var i=n.media,o=w[t];if(null==o||null===o.webrtcStuff||void 0===o.webrtcStuff)return e.warn("Invalid handle"),void n.error("Invalid handle");var a,c=o.webrtcStuff;if(void 0===c.pc||null===c.pc)i.update=!1;else if(void 0!==c.pc&&null!==c.pc)if(e.log("Updating existing media session"),i.update=!0,null!==n.stream&&void 0!==n.stream)n.stream!==c.myStream&&e.log("Renegotiation involves a new external stream");else{if(i.addAudio){if(i.replaceAudio=!1,i.removeAudio=!1,i.audioSend=!0,c.myStream&&c.myStream.getAudioTracks()&&c.myStream.getAudioTracks().length)return e.error("Can't add audio stream, there already is one"),void n.error("Can't add audio stream, there already is one")}else i.removeAudio?(i.replaceAudio=!1,i.addAudio=!1,i.audioSend=!1):i.replaceAudio&&(i.addAudio=!1,i.removeAudio=!1,i.audioSend=!0);if(null===c.myStream||void 0===c.myStream?(i.replaceAudio&&(i.replaceAudio=!1,i.addAudio=!0,i.audioSend=!0),q(i)&&(i.addAudio=!0)):null!==c.myStream.getAudioTracks()&&void 0!==c.myStream.getAudioTracks()&&0!==c.myStream.getAudioTracks().length||(i.replaceAudio&&(i.replaceAudio=!1,i.addAudio=!0,i.audioSend=!0),q(i)&&(i.addAudio=!0)),i.addVideo){if(i.replaceVideo=!1,i.removeVideo=!1,i.videoSend=!0,c.myStream&&c.myStream.getVideoTracks()&&c.myStream.getVideoTracks().length)return e.error("Can't add video stream, there already is one"),void n.error("Can't add video stream, there already is one")}else i.removeVideo?(i.replaceVideo=!1,i.addVideo=!1,i.videoSend=!1):i.replaceVideo&&(i.addVideo=!1,i.removeVideo=!1,i.videoSend=!0);null===c.myStream||void 0===c.myStream?(i.replaceVideo&&(i.replaceVideo=!1,i.addVideo=!0,i.videoSend=!0),B(i)&&(i.addVideo=!0)):null!==c.myStream.getVideoTracks()&&void 0!==c.myStream.getVideoTracks()&&0!==c.myStream.getVideoTracks().length||(i.replaceVideo&&(i.replaceVideo=!1,i.addVideo=!0,i.videoSend=!0),B(i)&&(i.addVideo=!0)),i.addData&&(i.data=!0)}if(c.trickle=(a=n.trickle,e.debug("isTrickleEnabled:",a),null==a||!0===a),null!==n.stream&&void 0!==n.stream){var u=n.stream;if(e.log("MediaStream provided by the application"),e.debug(u),i.update&&c.myStream&&c.myStream!==n.stream&&!c.streamExternal){try{var l=c.myStream.getTracks();for(var d in l){var f=l[d];e.log(f),null!=f&&f.stop()}}catch(e){}c.myStream=null}return c.streamExternal=!0,void P(t,r,i,n,u)}if(q(i)||B(i)){var h={mandatory:{},optional:[]};o.consentDialog(!0);var p=q(i);!0===p&&null!=i&&null!=i&&"object"===s(i.audio)&&(p=i.audio);var m=B(i);if(!0===m&&null!=i&&null!=i)if(!(!0===n.simulcast)||r||void 0!==i.video&&!1!==i.video||(i.video="hires"),i.video&&"screen"!=i.video&&"window"!=i.video)if("object"===s(i.video))m=i.video;else{var g=0,v=0;"lowres"===i.video?(v=240,g=320):"lowres-16:9"===i.video?(v=180,g=320):"hires"===i.video||"hires-16:9"===i.video||"hdres"===i.video?(v=720,g=1280):"fhdres"===i.video?(v=1080,g=1920):"4kres"===i.video?(v=2160,g=3840):"stdres"===i.video?(v=480,g=640):"stdres-16:9"===i.video?(v=360,g=640):(e.log("Default video setting is stdres 4:3"),v=480,g=640),e.log("Adding media constraint:",i.video),m={height:{ideal:v},width:{ideal:g}},i.videoFrameRate&&(m.frameRate=i.videoFrameRate),e.debug("Adding video constraint:",m)}else if("screen"===i.video||"window"===i.video){var y=function(e,s){o.consentDialog(!1),e?n.error({code:e.code,name:e.name,message:e.message}):P(t,r,i,n,s)},b=function(t,n,r){e.log("Adding media constraint (screen capture)"),e.debug(t),navigator.mediaDevices.getUserMedia(t).then((function(e){r?navigator.mediaDevices.getUserMedia({audio:!0,video:!1}).then((function(t){e.addTrack(t.getAudioTracks()[0]),n(null,e)})):n(null,e)})).catch((function(e){o.consentDialog(!1),n(e)}))};if(i.screenshareFrameRate||(i.screenshareFrameRate=3),"https:"!==window.location.protocol)return e.warn("Screen sharing only works on HTTPS, try the https:// version of this page"),o.consentDialog(!1),void n.error("Screen sharing only works on HTTPS, try the https:// version of this page");var S={};if("chrome"===e.webRTCAdapter.browserDetails.browser){var C=e.webRTCAdapter.browserDetails.version,k=33;if(window.navigator.userAgent.match("Linux")&&(k=35),C>=26&&C<=k)h={video:{mandatory:{googLeakyBucket:!0,maxWidth:window.screen.width,maxHeight:window.screen.height,minFrameRate:i.screenshareFrameRate,maxFrameRate:i.screenshareFrameRate,chromeMediaSource:"screen"}},audio:q(i)},b(h,y);else{var x=window.setTimeout((function(){return(T=new Error("NavigatorUserMediaError")).name='The required Chrome extension is not installed: click <a href="#">here</a> to install it. (NOTE: this will need you to refresh the page)',o.consentDialog(!1),n.error(T)}),1e3);S[x]=[y,null],window.postMessage({type:"janusGetScreen",id:x},"*")}}else if(window.navigator.userAgent.match("Firefox")){if(!(parseInt(window.navigator.userAgent.match(/Firefox\/(.*)/)[1],10)>=33)){var T=new Error("NavigatorUserMediaError");return T.name="Your version of Firefox does not support screen sharing, please install Firefox 33 (or more recent versions)",o.consentDialog(!1),void n.error(T)}h={video:{mozMediaSource:i.video,mediaSource:i.video},audio:q(i)},b(h,(function(e,t){if(y(e,t),!e)var n=t.currentTime,r=window.setInterval((function(){t||window.clearInterval(r),t.currentTime==n&&(window.clearInterval(r),t.onended&&t.onended()),n=t.currentTime}),500)}))}return void window.addEventListener("message",(function(e){if(e.origin==window.location.origin)if("janusGotScreen"==e.data.type&&S[e.data.id]){var t=S[e.data.id][0];if(delete S[e.data.id],""===e.data.sourceId){var r=new Error("NavigatorUserMediaError");r.name="You cancelled the request for permission, giving up...",o.consentDialog(!1),n.error(r)}else(h={audio:!1,video:{mandatory:{chromeMediaSource:"desktop",maxWidth:window.screen.width,maxHeight:window.screen.height,minFrameRate:i.screenshareFrameRate,maxFrameRate:i.screenshareFrameRate},optional:[{googLeakyBucket:!0},{googTemporalLayeredScreencast:!0}]}}).video.mandatory.chromeMediaSourceId=e.data.sourceId,b(h,t,q(i))}else"janusGetScreenPending"==e.data.type&&window.clearTimeout(e.data.id)}))}null!=i&&"screen"===i.video||navigator.mediaDevices.enumerateDevices().then((function(s){var a=s.some((function(e){return"audioinput"===e.kind})),c=s.some((function(e){return"videoinput"===e.kind})),u=q(i),l=B(i),d=function(t){return e.debug("isAudioSendRequired:",t),null!=t&&!1!==t.audio&&!1!==t.audioSend&&void 0!==t.failIfNoAudio&&null!==t.failIfNoAudio&&!0===t.failIfNoAudio}(i),f=function(t){return e.debug("isVideoSendRequired:",t),null!=t&&!1!==t.video&&!1!==t.videoSend&&void 0!==t.failIfNoVideo&&null!==t.failIfNoVideo&&!0===t.failIfNoVideo}(i);if(u||l||d||f){var h=!!u&&a,g=!!l&&c;if(!h&&!g)return o.consentDialog(!1),n.error("No capture device found"),!1;if(!h&&d)return o.consentDialog(!1),n.error("Audio capture is required, but no capture device found"),!1;if(!g&&f)return o.consentDialog(!1),n.error("Video capture is required, but no capture device found"),!1}navigator.mediaDevices.getUserMedia({audio:!!a&&p,video:!!c&&m}).then((function(s){var a=s.getVideoTracks()[0];a&&(e.debug("Video height: "+a.getSettings().height),e.debug("Video width: "+a.getSettings().width),e.debug("Video framerate: "+a.getSettings().frameRate)),o.consentDialog(!1),P(t,r,i,n,s)})).catch((function(e){o.consentDialog(!1),n.error({code:e.code,name:e.name,message:e.message})}))})).catch((function(e){o.consentDialog(!1),n.error("enumerateDevices error",e)}))}else P(t,r,i,n)}function R(t,n){(n=n||{}).success="function"==typeof n.success?n.success:e.noop,n.error="function"==typeof n.error?n.error:F;var r=n.jsep,i=w[t];if(null==i||null===i.webrtcStuff||void 0===i.webrtcStuff)return e.warn("Invalid handle"),void n.error("Invalid handle");var o=i.webrtcStuff;if(null!=r){if(null===o.pc)return e.warn("Wait, no PeerConnection?? if this is an answer, use createAnswer and not handleRemoteJsep"),void n.error("No PeerConnection: if this is an answer, use createAnswer and not handleRemoteJsep");o.pc.setRemoteDescription(new RTCSessionDescription(r),(function(){e.log("Remote description accepted!"),n.success()}),n.error)}else n.error("Invalid JSEP")}function L(t){var n=w[t];if(null==n||null===n.webrtcStuff||void 0===n.webrtcStuff)return e.warn("Invalid handle"),0;var r=n.webrtcStuff;return r.pc.getStats&&"chrome"==e.webRTCAdapter.browserDetails.browser?null===r.remoteStream||void 0===r.remoteStream?(e.warn("Remote stream unavailable"),0):null===r.volume.timer||void 0===r.volume.timer?(e.log("Starting volume monitor"),r.volume.timer=setInterval((function(){r.pc.getStats((function(e){for(var t=e.result(),n=0;n<t.length;n++){var i=t[n];"ssrc"==i.type&&i.stat("audioOutputLevel")&&(r.volume.value=i.stat("audioOutputLevel"))}}))}),200),0):r.volume.value:(e.log("Getting the remote volume unsupported by browser"),0)}function U(t,n){var r=w[t];if(null==r||null===r.webrtcStuff||void 0===r.webrtcStuff)return e.warn("Invalid handle"),!0;var i=r.webrtcStuff;return null===i.pc||void 0===i.pc?(e.warn("Invalid PeerConnection"),!0):void 0===i.myStream||null===i.myStream?(e.warn("Invalid local MediaStream"),!0):n?null===i.myStream.getVideoTracks()||void 0===i.myStream.getVideoTracks()||0===i.myStream.getVideoTracks().length?(e.warn("No video track"),!0):!i.myStream.getVideoTracks()[0].enabled:null===i.myStream.getAudioTracks()||void 0===i.myStream.getAudioTracks()||0===i.myStream.getAudioTracks().length?(e.warn("No audio track"),!0):!i.myStream.getAudioTracks()[0].enabled}function M(t,n,r){var i=w[t];if(null==i||null===i.webrtcStuff||void 0===i.webrtcStuff)return e.warn("Invalid handle"),!1;var o=i.webrtcStuff;return null===o.pc||void 0===o.pc?(e.warn("Invalid PeerConnection"),!1):void 0===o.myStream||null===o.myStream?(e.warn("Invalid local MediaStream"),!1):n?null===o.myStream.getVideoTracks()||void 0===o.myStream.getVideoTracks()||0===o.myStream.getVideoTracks().length?(e.warn("No video track"),!1):(o.myStream.getVideoTracks()[0].enabled=!r,!0):null===o.myStream.getAudioTracks()||void 0===o.myStream.getAudioTracks()||0===o.myStream.getAudioTracks().length?(e.warn("No audio track"),!1):(o.myStream.getAudioTracks()[0].enabled=!r,!0)}function N(t){var n=w[t];if(null==n||null===n.webrtcStuff||void 0===n.webrtcStuff)return e.warn("Invalid handle"),"Invalid handle";var r=n.webrtcStuff;return null===r.pc||void 0===r.pc?"Invalid PeerConnection":r.pc.getStats?null===r.bitrate.timer||void 0===r.bitrate.timer?(e.log("Starting bitrate timer (via getStats)"),r.bitrate.timer=setInterval((function(){r.pc.getStats().then((function(t){t.forEach((function(t){if(t){var n=!1;if(("video"===t.mediaType||t.id.toLowerCase().indexOf("video")>-1)&&"inbound-rtp"===t.type&&t.id.indexOf("rtcp")<0?n=!0:"ssrc"!=t.type||!t.bytesReceived||"VP8"!==t.googCodecName&&""!==t.googCodecName||(n=!0),n)if(r.bitrate.bsnow=t.bytesReceived,r.bitrate.tsnow=t.timestamp,null===r.bitrate.bsbefore||null===r.bitrate.tsbefore)r.bitrate.bsbefore=r.bitrate.bsnow,r.bitrate.tsbefore=r.bitrate.tsnow;else{var i=r.bitrate.tsnow-r.bitrate.tsbefore;"safari"==e.webRTCAdapter.browserDetails.browser&&(i/=1e3);var o=Math.round(8*(r.bitrate.bsnow-r.bitrate.bsbefore)/i);r.bitrate.value=o+" kbits/sec",r.bitrate.bsbefore=r.bitrate.bsnow,r.bitrate.tsbefore=r.bitrate.tsnow}}}))}))}),1e3),"0 kbits/sec"):r.bitrate.value:(e.warn("Getting the video bitrate unsupported by browser"),"Feature unsupported by browser")}function F(t){e.error("WebRTC error:",t)}function z(t,i){e.log("Cleaning WebRTC stuff");var o=w[t];if(null!=o){var s=o.webrtcStuff;if(null!=s){if(!0===i){var a={janus:"hangup",transaction:e.randomString(12)};null!=g&&(a.token=g),null!=v&&(a.apisecret=v),e.debug("Sending hangup request (handle="+t+"):"),e.debug(a),n?(a.session_id=b,a.handle_id=t,r.send(JSON.stringify(a))):e.httpAPICall(u+"/"+b+"/"+t,{verb:"POST",withCredentials:p,data:a})}s.remoteStream=null,s.volume.timer&&clearInterval(s.volume.timer),s.volume.value=null,s.bitrate.timer&&clearInterval(s.bitrate.timer),s.bitrate.timer=null,s.bitrate.bsnow=null,s.bitrate.bsbefore=null,s.bitrate.tsnow=null,s.bitrate.tsbefore=null,s.bitrate.value=null;try{if(!s.streamExternal&&null!==s.myStream&&void 0!==s.myStream){e.log("Stopping local stream tracks");var c=s.myStream.getTracks();for(var l in c){var d=c[l];e.log(d),null!=d&&d.stop()}}}catch(e){}s.streamExternal=!1,s.myStream=null;try{s.pc.close()}catch(e){}s.pc=null,s.mySdp=null,s.iceDone=!1,s.dataChannel=null,s.dtmfSender=null}o.oncleanup()}}function q(t){return e.debug("isAudioSendEnabled:",t),null==t||!1!==t.audio&&(void 0===t.audioSend||null===t.audioSend||!0===t.audioSend)}function J(t){return e.debug("isAudioRecvEnabled:",t),null==t||!1!==t.audio&&(void 0===t.audioRecv||null===t.audioRecv||!0===t.audioRecv)}function B(t){return e.debug("isVideoSendEnabled:",t),null==t||!1!==t.video&&(void 0===t.videoSend||null===t.videoSend||!0===t.videoSend)}function V(t){return e.debug("isVideoRecvEnabled:",t),null==t||!1!==t.video&&(void 0===t.videoRecv||null===t.videoRecv||!0===t.videoRecv)}!function s(l){var d=e.randomString(12),f={janus:"create",transaction:d};if(null!=g&&(f.token=g),null!=v&&(f.apisecret=v),null===u&&e.isArray(a)&&(0===(u=a[c]).indexOf("ws")?(n=!0,e.log("Server #"+(c+1)+": trying WebSockets to contact Janus ("+u+")")):(n=!1,e.log("Server #"+(c+1)+": trying REST API to contact Janus ("+u+")"))),n)for(var h in r=e.newWebSocket(u,"janus-protocol"),i={error:function(){if(console.warn("WS error"),e.error("Error connecting to the Janus WebSockets server... "+u),e.isArray(a))return++c==a.length?void l.error("Error connecting to any of the provided Janus servers: Is the gateway down?"):(u=null,void setTimeout((function(){s(l)}),200));l.error("Error connecting to the Janus WebSockets server: Is the gateway down?")},open:function(){console.warn("WS connected"),k[d]=function(t){if(e.debug(t),"success"!==t.janus)return e.error("Ooops: "+t.error.code+" "+t.error.reason),void l.error(t.error.reason);o=setTimeout(I,3e4),y=!0,b=t.data.id,e.log("Created session: "+b),e.sessions[b]=S,l.success()},r.send(JSON.stringify(f))},message:function(e){T(JSON.parse(e.data))},close:function(){null!==u&&y&&(y=!1,console.warn("WS close"),t.error("Lost connection to the gateway (is it down?)"))}})r.addEventListener(h,i[h]);else e.httpAPICall(u,{verb:"POST",withCredentials:p,body:f,success:function(t){if(e.debug(t),"success"!==t.janus)return e.error("Ooops: "+t.error.code+" "+t.error.reason),void l.error(t.error.reason);y=!0,b=t.data.id,e.log("Created session: "+b),e.sessions[b]=S,x(),l.success()},error:function(t,n){if(e.error(t+": "+n),e.isArray(a))return++c==a.length?void l.error("Error connecting to any of the provided Janus servers: Is the gateway down?"):(u=null,void setTimeout((function(){s(l)}),200));""===n?l.error(t+": Is the gateway down?"):l.error(t+": "+n)}})}(t),this.getServer=function(){return u},this.isConnected=function(){return y},this.getSessionId=function(){return b},this.destroy=function(s){!function(s){(s=s||{}).success="function"==typeof s.success?s.success:e.noop;var a=!0;if(void 0!==s.asyncRequest&&null!==s.asyncRequest&&(a=!0===s.asyncRequest),e.log("Destroying session "+b+" (async="+a+")"),!y)return e.warn("Is the gateway down? (connected=false)"),void s.success();if(null==b)return e.warn("No session to destroy"),s.success(),void t.destroyed();delete e.sessions[b];var c={janus:"destroy",transaction:e.randomString(12)};if(null!=g&&(c.token=g),null!=v&&(c.apisecret=v),n){c.session_id=b;var l=function(){for(var e in i)r.removeEventListener(e,i[e]);r.removeEventListener("message",d),r.removeEventListener("error",f),o&&clearTimeout(o),r.close()},d=function(e){var n=JSON.parse(e.data);n.session_id==c.session_id&&n.transaction==c.transaction&&(l(),s.success(),t.destroyed())},f=function(e){l(),s.error("Failed to destroy the gateway: Is the gateway down?"),t.destroyed()};return r.addEventListener("message",d),r.addEventListener("error",f),void r.send(JSON.stringify(c))}e.httpAPICall(u+"/"+b,{verb:"POST",async:a,withCredentials:p,body:c,success:function(n){e.log("Destroyed session:"),e.debug(n),b=null,y=!1,"success"!==n.janus&&e.error("Ooops: "+n.error.code+" "+n.error.reason),s.success(),t.destroyed()},error:function(n,r){e.error(n+": "+r),b=null,y=!1,s.success(),t.destroyed()}})}(s)},this.attach=function(t){!function(t){if((t=t||{}).success="function"==typeof t.success?t.success:e.noop,t.error="function"==typeof t.error?t.error:e.noop,t.consentDialog="function"==typeof t.consentDialog?t.consentDialog:e.noop,t.iceState="function"==typeof t.iceState?t.iceState:e.noop,t.mediaState="function"==typeof t.mediaState?t.mediaState:e.noop,t.webrtcState="function"==typeof t.webrtcState?t.webrtcState:e.noop,t.slowLink="function"==typeof t.slowLink?t.slowLink:e.noop,t.onmessage="function"==typeof t.onmessage?t.onmessage:e.noop,t.onlocalstream="function"==typeof t.onlocalstream?t.onlocalstream:e.noop,t.onremotestream="function"==typeof t.onremotestream?t.onremotestream:e.noop,t.ondata="function"==typeof t.ondata?t.ondata:e.noop,t.ondataopen="function"==typeof t.ondataopen?t.ondataopen:e.noop,t.oncleanup="function"==typeof t.oncleanup?t.oncleanup:e.noop,t.ondetached="function"==typeof t.ondetached?t.ondetached:e.noop,!y)return e.warn("Is the gateway down? (connected=false)"),void t.error("Is the gateway down? (connected=false)");var i=t.plugin;if(null==i)return e.error("Invalid plugin"),void t.error("Invalid plugin");var o=t.opaqueId,s=e.randomString(12),a={janus:"attach",plugin:i,opaque_id:o,transaction:s};if(null!=g&&(a.token=g),null!=v&&(a.apisecret=v),"chrome"!=e.webRTCAdapter.browserDetails.browser&&"firefox"!=e.webRTCAdapter.browserDetails.browser&&"safari"!=e.webRTCAdapter.browserDetails.browser||(a["force-bundle"]=!0,a["force-rtcp-mux"]=!0),n)return k[s]=function(n){if(e.debug(n),"success"!==n.janus)return e.error("Ooops: "+n.error.code+" "+n.error.reason),void t.error("Ooops: "+n.error.code+" "+n.error.reason);var r=n.data.id;e.log("Created handle: "+r);var o={session:S,plugin:i,id:r,detached:!1,webrtcStuff:{started:!1,myStream:null,streamExternal:!1,remoteStream:null,mySdp:null,mediaConstraints:null,pc:null,dataChannel:null,dtmfSender:null,trickle:!0,iceDone:!1,volume:{value:null,timer:null},bitrate:{value:null,bsnow:null,bsbefore:null,tsnow:null,tsbefore:null,timer:null}},getId:function(){return r},getPlugin:function(){return i},getVolume:function(){return L(r)},isAudioMuted:function(){return U(r,!1)},muteAudio:function(){return M(r,!1,!0)},unmuteAudio:function(){return M(r,!1,!1)},isVideoMuted:function(){return U(r,!0)},muteVideo:function(){return M(r,!0,!0)},unmuteVideo:function(){return M(r,!0,!1)},getBitrate:function(){return N(r)},send:function(e){_(r,e)},data:function(e){A(r,e)},dtmf:function(e){D(r,e)},consentDialog:t.consentDialog,iceState:t.iceState,mediaState:t.mediaState,webrtcState:t.webrtcState,slowLink:t.slowLink,onmessage:t.onmessage,createOffer:function(e){j(r,e)},createAnswer:function(e){j(r,e)},handleRemoteJsep:function(e){R(r,e)},onlocalstream:t.onlocalstream,onremotestream:t.onremotestream,ondata:t.ondata,ondataopen:t.ondataopen,oncleanup:t.oncleanup,ondetached:t.ondetached,hangup:function(e){z(r,!0===e)},detach:function(e){O(r,e)}};w[r]=o,t.success(o)},a.session_id=b,void r.send(JSON.stringify(a));e.httpAPICall(u+"/"+b,{verb:"POST",withCredentials:p,body:a,success:function(n){if(e.debug(n),"success"!==n.janus)return e.error("Ooops: "+n.error.code+" "+n.error.reason),void t.error("Ooops: "+n.error.code+" "+n.error.reason);var r=n.data.id;e.log("Created handle: "+r);var o={session:S,plugin:i,id:r,detached:!1,webrtcStuff:{started:!1,myStream:null,streamExternal:!1,remoteStream:null,mySdp:null,mediaConstraints:null,pc:null,dataChannel:null,dtmfSender:null,trickle:!0,iceDone:!1,volume:{value:null,timer:null},bitrate:{value:null,bsnow:null,bsbefore:null,tsnow:null,tsbefore:null,timer:null}},getId:function(){return r},getPlugin:function(){return i},getVolume:function(){return L(r)},isAudioMuted:function(){return U(r,!1)},muteAudio:function(){return M(r,!1,!0)},unmuteAudio:function(){return M(r,!1,!1)},isVideoMuted:function(){return U(r,!0)},muteVideo:function(){return M(r,!0,!0)},unmuteVideo:function(){return M(r,!0,!1)},getBitrate:function(){return N(r)},send:function(e){_(r,e)},data:function(e){A(r,e)},dtmf:function(e){D(r,e)},consentDialog:t.consentDialog,iceState:t.iceState,mediaState:t.mediaState,webrtcState:t.webrtcState,slowLink:t.slowLink,onmessage:t.onmessage,createOffer:function(e){j(r,e)},createAnswer:function(e){j(r,e)},handleRemoteJsep:function(e){R(r,e)},onlocalstream:t.onlocalstream,onremotestream:t.onremotestream,ondata:t.ondata,ondataopen:t.ondataopen,oncleanup:t.oncleanup,ondetached:t.ondetached,hangup:function(e){z(r,!0===e)},detach:function(e){O(r,e)}};w[r]=o,t.success(o)},error:function(t,n){e.error(t+": "+n)}})}(t)},this.timeoutSessionCallback="function"==typeof t.timeoutSessionCallback?t.timeoutSessionCallback:e.noop}return(e.sessions={},e.extensionId="hapfgfdkleiggjjpfpenajgdnfckjpaj",e.isExtensionEnabled=function(){if(window.navigator.userAgent.match("Chrome")){var t=parseInt(window.navigator.userAgent.match(/Chrome\/(.*) /)[1],10),n=33;return window.navigator.userAgent.match("Linux")&&(n=35),t>=26&&t<=n||e.checkJanusExtension()}return!0},e.useDefaultDependencies=function(t){var n=t&&t.fetch||fetch,r=t&&t.Promise||Promise,i=t&&t.WebSocket||WebSocket;return{newWebSocket:function(e,t){return new i(e,t)},isArray:function(e){return Array.isArray(e)},checkJanusExtension:function(){return null!==document.querySelector("#janus-extension-installed")},webRTCAdapter:t&&t.adapter||adapter,httpAPICall:function(t,i){var o={method:i.verb,cache:"no-cache"};void 0!==i.withCredentials&&(o.credentials=!0===i.withCredentials?"include":i.withCredentials?i.withCredentials:"omit"),void 0!==i.body&&(o.body=JSON.stringify(i.body));var a=n(t,o).catch((function(e){return r.reject({message:"Probably a network error, is the gateway down?",error:e})}));if(void 0!==i.timeout){var c=new r((function(e,t){var n=setTimeout((function(){return clearTimeout(n),t({message:"Request timed out",timeout:i.timeout})}),i.timeout)}));a=r.race([a,c])}return a.then((function(t){return t.ok?s(i.success)===s(e.noop)?t.json().then((function(e){i.success(e)})).catch((function(e){return r.reject({message:"Failed to parse response body",error:e,response:t})})):void 0:r.reject({message:"API call failed",response:t})})).catch((function(t){s(i.error)===s(e.noop)&&i.error(t.message||"<< internal error >>",t)})),a}}},e.useOldDependencies=function(t){var n=t&&t.jQuery||jQuery,r=t&&t.WebSocket||WebSocket;return{newWebSocket:function(e,t){return new r(e,t)},isArray:function(e){return n.isArray(e)},checkJanusExtension:function(){return n("#janus-extension-installed").length>0},webRTCAdapter:t&&t.adapter||adapter,httpAPICall:function(t,r){var i=void 0!==r.body?{contentType:"application/json",data:JSON.stringify(r.body)}:{},o=void 0!==r.withCredentials?{xhrFields:{withCredentials:r.withCredentials}}:{};return n.ajax(n.extend(i,o,{url:t,type:r.verb,cache:!1,dataType:"json",async:r.async,timeout:r.timeout,success:function(t){s(r.success)===s(e.noop)&&r.success(t)},error:function(t,n,i){s(r.error)===s(e.noop)&&r.error(n,i)}}))}}},e.noop=function(){},e.init=function(t){if((t=t||{}).callback="function"==typeof t.callback?t.callback:e.noop,!0===e.initDone)t.callback();else{if("undefined"!=typeof console&&void 0!==console.log||(console={log:function(){}}),e.trace=e.noop,e.debug=e.noop,e.vdebug=e.noop,e.log=e.noop,e.warn=e.noop,e.error=e.noop,!0===t.debug||"all"===t.debug)e.trace=console.trace.bind(console),e.debug=console.debug.bind(console),e.vdebug=console.debug.bind(console),e.log=console.log.bind(console),e.warn=console.warn.bind(console),e.error=console.error.bind(console);else if(Array.isArray(t.debug))for(var n in t.debug){var r=t.debug[n];switch(r){case"trace":e.trace=console.trace.bind(console);break;case"debug":e.debug=console.debug.bind(console);break;case"vdebug":e.vdebug=console.debug.bind(console);break;case"log":e.log=console.log.bind(console);break;case"warn":e.warn=console.warn.bind(console);break;case"error":e.error=console.error.bind(console);break;default:console.error("Unknown debugging option '"+r+"' (supported: 'trace', 'debug', 'vdebug', 'log', warn', 'error')")}}e.log("Initializing library");var i=t.dependencies||e.useDefaultDependencies();e.isArray=i.isArray,e.webRTCAdapter=i.webRTCAdapter,e.httpAPICall=i.httpAPICall,e.checkJanusExtension=i.checkJanusExtension,e.newWebSocket=i.newWebSocket,e.listDevices=function(t,n){t="function"==typeof t?t:e.noop,null==n&&(n={audio:!0,video:!0}),navigator.mediaDevices?navigator.mediaDevices.getUserMedia(n).then((function(n){navigator.mediaDevices.enumerateDevices().then((function(r){e.debug(r),t(r);try{var i=n.getTracks();for(var o in i){var s=i[o];null!=s&&s.stop()}}catch(e){}}))})).catch((function(n){e.error(n),t([])})):(e.warn("navigator.mediaDevices unavailable"),t([]))},e.attachMediaStream=function(t,n){"chrome"===e.webRTCAdapter.browserDetails.browser?e.webRTCAdapter.browserDetails.version>=43?t.srcObject=n:void 0!==t.src?t.src=URL.createObjectURL(n):e.error("Error attaching stream to element"):t.srcObject=n},e.reattachMediaStream=function(t,n){"chrome"===e.webRTCAdapter.browserDetails.browser?e.webRTCAdapter.browserDetails.version>=43?t.srcObject=n.srcObject:void 0!==t.src?t.src=n.src:e.error("Error reattaching stream to element"):t.srcObject=n.srcObject};var o=window.onbeforeunload;window.onbeforeunload=function(){for(var t in e.log("Closing window"),e.sessions)null!==e.sessions[t]&&void 0!==e.sessions[t]&&e.sessions[t].destroyOnUnload&&(e.log("Destroying session "+t),e.sessions[t].destroy({asyncRequest:!1}));o&&"function"==typeof o&&o()},e.initDone=!0,t.callback()}},e.isWebrtcSupported=function(){return void 0!==window.RTCPeerConnection&&null!==window.RTCPeerConnection&&void 0!==navigator.getUserMedia&&null!==navigator.getUserMedia},e.randomString=function(e){for(var t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",n="",r=0;r<e;r++){var i=Math.floor(Math.random()*t.length);n+=t.substring(i,i+1)}return n},e)},"object"===s(t)&&void 0!==e?e.exports=o():void 0===(i="function"==typeof(r=o)?r.call(t,n,t,e):r)||(e.exports=i)},function(e,t,n){var r={EventEmitter:n(113),EmitterSubscription:n(27)};e.exports=r},function(e,t,n){"use strict";var r=n(27),i=n(115),o=n(116),s=n(28),a=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this._subscriber=new i,this._currentSubscription=null}return e.prototype.addListener=function(e,t,n){return this._subscriber.addSubscription(e,new r(this._subscriber,t,n))},e.prototype.once=function(e,t,n){var r=this;return this.addListener(e,(function(){r.removeCurrentListener(),t.apply(n,arguments)}))},e.prototype.removeAllListeners=function(e){this._subscriber.removeAllSubscriptions(e)},e.prototype.removeCurrentListener=function(){this._currentSubscription||s(!1),this._subscriber.removeSubscription(this._currentSubscription)},e.prototype.listeners=function(e){var t=this._subscriber.getSubscriptionsForType(e);return t?t.filter(o.thatReturnsTrue).map((function(e){return e.listener})):[]},e.prototype.emit=function(e){var t=this._subscriber.getSubscriptionsForType(e);if(t){for(var n=Object.keys(t),r=0;r<n.length;r++){var i=n[r],o=t[i];o&&(this._currentSubscription=o,this.__emitToSubscription.apply(this,[o].concat(Array.prototype.slice.call(arguments))))}this._currentSubscription=null}},e.prototype.__emitToSubscription=function(e,t){var n=Array.prototype.slice.call(arguments,2);e.listener.apply(e.context,n)},e}();e.exports=a},function(e,t,n){"use strict";var r=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.subscriber=t}return e.prototype.remove=function(){this.subscriber&&(this.subscriber.removeSubscription(this),this.subscriber=null)},e}();e.exports=r},function(e,t,n){"use strict";var r=n(28),i=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this._subscriptionsForType={},this._currentSubscription=null}return e.prototype.addSubscription=function(e,t){t.subscriber!==this&&r(!1),this._subscriptionsForType[e]||(this._subscriptionsForType[e]=[]);var n=this._subscriptionsForType[e].length;return this._subscriptionsForType[e].push(t),t.eventType=e,t.key=n,t},e.prototype.removeAllSubscriptions=function(e){void 0===e?this._subscriptionsForType={}:delete this._subscriptionsForType[e]},e.prototype.removeSubscription=function(e){var t=e.eventType,n=e.key,r=this._subscriptionsForType[t];r&&delete r[n]},e.prototype.getSubscriptionsForType=function(e){return this._subscriptionsForType[e]},e}();e.exports=i},function(e,t,n){"use strict";function r(e){return function(){return e}}var i=function(){};i.thatReturns=r,i.thatReturnsFalse=r(!1),i.thatReturnsTrue=r(!0),i.thatReturnsNull=r(null),i.thatReturnsThis=function(){return this},i.thatReturnsArgument=function(e){return e},e.exports=i}])}));
//# sourceMappingURL=connectycube.min.map